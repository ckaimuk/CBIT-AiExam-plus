<!DOCTYPE html>
<html lang="zh-CN" id="htmlRoot">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="exam.title">è€ƒè¯•è¿›è¡Œä¸­ - IMBA æ™ºèƒ½è€ƒè¯•ç³»ç»Ÿ</title>
<link rel="icon" type="image/x-icon" id="faviconLink" href="/favicon.ico">
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<!-- CodeMirror for code editing -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/edit/closebrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/comment/comment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/addon/selection/active-line.min.js"></script>
<!-- MathJax for mathematical formula rendering -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  startup: {
    ready: () => {
      console.log('ğŸ§® MathJax is loaded and ready.');
      MathJax.startup.defaultReady();
    }
  }
};
</script>
<script async src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
tailwind.config = {
theme: {
extend: {
colors: {
primary: '#1A237E',
secondary: '#3F51B5'
},
borderRadius: {
'none': '0px',
'sm': '4px',
DEFAULT: '8px',
'md': '12px',
'lg': '16px',
'xl': '20px',
'2xl': '24px',
'3xl': '32px',
'full': '9999px',
'button': '8px'
}
}
}
}
</script>
<style>
:where([class^="ri-"])::before {
content: "\f3c2";
}
.exam-bg {
background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
}
.timer-warning {
animation: pulse 2s infinite;
}
@keyframes pulse {
0%, 100% { opacity: 1; }
50% { opacity: 0.5; }
}
.question-card {
transition: all 0.3s ease;
}
.question-card:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
.answer-input {
transition: all 0.3s ease;
}
.answer-input:focus {
box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
}
</style>
</head>
<body class="exam-bg min-h-screen">
<div class="min-h-screen flex flex-col">
<!-- Header -->
<div class="bg-white shadow-sm border-b sticky top-0 z-50">
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16">
<!-- Logo -->
<div class="flex items-center space-x-3">
<img id="systemLogo" src="https://static.readdy.ai/image/3c1ff9a008dc8b425236e4faed5d7924/c0ad19844b74c75ecb76a8cc5a6f9bd3.jfif" alt="IMBA Logo" class="w-8 h-8 object-contain">
<div id="systemName" class="font-bold text-lg text-primary" data-i18n="system.name">IMBA æ™ºèƒ½è€ƒè¯•</div>
</div>
<!-- Language Toggle -->
<button id="languageToggle" class="text-gray-600 hover:text-primary transition-colors px-3 py-2 rounded-lg border border-gray-200 mr-4">
<i class="ri-global-line mr-1"></i>
<span class="language-display">ä¸­</span>
</button>
<!-- Timer -->
<div class="flex items-center space-x-4">
<div class="text-sm text-gray-600" data-i18n="exam.time_remaining">å‰©ä½™æ—¶é—´</div>
<div id="timer" class="text-2xl font-bold text-primary timer-warning">75:00</div>
</div>
<!-- Progress -->
<div class="hidden md:flex items-center space-x-4">
<div class="text-sm text-gray-600" data-i18n="exam.progress">è¿›åº¦</div>
<div class="w-32 bg-gray-200 rounded-full h-2">
<div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
</div>
<div id="progressText" class="text-sm text-gray-600">0/20</div>
</div>
<!-- Exit Button -->
<button id="exitExam" class="bg-red-500 text-white px-4 py-2 rounded-button hover:bg-red-600 transition-colors">
<i class="ri-logout-box-line mr-1"></i><span data-i18n="exam.exit">é€€å‡ºè€ƒè¯•</span>
</button>
</div>
</div>
</div>
<!-- Main Content -->
<div class="flex-1 flex">
<!-- Sidebar -->
<div class="w-64 bg-white shadow-sm border-r hidden lg:block">
<div class="p-6">
<h3 class="font-semibold text-gray-900 mb-4" data-i18n="exam.question_navigation">é¢˜ç›®å¯¼èˆª</h3>
<div id="questionNav" class="space-y-2">
<!-- é¢˜ç›®å¯¼èˆªæŒ‰é’®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
</div>
</div>
</div>
<!-- Exam Content -->
<div class="flex-1 p-6">
<div class="max-w-4xl mx-auto">
<!-- Current Question -->
<div id="currentQuestion" class="question-card bg-white rounded-xl shadow-lg p-8 mb-6">
<!-- é¢˜ç›®å†…å®¹å°†é€šè¿‡JavaScriptåŠ è½½ -->
</div>
<!-- Navigation -->
<div class="flex justify-between items-center">
<button id="prevBtn" class="bg-gray-500 text-white px-6 py-2 !rounded-button hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
<i class="ri-arrow-left-line mr-2"></i><span data-i18n="exam.previous">ä¸Šä¸€é¢˜</span>
</button>
<div class="flex space-x-2">
<button id="markBtn" class="bg-yellow-500 text-white px-4 py-2 !rounded-button hover:bg-yellow-600 transition-colors">
<i class="ri-bookmark-line mr-2"></i><span data-i18n="exam.mark">æ ‡è®°</span>
</button>
<button id="nextBtn" class="bg-primary text-white px-6 py-2 !rounded-button hover:bg-opacity-90 transition-colors">
<span data-i18n="exam.next">ä¸‹ä¸€é¢˜</span><i class="ri-arrow-right-line ml-2"></i>
</button>
<button id="submitSuggestion" class="bg-green-600 text-white px-6 py-2 !rounded-button hover:bg-green-700 transition-colors hidden">
<i class="ri-flag-line mr-2"></i><span data-i18n="exam.submit_suggestion">å»ºè®®æäº¤</span>
</button>
</div>
</div>
<!-- Submit Button -->
<div class="mt-8 text-center">
<button id="submitExam" class="bg-red-600 text-white px-8 py-3 !rounded-button font-semibold hover:bg-red-700 transition-colors">
<i class="ri-send-plane-line mr-2"></i><span data-i18n="exam.submit">æäº¤è€ƒè¯•</span>
</button>
</div>
</div>
</div>
</div>
</div>
<!-- Submit Confirmation Modal -->
<div id="submitModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
<div class="flex items-center justify-center min-h-screen p-4">
<div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
<div class="text-center">
<div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
<i class="ri-alert-line text-red-600 text-2xl"></i>
</div>
<h3 class="text-lg font-semibold text-gray-900 mb-2" data-i18n="exam.submit_confirm_title">ç¡®è®¤æäº¤è€ƒè¯•</h3>
<p class="text-gray-600 mb-6" data-i18n="exam.submit_confirm_message">æäº¤åå°†æ— æ³•ä¿®æ”¹ç­”æ¡ˆï¼Œç¡®å®šè¦æäº¤å—ï¼Ÿ</p>
<div class="flex space-x-4">
<button id="cancelSubmit" class="flex-1 bg-gray-300 text-gray-700 py-2 !rounded-button hover:bg-gray-400 transition-colors">
<span data-i18n="exam.cancel">å–æ¶ˆ</span>
</button>
<button id="confirmSubmit" class="flex-1 bg-red-600 text-white py-2 !rounded-button hover:bg-red-700 transition-colors">
<span data-i18n="exam.confirm_submit">ç¡®è®¤æäº¤</span>
</button>
</div>
</div>
</div>
</div>
</div>

<!-- Exit Confirmation Modal -->
<div id="exitModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
<div class="flex items-center justify-center min-h-screen p-4">
<div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
<div class="text-center">
<div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
<i class="ri-alert-line text-orange-600 text-2xl"></i>
</div>
<h3 class="text-lg font-semibold text-gray-900 mb-2" data-i18n="exam.exit_confirm_title">ç¡®è®¤é€€å‡ºè€ƒè¯•</h3>
<p class="text-gray-600 mb-6" data-i18n="exam.exit_confirm_message">é€€å‡ºåæ‚¨å°†æ— æ³•ç»§ç»­ä½œç­”ï¼Œå·²ç­”é¢˜ç›®å°†ä¸ä¼šä¿å­˜ã€‚ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ</p>
<div class="flex space-x-4">
<button id="cancelExit" class="flex-1 bg-gray-300 text-gray-700 py-2 !rounded-button hover:bg-gray-400 transition-colors">
<span data-i18n="exam.cancel">å–æ¶ˆ</span>
</button>
<button id="confirmExit" class="flex-1 bg-orange-600 text-white py-2 !rounded-button hover:bg-orange-700 transition-colors">
<span data-i18n="exam.confirm_exit">ç¡®è®¤é€€å‡º</span>
</button>
</div>
</div>
</div>
</div>
</div>

<!-- å¤šè¯­è¨€æ”¯æŒè„šæœ¬ -->
<script src="/static/js/i18n.js"></script>

<script>
class ExamInterface {
constructor() {
this.currentQuestionIndex = 0;
this.questions = [];
this.answers = {};
this.markedQuestions = new Set();
this.examId = null;
this.timeRemaining = 75 * 60; // 75åˆ†é’Ÿï¼Œå•ä½ï¼šç§’
this.timer = null;
this.isSubmitting = false;
this.init();
}
init() {
this.loadExamData();
this.setupEventListeners();
this.startTimer();
}
async loadExamData() {
try {
// ä»URLå‚æ•°è·å–è€ƒè¯•IDæˆ–å®ä¾‹ID
const urlParams = new URLSearchParams(window.location.search);
this.examId = urlParams.get('exam_id');
this.instanceId = urlParams.get('instance_id');

// æ”¯æŒæ–°æ—§ä¸¤ç§æ¨¡å¼
if (!this.examId && !this.instanceId) {
alert(t('exam.invalid_id', 'æ— æ•ˆçš„è€ƒè¯•ID'));
window.location.href = '/';
return;
}

// ç¡®å®šä½¿ç”¨å“ªç§æ¨¡å¼
this.useInstance = !!this.instanceId;
// åŠ è½½è€ƒè¯•é¢˜ç›®
const apiUrl = this.useInstance ? 
    `/api/exam-instance-questions/${this.instanceId}` : 
    `/api/exam-questions/${this.examId}`;
const response = await fetch(apiUrl);
if (!response.ok) {
throw new Error(t('exam.load_failed', 'åŠ è½½è€ƒè¯•å¤±è´¥'));
}
const data = await response.json();
this.questions = data.questions;

// è·å–æ—¶é—´é™åˆ¶ï¼Œæ”¯æŒæ–°æ—§ä¸¤ç§æ•°æ®ç»“æ„
let timeLimit = 75; // é»˜è®¤75åˆ†é’Ÿ
if (this.useInstance && data.instance_info) {
    // å¦‚æœæ˜¯è€ƒè¯•å®ä¾‹ï¼Œä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨è®¡ç®—çš„å‰©ä½™æ—¶é—´
    if (data.instance_info.time_remaining !== undefined) {
        this.timeRemaining = data.instance_info.time_remaining;
    } else {
        timeLimit = data.instance_info.time_limit || 75;
        this.timeRemaining = timeLimit * 60;
    }
} else if (data.time_limit) {
    timeLimit = data.time_limit;
    this.timeRemaining = timeLimit * 60;
} else {
    this.timeRemaining = timeLimit * 60;
}
this.renderQuestion();
this.renderNavigation();
} catch (error) {
console.error('åŠ è½½è€ƒè¯•æ•°æ®å¤±è´¥:', error);
alert(t('exam.load_failed_retry', 'åŠ è½½è€ƒè¯•å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'));
}
}
setupEventListeners() {
// å¯¼èˆªæŒ‰é’®
document.getElementById('prevBtn').addEventListener('click', () => this.previousQuestion());
document.getElementById('nextBtn').addEventListener('click', () => this.nextQuestion());
document.getElementById('markBtn').addEventListener('click', () => this.toggleMark());
document.getElementById('submitExam').addEventListener('click', () => this.showSubmitModal());
document.getElementById('submitSuggestion').addEventListener('click', () => this.showSubmitModal());
document.getElementById('cancelSubmit').addEventListener('click', () => this.hideSubmitModal());
document.getElementById('confirmSubmit').addEventListener('click', () => this.submitExam());
// é€€å‡ºæŒ‰é’®
document.getElementById('exitExam').addEventListener('click', () => this.showExitModal());
document.getElementById('cancelExit').addEventListener('click', () => this.hideExitModal());
document.getElementById('confirmExit').addEventListener('click', () => this.exitExam());
// é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', (e) => {
if (e.key === 'ArrowLeft') this.previousQuestion();
if (e.key === 'ArrowRight') this.nextQuestion();
if (e.key === 'm' || e.key === 'M') this.toggleMark();
if (e.key === 'Enter' && e.ctrlKey) this.showSubmitModal();
});
// æµè§ˆå™¨å…³é—­/åˆ·æ–°ç¡®è®¤
window.addEventListener('beforeunload', (e) => this.handleBeforeUnload(e));
}
startTimer() {
this.timer = setInterval(() => {
this.timeRemaining--;
this.updateTimer();
if (this.timeRemaining <= 0) {
this.autoSubmit();
}
}, 1000);
}
updateTimer() {
const minutes = Math.floor(this.timeRemaining / 60);
const seconds = this.timeRemaining % 60;
const timerElement = document.getElementById('timer');
timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
// æ—¶é—´è­¦å‘Š
if (this.timeRemaining <= 300) { // æœ€å5åˆ†é’Ÿ
timerElement.classList.add('text-red-600');
timerElement.classList.add('timer-warning');
} else if (this.timeRemaining <= 900) { // æœ€å15åˆ†é’Ÿ
timerElement.classList.add('text-yellow-600');
}
}
renderQuestion() {
if (this.questions.length === 0) return;
const question = this.questions[this.currentQuestionIndex];
const container = document.getElementById('currentQuestion');
const currentAnswer = this.answers[question.id] || '';
const isLastQuestion = this.currentQuestionIndex === this.questions.length - 1;

container.innerHTML = `
<div class="mb-6">
<div class="flex items-center justify-between mb-4">
<h2 class="text-xl font-semibold text-gray-900">${t('exam.question', 'ç¬¬')} ${this.currentQuestionIndex + 1} ${t('exam.question_unit', 'é¢˜')} ${isLastQuestion ? `<span class="text-red-600 text-base font-normal">(${t('exam.last_question', 'æœ€åä¸€é¢˜')})</span>` : ''}</h2>
<div class="flex items-center space-x-2">
<span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">${question.subject}</span>
<span class="px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full">${question.difficulty}</span>
<span class="px-3 py-1 bg-purple-100 text-purple-800 text-sm rounded-full">${question.cognitive_level}</span>
</div>
</div>
<div class="prose max-w-none">
<div class="text-gray-700 text-lg leading-relaxed math-content" data-original-text="${question.content.replace(/"/g, '&quot;')}">${question.content}</div>
</div>
${isLastQuestion ? `<div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg"><p class="text-yellow-800 text-sm"><i class="ri-information-line mr-1"></i>${t('exam.last_question_tip', 'è¿™æ˜¯æœ€åä¸€é¢˜ï¼Œç­”é¢˜å®Œæˆåå»ºè®®æäº¤è€ƒè¯•ã€‚')}</p></div>` : ''}
</div>
<div class="answer-section">
${this.renderAnswerInput(question, currentAnswer)}
</div>
`;
// æ›´æ–°è¿›åº¦å’ŒæŒ‰é’®çŠ¶æ€
this.updateProgress();
this.updateNavigationButtons();

// æ¸²æŸ“æ•°å­¦å…¬å¼
this.renderMathJax();
}

// æ·»åŠ MathJaxæ¸²æŸ“æ–¹æ³•
renderMathJax() {
if (window.MathJax && window.MathJax.typesetPromise) {
    const container = document.getElementById('currentQuestion');
    if (!container) {
        console.warn('âš ï¸ currentQuestion å®¹å™¨ä¸å­˜åœ¨');
        return;
    }
    
    // é‡æ–°æ¸²æŸ“é¡µé¢ä¸­çš„æ•°å­¦å…¬å¼
    window.MathJax.typesetPromise([container])
        .then(() => {
            console.log('ğŸ§® æ•°å­¦å…¬å¼æ¸²æŸ“å®Œæˆ');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ¸²æŸ“é”™è¯¯çš„å…ƒç´ ï¼Œå¦‚æœæœ‰åˆ™å°è¯•ä¿®å¤
            const errorElements = container.querySelectorAll('.mjx-merror, .MathJax_Error');
            if (errorElements.length > 0) {
                console.warn(`âš ï¸ å‘ç° ${errorElements.length} ä¸ªæ•°å­¦å…¬å¼é”™è¯¯ï¼Œå°è¯•ä¿®å¤...`);
                this.fixMathErrors(container);
            }
        })
        .catch((err) => {
            console.warn('âš ï¸ æ•°å­¦å…¬å¼æ¸²æŸ“å¤±è´¥:', err);
            // å°è¯•æ¸…ç†é”™è¯¯çš„æ•°å­¦å…¬å¼ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬
            this.fallbackMathRender(container);
        });
} else {
    // å¦‚æœMathJaxè¿˜æ²¡æœ‰åŠ è½½å®Œæˆï¼Œå»¶è¿Ÿæ¸²æŸ“
    setTimeout(() => this.renderMathJax(), 100);
}
}

// ä¿®å¤æ•°å­¦å…¬å¼é”™è¯¯
fixMathErrors(container) {
const errorElements = container.querySelectorAll('.mjx-merror, .MathJax_Error');
errorElements.forEach(errorElem => {
    try {
        // å°è¯•è·å–åŸå§‹æ–‡æœ¬å¹¶é‡æ–°æ¸²æŸ“
        const parentElem = errorElem.closest('.math-content') || errorElem.parentElement;
        if (parentElem && parentElem.dataset.originalText) {
            const originalText = parentElem.dataset.originalText;
            console.log('ğŸ”§ å°è¯•ä¿®å¤å…¬å¼:', originalText);
            
            // ç®€å•çš„å…¬å¼ä¿®å¤ï¼šç§»é™¤å¯èƒ½æœ‰é—®é¢˜çš„å­—ç¬¦
            const cleanedText = originalText
                .replace(/[^\w\s\$\(\)\[\]\{\}\+\-\*\/\=\^\\_\\\,\.\|]/g, '') // ç§»é™¤ç‰¹æ®Šå­—ç¬¦
                .replace(/\$\$+/g, '$') // è§„èŒƒåŒ–ç¾å…ƒç¬¦å·
                .replace(/\\\\/g, '\\'); // è§„èŒƒåŒ–åæ–œæ 
            
            if (cleanedText !== originalText) {
                parentElem.innerHTML = cleanedText;
                // é‡æ–°æ¸²æŸ“è¿™ä¸ªå…ƒç´ 
                window.MathJax.typesetPromise([parentElem]).catch(e => {
                    console.warn('ä¿®å¤åçš„å…¬å¼ä»ç„¶æœ‰é”™è¯¯:', e);
                    parentElem.innerHTML = originalText.replace(/\$/g, ''); // ç§»é™¤æ‰€æœ‰æ•°å­¦æ ‡è®°æ˜¾ç¤ºåŸæ–‡
                });
            }
        } else {
            // å¦‚æœæ— æ³•è·å–åŸå§‹æ–‡æœ¬ï¼Œæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
            errorElem.innerHTML = '<span class="text-red-500 text-sm">[æ•°å­¦å…¬å¼è§£æé”™è¯¯]</span>';
        }
    } catch (e) {
        console.warn('ä¿®å¤æ•°å­¦å…¬å¼æ—¶å‡ºé”™:', e);
    }
});
}

// é™çº§æ•°å­¦å…¬å¼æ¸²æŸ“
fallbackMathRender(container) {
const mathElements = container.querySelectorAll('[data-original-text]');
mathElements.forEach(elem => {
    try {
        const originalText = elem.dataset.originalText;
        // ç§»é™¤æ•°å­¦æ ‡è®°ï¼Œæ˜¾ç¤ºçº¯æ–‡æœ¬
        const cleanText = originalText.replace(/\$+/g, '').replace(/\\\([^)]*\\\)/g, '').replace(/\\\[[^\]]*\\\]/g, '');
        elem.innerHTML = cleanText;
        elem.className += ' math-fallback text-gray-600';
    } catch (e) {
        console.warn('é™çº§æ¸²æŸ“å¤±è´¥:', e);
    }
});
}
renderAnswerInput(question, currentAnswer) {
console.log('é¢˜ç›®ç±»å‹:', question.type_key, 'é€‰é¡¹:', question.options);
if (question.type_key === 'multiple_choice' || question.type === 'é€‰æ‹©é¢˜') {
return this.renderMultipleChoice(question, currentAnswer);
} else if (question.type_key === 'short_answer' || question.type === 'ç®€ç­”é¢˜') {
return this.renderShortAnswer(question, currentAnswer);
} else if (question.type_key === 'programming' || question.type === 'ç¼–ç¨‹é¢˜') {
return this.renderProgramming(question, currentAnswer);
}
// é»˜è®¤æŒ‰é€‰æ‹©é¢˜å¤„ç†ï¼ˆå¦‚æœæœ‰é€‰é¡¹çš„è¯ï¼‰
if (question.options && question.options.length > 0) {
return this.renderMultipleChoice(question, currentAnswer);
}
return this.renderShortAnswer(question, currentAnswer);
}
renderMultipleChoice(question, currentAnswer) {
console.log('æ¸²æŸ“é€‰æ‹©é¢˜:', question);
let html = '<div class="space-y-3">';
if (question.options && question.options.length > 0) {
question.options.forEach((option, index) => {
const optionId = `option_${question.id}_${index}`;
const isChecked = currentAnswer === option;
const optionLetter = String.fromCharCode(65 + index); // A, B, C, D
// å®‰å…¨åœ°è½¬ä¹‰é€‰é¡¹å†…å®¹ï¼Œé¿å…JavaScriptæ³¨å…¥å’Œè¯­æ³•é”™è¯¯
const escapedOption = option.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
html += `
<label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${isChecked ? 'border-primary bg-blue-50' : 'border-gray-200'}" onclick="examInterface.selectOption(${question.id}, ${index})">
<input type="radio" name="answer_${question.id}" value="${escapedOption}" class="sr-only" ${isChecked ? 'checked' : ''}>
<div class="flex items-center space-x-3">
<div class="w-6 h-6 border-2 rounded-full flex items-center justify-center ${isChecked ? 'border-primary bg-primary' : 'border-gray-300'}">
${isChecked ? '<i class="ri-check-line text-white text-sm"></i>' : ''}
</div>
<span class="font-medium text-gray-700 w-8">${optionLetter}.</span>
<span class="text-gray-700 flex-1 math-content" data-original-text="${option.replace(/"/g, '&quot;')}">${option}</span>
</div>
</label>
`;
});
} else {
html += `<div class="text-gray-500 text-center py-4">${t('exam.no_options', 'æš‚æ— é€‰é¡¹')}</div>`;
}
html += '</div>';
return html;
}
renderShortAnswer(question, currentAnswer) {
return `
<div>
<textarea 
id="answer_${question.id}" 
class="answer-input w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none resize-none" 
rows="4" 
placeholder="${t('exam.answer_placeholder', 'è¯·è¾“å…¥æ‚¨çš„ç­”æ¡ˆ...')}">${currentAnswer}</textarea>
</div>
`;
}
renderProgramming(question, currentAnswer) {
const editorId = `code_editor_${question.id}`;
const textareaId = `answer_${question.id}`;

// å»¶è¿Ÿåˆå§‹åŒ–CodeMirrorï¼Œç¡®ä¿DOMå…ƒç´ å·²ç»åˆ›å»º
setTimeout(() => {
    this.initCodeEditor(question.id, currentAnswer || '');
}, 100);

return `
<div>
<div class="mb-2">
<label class="block text-sm font-medium text-gray-700 mb-2">${t('exam.programming_code', 'ç¼–ç¨‹ä»£ç ')}</label>
<div class="border border-gray-300 rounded-lg overflow-hidden">
    <textarea 
    id="${textareaId}" 
    class="answer-input hidden" 
    rows="10">${currentAnswer || ''}</textarea>
    <div id="${editorId}" class="h-64"></div>
</div>
</div>
<div class="text-xs text-gray-500 flex items-center justify-between">
<div>
<i class="ri-information-line mr-1"></i>
${t('exam.code_tip', 'æ”¯æŒPythonè¯­æ³•ï¼Œè¯·ç¡®ä¿ä»£ç å¯ä»¥æ­£å¸¸è¿è¡Œ')}
</div>
<div class="text-xs text-gray-400">
<i class="ri-keyboard-line mr-1"></i>
Tab: ç¼©è¿› | Ctrl+/: æ³¨é‡Š | Ctrl+Z: æ’¤é”€
</div>
</div>
</div>
`;
}
renderNavigation() {
const container = document.getElementById('questionNav');
let html = '';
this.questions.forEach((question, index) => {
const isAnswered = this.answers[question.id];
const isMarked = this.markedQuestions.has(question.id);
const isCurrent = index === this.currentQuestionIndex;
html += `
<button 
class="w-full p-3 text-left rounded-lg transition-colors ${isCurrent ? 'bg-primary text-white' : isAnswered ? 'bg-green-100 text-green-800' : isMarked ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}"
onclick="examInterface.goToQuestion(${index})"
>
<div class="flex items-center justify-between">
<span class="font-medium">${t('exam.question', 'ç¬¬')} ${index + 1} ${t('exam.question_unit', 'é¢˜')}</span>
<div class="flex space-x-1">
${isAnswered ? '<i class="ri-check-line text-sm"></i>' : ''}
${isMarked ? '<i class="ri-bookmark-fill text-sm"></i>' : ''}
</div>
</div>
</button>
`;
});
container.innerHTML = html;
}
updateProgress() {
const answeredCount = Object.keys(this.answers).length;
const progress = (answeredCount / this.questions.length) * 100;
document.getElementById('progressBar').style.width = `${progress}%`;
document.getElementById('progressText').textContent = `${answeredCount}/${this.questions.length}`;
}
selectOption(questionId, optionIndex) {
// è·å–å½“å‰é¢˜ç›®
const question = this.questions.find(q => q.id == questionId);
if (!question || !question.options || optionIndex >= question.options.length) {
console.error('æ— æ•ˆçš„é¢˜ç›®æˆ–é€‰é¡¹ç´¢å¼•');
return;
}
// è·å–é€‰é¡¹å†…å®¹
const option = question.options[optionIndex];
// æ›´æ–°ç­”æ¡ˆ
this.answers[questionId] = option;
// é‡æ–°æ¸²æŸ“å½“å‰é¢˜ç›®ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
this.renderQuestion();
this.updateProgress();
this.renderNavigation();
}

saveAnswer() {
const question = this.questions[this.currentQuestionIndex];
let answer = '';

if (question.type_key === 'multiple_choice') {
    const selected = document.querySelector(`input[name="answer_${question.id}"]:checked`);
    answer = selected ? selected.value : '';
} else if (question.type_key === 'programming' || question.type === 'ç¼–ç¨‹é¢˜') {
    // å¯¹äºç¼–ç¨‹é¢˜ï¼Œä»CodeMirrorç¼–è¾‘å™¨è·å–ç­”æ¡ˆ
    if (this.codeEditors && this.codeEditors[question.id]) {
        answer = this.codeEditors[question.id].getValue();
    } else {
        // å¦‚æœç¼–è¾‘å™¨æœªåˆå§‹åŒ–ï¼Œä»textareaè·å–
        const input = document.getElementById(`answer_${question.id}`);
        answer = input ? input.value : '';
    }
} else {
    // å…¶ä»–é¢˜å‹ä»inputè·å–
    const input = document.getElementById(`answer_${question.id}`);
    answer = input ? input.value : '';
}

if (answer && answer.trim()) {
    this.answers[question.id] = answer;
} else {
    delete this.answers[question.id];
}

this.updateProgress();
this.renderNavigation();
}

// åˆå§‹åŒ–ä»£ç ç¼–è¾‘å™¨
initCodeEditor(questionId, initialValue = '') {
    const editorId = `code_editor_${questionId}`;
    const textareaId = `answer_${questionId}`;
    const editorElement = document.getElementById(editorId);
    const textareaElement = document.getElementById(textareaId);
    
    if (!editorElement || !textareaElement) {
        console.warn(`ä»£ç ç¼–è¾‘å™¨å…ƒç´ æœªæ‰¾åˆ°: ${editorId}`);
        return;
    }
    
    // å¦‚æœç¼–è¾‘å™¨å·²ç»åˆå§‹åŒ–ï¼Œå…ˆé”€æ¯
    if (this.codeEditors && this.codeEditors[questionId]) {
        try {
            // è·å–ç¼–è¾‘å™¨çš„DOMå…ƒç´ å¹¶æ‰‹åŠ¨æ¸…ç†
            const editor = this.codeEditors[questionId];
            if (editor.getWrapperElement && editor.getWrapperElement()) {
                const wrapper = editor.getWrapperElement();
                if (wrapper.parentNode) {
                    wrapper.parentNode.removeChild(wrapper);
                }
            }
            // å¦‚æœæœ‰toTextAreaæ–¹æ³•åˆ™è°ƒç”¨
            if (typeof editor.toTextArea === 'function') {
                editor.toTextArea();
            }
        } catch (e) {
            console.warn('ç¼–è¾‘å™¨é”€æ¯å¤±è´¥ï¼Œå¿½ç•¥é”™è¯¯:', e);
        }
        delete this.codeEditors[questionId];
    }
    
    // åˆå§‹åŒ–ç¼–è¾‘å™¨æ•°ç»„
    if (!this.codeEditors) {
        this.codeEditors = {};
    }
    
    // è®¾ç½®åˆå§‹å€¼
    textareaElement.value = initialValue;
    
    // åˆ›å»ºCodeMirrorç¼–è¾‘å™¨
    const editor = CodeMirror(editorElement, {
        value: initialValue,
        mode: 'python',
        theme: 'default',
        lineNumbers: true,
        indentUnit: 4,
        indentWithTabs: false,
        autoCloseBrackets: true,
        matchBrackets: true,
        styleActiveLine: true,
        lineWrapping: true,
        extraKeys: {
            "Ctrl-/": "toggleComment",
            "Cmd-/": "toggleComment",
            "Tab": function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                } else {
                    cm.replaceSelection("    "); // 4ä¸ªç©ºæ ¼ç¼©è¿›
                }
            },
            "Shift-Tab": function(cm) {
                cm.indentSelection("subtract");
            },
            "Enter": function(cm) {
                // æ™ºèƒ½ç¼©è¿›
                const cursor = cm.getCursor();
                const line = cm.getLine(cursor.line);
                const indentMatch = line.match(/^(\s*)/);
                const currentIndent = indentMatch ? indentMatch[1] : '';
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å¢åŠ ç¼©è¿›ï¼ˆå¦‚æœè¡Œå°¾æ˜¯ : ï¼‰
                let newIndent = currentIndent;
                if (line.trim().endsWith(':')) {
                    newIndent += '    '; // å¢åŠ 4ä¸ªç©ºæ ¼
                }
                
                cm.replaceSelection('\n' + newIndent);
            }
        }
    });
    
    // è®¾ç½®ç¼–è¾‘å™¨æ ·å¼
    editor.setSize(null, 250); // è®¾ç½®é«˜åº¦
    
    // ç›‘å¬å˜åŒ–å¹¶åŒæ­¥åˆ°éšè—çš„textarea
    editor.on('change', () => {
        const value = editor.getValue();
        textareaElement.value = value;
        // ä¿å­˜ç­”æ¡ˆ
        this.answers[questionId] = value;
        this.updateProgress();
    });
    
    // é˜»æ­¢ç¼–è¾‘å™¨å†…çš„é”®ç›˜äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
    editor.on('keydown', (cm, event) => {
        // é˜»æ­¢å¯¼èˆªé”®ï¼ˆå·¦å³ä¸Šä¸‹é”®ã€Page Up/Downç­‰ï¼‰å†’æ³¡
        const navigationKeys = [
            'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
            'PageUp', 'PageDown', 'Home', 'End'
        ];
        
        if (navigationKeys.includes(event.key)) {
            event.stopPropagation();
        }
        
        // é˜»æ­¢ä¸€äº›ç»„åˆé”®çš„å†’æ³¡
        if (event.ctrlKey || event.metaKey) {
            event.stopPropagation();
        }
    });
    
    // é˜»æ­¢ç¼–è¾‘å™¨ç„¦ç‚¹äº‹ä»¶å†’æ³¡
    editor.on('focus', (cm, event) => {
        if (event) {
            event.stopPropagation();
        }
    });
    
    // é˜»æ­¢ç¼–è¾‘å™¨ç‚¹å‡»äº‹ä»¶å†’æ³¡
    const editorWrapper = editor.getWrapperElement();
    if (editorWrapper) {
        editorWrapper.addEventListener('click', (event) => {
            event.stopPropagation();
        });
        
        editorWrapper.addEventListener('keydown', (event) => {
            // ç¡®ä¿å¯¼èˆªé”®ä¸ä¼šè§¦å‘é¡µé¢çº§åˆ«çš„å¯¼èˆª
            const navigationKeys = [
                'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
                'PageUp', 'PageDown', 'Home', 'End'
            ];
            
            if (navigationKeys.includes(event.key)) {
                event.stopPropagation();
            }
        });
    }
    
    // å­˜å‚¨ç¼–è¾‘å™¨å¼•ç”¨
    this.codeEditors[questionId] = editor;
    
    console.log(`ä»£ç ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆ: ${questionId}`);
}
previousQuestion() {
this.saveAnswer();
if (this.currentQuestionIndex > 0) {
this.currentQuestionIndex--;
this.renderQuestion();
this.updateNavigationButtons();
this.renderNavigation(); // æ›´æ–°å¯¼èˆªæŒ‰é’®çš„é«˜äº®çŠ¶æ€
}
}
nextQuestion() {
this.saveAnswer();
if (this.currentQuestionIndex < this.questions.length - 1) {
this.currentQuestionIndex++;
this.renderQuestion();
this.updateNavigationButtons();
this.renderNavigation(); // æ›´æ–°å¯¼èˆªæŒ‰é’®çš„é«˜äº®çŠ¶æ€
}
}
goToQuestion(index) {
this.saveAnswer();
this.currentQuestionIndex = index;
this.renderQuestion();
this.updateNavigationButtons();
this.renderNavigation(); // æ›´æ–°å¯¼èˆªæŒ‰é’®çš„é«˜äº®çŠ¶æ€
}
toggleMark() {
const question = this.questions[this.currentQuestionIndex];
if (this.markedQuestions.has(question.id)) {
this.markedQuestions.delete(question.id);
} else {
this.markedQuestions.add(question.id);
}
this.renderNavigation();
}
updateNavigationButtons() {
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitSuggestion = document.getElementById('submitSuggestion');
const markBtn = document.getElementById('markBtn');
const submitExam = document.getElementById('submitExam');

const isLastQuestion = this.currentQuestionIndex === this.questions.length - 1;

if (isLastQuestion) {
    // æœ€åä¸€é¢˜ï¼šéšè—æ‰€æœ‰å¯¼èˆªæŒ‰é’®ï¼Œåªæ˜¾ç¤ºæäº¤è€ƒè¯•æŒ‰é’®
    prevBtn.style.display = 'none';
    nextBtn.style.display = 'none';
    submitSuggestion.style.display = 'none';
    markBtn.style.display = 'none';
    
    // çªå‡ºæ˜¾ç¤ºæäº¤æŒ‰é’®ï¼ˆæœ€åä¸€é¢˜ï¼‰
    submitExam.classList.remove('bg-orange-600', 'hover:bg-orange-700', 'bg-red-600', 'hover:bg-red-700');
    submitExam.classList.add('bg-green-600', 'hover:bg-green-700', 'text-lg', 'px-12', 'py-4');
    submitExam.innerHTML = `<i class="ri-send-plane-line mr-2"></i><span data-i18n="exam.submit_final">${t('exam.submit_final', 'æäº¤è€ƒè¯•')}</span>`;
} else {
    // éæœ€åä¸€é¢˜ï¼šæ˜¾ç¤ºæ­£å¸¸çš„å¯¼èˆªæŒ‰é’®
    prevBtn.style.display = 'block';
    nextBtn.style.display = 'block';
    markBtn.style.display = 'block';
    submitSuggestion.style.display = 'none';
    
    // æ˜¾ç¤ºæå‰æäº¤æŒ‰é’®ï¼ˆæ©™è‰²è­¦å‘Šæ ·å¼ï¼‰
    submitExam.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-lg', 'px-12', 'py-4', 'bg-red-600', 'hover:bg-red-700');
    submitExam.classList.add('bg-orange-600', 'hover:bg-orange-700');
    submitExam.innerHTML = `<i class="ri-alert-line mr-2"></i><span data-i18n="exam.submit_early">${t('exam.submit_early', 'æå‰æäº¤')}</span>`;
    
    // è®¾ç½®ä¸Šä¸€é¢˜æŒ‰é’®çŠ¶æ€
    prevBtn.disabled = this.currentQuestionIndex === 0;
    nextBtn.disabled = false;
}
}
showSubmitModal() {
const isLastQuestion = this.currentQuestionIndex === this.questions.length - 1;
const modal = document.getElementById('submitModal');

// æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
const iconContainer = modal.querySelector('.w-16.h-16');
const title = modal.querySelector('[data-i18n="exam.submit_confirm_title"]');
const message = modal.querySelector('[data-i18n="exam.submit_confirm_message"]');
const confirmBtn = modal.querySelector('#confirmSubmit');

if (isLastQuestion) {
    // æœ€åä¸€é¢˜ï¼šæ­£å¸¸æäº¤
    iconContainer.className = 'w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4';
    iconContainer.innerHTML = '<i class="ri-check-line text-green-600 text-2xl"></i>';
    title.textContent = t('exam.submit_final_confirm_title', 'å®Œæˆè€ƒè¯•');
    message.textContent = t('exam.submit_final_confirm_message', 'æ‚¨å·²å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼Œç¡®å®šè¦æäº¤è€ƒè¯•å—ï¼Ÿ');
    confirmBtn.className = 'flex-1 bg-green-600 text-white py-2 !rounded-button hover:bg-green-700 transition-colors';
    confirmBtn.innerHTML = `<span data-i18n="exam.confirm_submit_final">${t('exam.confirm_submit_final', 'æäº¤è€ƒè¯•')}</span>`;
} else {
    // éæœ€åä¸€é¢˜ï¼šæå‰æäº¤è­¦å‘Š
    iconContainer.className = 'w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4';
    iconContainer.innerHTML = '<i class="ri-alert-line text-orange-600 text-2xl"></i>';
    title.textContent = t('exam.submit_early_confirm_title', 'æå‰æäº¤è€ƒè¯•');
    message.textContent = t('exam.submit_early_confirm_message', 'æ‚¨è¿˜æœ‰æœªå®Œæˆçš„é¢˜ç›®ï¼Œæå‰æäº¤å¯èƒ½å½±å“æˆç»©ã€‚ç¡®å®šè¦æäº¤å—ï¼Ÿ');
    confirmBtn.className = 'flex-1 bg-orange-600 text-white py-2 !rounded-button hover:bg-orange-700 transition-colors';
    confirmBtn.innerHTML = `<span data-i18n="exam.confirm_submit_early">${t('exam.confirm_submit_early', 'ç¡®è®¤æå‰æäº¤')}</span>`;
}

modal.classList.remove('hidden');
}
hideSubmitModal() {
document.getElementById('submitModal').classList.add('hidden');
}
showExitModal() {
document.getElementById('exitModal').classList.remove('hidden');
}
hideExitModal() {
document.getElementById('exitModal').classList.add('hidden');
}
exitExam() {
clearInterval(this.timer);
window.removeEventListener('beforeunload', this.handleBeforeUnload);
window.location.href = '/';
}
async submitExam() {
if (this.isSubmitting) return;
this.isSubmitting = true;
this.saveAnswer();
try {
const response = await fetch('/api/submit-exam', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(this.useInstance ? {
instance_id: this.instanceId,
answers: this.answers
} : {
exam_id: this.examId,
answers: this.answers
})
});
if (!response.ok) {
throw new Error(t('exam.submit_failed', 'æäº¤å¤±è´¥'));
}
const result = await response.json();
if (result.success) {
clearInterval(this.timer);
// æ ¹æ®åç«¯è¿”å›çš„é‡å®šå‘URLè¿›è¡Œè·³è½¬
const redirectUrl = result.redirect_url || `/results/${this.examId}`;
window.location.href = redirectUrl;
} else {
alert(t('exam.submit_failed', 'æäº¤å¤±è´¥') + ': ' + result.message);
}
} catch (error) {
console.error('æäº¤è€ƒè¯•å¤±è´¥:', error);
alert(t('exam.submit_failed_retry', 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•'));
} finally {
this.isSubmitting = false;
}
}
async autoSubmit() {
clearInterval(this.timer);
alert(t('exam.time_up_auto_submit', 'è€ƒè¯•æ—¶é—´å·²åˆ°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æäº¤æ‚¨çš„ç­”æ¡ˆ'));
await this.submitExam();
}

handleBeforeUnload(e) {
// å¦‚æœè€ƒè¯•æ­£åœ¨è¿›è¡Œä¸”æœªæäº¤ï¼Œæ˜¾ç¤ºç¡®è®¤æç¤º
if (!this.isSubmitting && this.questions.length > 0) {
const message = t('exam.leave_warning', 'æ‚¨æ­£åœ¨è¿›è¡Œè€ƒè¯•ï¼Œé€€å‡ºåå°†æ— æ³•ç»§ç»­ä½œç­”ã€‚ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ');
e.preventDefault();
e.returnValue = message;
return message;
}
}
}

// å…¨å±€å˜é‡å£°æ˜
let examInterface = null;

// åˆå§‹åŒ–å¤šè¯­è¨€å’Œè€ƒè¯•ç•Œé¢
document.addEventListener('DOMContentLoaded', async function() {
    // ç­‰å¾…å¤šè¯­è¨€åˆå§‹åŒ–å®Œæˆ
    if (window.i18n && !window.i18n.initialized) {
        await new Promise(resolve => {
            document.addEventListener('i18n:initialized', resolve, { once: true });
        });
    }
    
    // åˆå§‹åŒ–è€ƒè¯•ç•Œé¢
    examInterface = new ExamInterface();
    window.examInterface = examInterface; // è®¾ç½®ä¸ºå…¨å±€å˜é‡
    
    // ç»‘å®šå¤šè¯­è¨€æ›´æ–°äº‹ä»¶
    document.addEventListener('i18n:languageChanged', () => {
        // é‡æ–°æ¸²æŸ“å½“å‰é¢˜ç›®ä»¥æ›´æ–°è¯­è¨€
        if (examInterface && examInterface.questions.length > 0) {
            examInterface.renderQuestion();
            examInterface.renderNavigation();
        }
    });
});

// å¤‡ç”¨åˆå§‹åŒ–ï¼ˆå¦‚æœDOMContentLoadedå·²ç»è§¦å‘ï¼‰
if (document.readyState === 'loading') {
    // ä¸Šé¢çš„äº‹ä»¶ç›‘å¬å™¨ä¼šå¤„ç†
} else {
    // DOMå·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–
    setTimeout(() => {
        if (!examInterface) {
            examInterface = new ExamInterface();
            window.examInterface = examInterface;
        }
    }, 100);
}
</script>
</body>
</html>
