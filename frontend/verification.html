<!DOCTYPE html>
<html lang="zh-CN" id="htmlRoot">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="verification.title">è€ƒç”Ÿèº«ä»½éªŒè¯ - IMBA æ™ºèƒ½è€ƒè¯•ç³»ç»Ÿ</title>
<link rel="icon" type="image/x-icon" id="faviconLink" href="/favicon.ico">
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<script>
tailwind.config = {
theme: {
extend: {
colors: {
primary: '#2563eb',
secondary: '#3b82f6',
success: '#10b981',
warning: '#f59e0b',
danger: '#ef4444'
},
fontFamily: {
'sans': ['Inter', 'system-ui', 'sans-serif']
},
borderRadius: {
'xl': '12px',
'2xl': '16px'
}
}
}
}
</script>
<style>
body {
font-family: 'Inter', sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.glass-effect {
backdrop-filter: blur(10px);
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
}

.form-input {
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-input:focus {
box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
transform: translateY(-1px);
}

.btn-primary {
background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
transition: all 0.3s ease;
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
}

.btn-admin {
background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.btn-admin:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
}

.fade-in {
animation: fadeIn 0.6s ease-out;
}

.slide-up {
animation: slideUp 0.6s ease-out;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

@keyframes slideUp {
from { 
opacity: 0;
transform: translateY(30px);
}
to { 
opacity: 1;
transform: translateY(0);
}
}

.loading-spinner {
animation: spin 1s linear infinite;
}

@keyframes spin {
from { transform: rotate(0deg); }
to { transform: rotate(360deg); }
}

.error-shake {
animation: shake 0.5s ease-in-out;
}

@keyframes shake {
0%, 100% { transform: translateX(0); }
25% { transform: translateX(-5px); }
75% { transform: translateX(5px); }
}
</style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
<!-- Background Elements -->
<div class="fixed inset-0 overflow-hidden pointer-events-none">
<div class="absolute -top-1/2 -right-1/2 w-96 h-96 bg-blue-500 rounded-full opacity-10 animate-pulse"></div>
<div class="absolute -bottom-1/2 -left-1/2 w-96 h-96 bg-purple-500 rounded-full opacity-10 animate-pulse" style="animation-delay: 1s;"></div>
</div>

<!-- Main Container -->
<div class="w-full max-w-md mx-auto relative z-10">
<!-- Header -->
<div class="text-center mb-8 fade-in">
<div class="inline-flex items-center justify-center w-16 h-16 bg-white rounded-2xl shadow-lg mb-4">
<img id="systemLogo" src="https://static.readdy.ai/image/3c1ff9a008dc8b425236e4faed5d7924/c0ad19844b74c75ecb76a8cc5a6f9bd3.jfif" 
alt="IMBA Logo" class="w-10 h-10 object-contain">
</div>
<h1 id="systemName" class="text-3xl font-bold text-white mb-2" data-i18n="system.name">IMBA æ™ºèƒ½è€ƒè¯•</h1>
<p class="text-blue-100" data-i18n="verification.subtitle">å®‰å…¨å¯é çš„åœ¨çº¿è€ƒè¯•å¹³å°</p>
<!-- Language Toggle -->
<button id="languageToggle" class="mt-4 text-white/70 hover:text-white transition-colors px-3 py-2 rounded-lg border border-white/20">
<i class="ri-global-line mr-1"></i>
<span class="language-display">ä¸­</span>
</button>
</div>

<!-- Admin Quick Access (æ˜¾ç¤ºåœ¨ç®¡ç†å‘˜å·²ç™»å½•æ—¶) -->
<div id="adminQuickAccess" class="hidden mb-6 slide-up">
<div class="glass-effect rounded-2xl p-6 text-center">
<div class="inline-flex items-center justify-center w-12 h-12 bg-green-500 rounded-xl mb-4">
<i class="ri-admin-line text-white text-xl"></i>
</div>
<h2 class="text-xl font-semibold text-white mb-2" data-i18n="verification.admin_mode">ç®¡ç†å‘˜æ¨¡å¼</h2>
<p class="text-blue-100 text-sm mb-4" data-i18n="verification.admin_logged_in">æ‚¨å·²ç™»å½•ç®¡ç†å‘˜è´¦æˆ·</p>
<!-- è€ƒè¯•é…ç½®é€‰æ‹© -->
<div class="mb-4">
<select id="adminExamConfigSelect" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/30">
<option value="" data-i18n="verification.select_config">é€‰æ‹©è€ƒè¯•é…ç½®...</option>
</select>
</div>
<button id="adminStartExamBtn" class="btn-admin w-full py-3 px-6 rounded-xl font-semibold text-white flex items-center justify-center space-x-2">
<i class="ri-play-fill"></i>
<span data-i18n="verification.start_exam_direct">ç›´æ¥è¿›å…¥è€ƒè¯•</span>
</button>
<div class="mt-4 flex justify-center space-x-4 text-sm">
<button id="adminLogoutBtn" class="text-white/70 hover:text-white transition-colors">
<i class="ri-logout-box-line mr-1"></i><span data-i18n="verification.logout">é€€å‡ºç™»å½•</span>
</button>
<a href="/admin/dashboard" class="text-white/70 hover:text-white transition-colors">
<i class="ri-dashboard-line mr-1"></i><span data-i18n="verification.admin_panel">ç®¡ç†é¢æ¿</span>
</a>
</div>
</div>
</div>

<!-- Student Form -->
<div id="studentForm" class="glass-effect rounded-2xl p-6 slide-up">
<div class="text-center mb-6">
<div class="inline-flex items-center justify-center w-12 h-12 bg-blue-500 rounded-xl mb-4">
<i class="ri-user-line text-white text-xl"></i>
</div>
<h2 class="text-xl font-semibold text-white mb-1" data-i18n="verification.student_verification">å­¦ç”Ÿèº«ä»½éªŒè¯</h2>
<p class="text-blue-100 text-sm" data-i18n="verification.form_instruction">è¯·å¡«å†™æ‚¨çš„è€ƒè¯•ä¿¡æ¯</p>
</div>

<form id="verificationForm" class="space-y-4">
<!-- è€ƒè¯•é€‰æ‹© -->
<div class="bg-gradient-to-r from-green-50 to-green-100 border border-green-200 rounded-xl p-4">
<div class="flex items-center space-x-3 mb-3">
<i class="ri-file-list-3-line text-green-600 text-lg"></i>
<h4 class="text-green-800 font-medium" data-i18n="verification.select_exam">é€‰æ‹©è€ƒè¯•</h4>
</div>
<div id="examTemplatesList" class="space-y-2">
<div class="text-center text-green-600 py-4">
<i class="ri-loader-4-line text-xl animate-spin"></i>
<p class="mt-2 text-sm" data-i18n="verification.loading_exams">æ­£åœ¨åŠ è½½å¯ç”¨è€ƒè¯•...</p>
</div>
</div>
</div>

<div id="dynamicFieldsContainer">
<!-- åŠ¨æ€åŠ è½½éªŒè¯å­—æ®µ -->
</div>


<!-- è€ƒè¯•é¡»çŸ¥ -->
<div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-4">
<div class="flex items-start space-x-3">
<div class="flex-shrink-0">
<i class="ri-file-list-3-line text-green-300 text-lg mt-0.5"></i>
</div>
<div class="text-xs text-blue-100 space-y-1" id="examNotice">
<p class="font-medium text-white" data-i18n="verification.exam_instructions">è€ƒè¯•é¡»çŸ¥</p>
<p data-i18n="verification.auto_generate">â€¢ ç³»ç»Ÿå°†æ ¹æ®é»˜è®¤é…ç½®è‡ªåŠ¨ç”Ÿæˆè€ƒè¯•é¢˜ç›®</p>
<p id="examTimeLimit" data-i18n="verification.time_limit">â€¢ è€ƒè¯•æ—¶é—´é™åˆ¶ï¼šåŠ è½½ä¸­...</p>
<p id="examQuestionCount" data-i18n="verification.question_count">â€¢ é¢˜ç›®æ•°é‡ï¼šåŠ è½½ä¸­...</p>
<p id="examSubjects" data-i18n="verification.subjects">â€¢ è€ƒè¯•ç§‘ç›®ï¼šåŠ è½½ä¸­...</p>
<p data-i18n="verification.one_chance">â€¢ æ¯ä½è€ƒç”Ÿä»…æœ‰ä¸€æ¬¡è€ƒè¯•æœºä¼šï¼Œè¯·è®¤çœŸä½œç­”</p>
</div>
</div>
</div>

<!-- è®¾å¤‡ä¿¡æ¯æç¤º -->
<div class="bg-white/5 border border-white/10 rounded-xl p-4">
<div class="flex items-start space-x-3">
<div class="flex-shrink-0">
<i class="ri-information-line text-blue-300 text-lg mt-0.5"></i>
</div>
<div class="text-xs text-blue-100 space-y-1">
<p class="font-medium text-white" data-i18n="verification.device_binding">è®¾å¤‡ç»‘å®šä¿¡æ¯</p>
<p>
<span data-i18n="verification.current_ip">â€¢ å½“å‰è®¾å¤‡ IPï¼š</span>
<span id="deviceIP" class="font-mono text-blue-200">è·å–ä¸­...</span>
</p>
<p>
<span data-i18n="verification.device_id_label">â€¢ è®¾å¤‡æ ‡è¯†ï¼š</span>
<span id="deviceId" class="font-mono text-blue-200">ç”Ÿæˆä¸­...</span>
</p>
<p data-i18n="verification.device_warning">â€¢ æäº¤åå°†ç»‘å®šå½“å‰è®¾å¤‡ï¼Œæ— æ³•åœ¨å…¶ä»–è®¾å¤‡é‡å¤è€ƒè¯•</p>
</div>
</div>
</div>

<!-- æäº¤æŒ‰é’® -->
<button type="submit" id="submitButton" class="btn-primary w-full py-3 px-6 rounded-xl font-semibold text-white flex items-center justify-center space-x-2">
<span id="buttonText" data-i18n="verification.start_exam">å¼€å§‹è€ƒè¯•</span>
<div id="loadingSpinner" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full loading-spinner hidden"></div>
</button>

<!-- é”™è¯¯ä¿¡æ¯ -->
<div id="generalError" class="text-red-300 text-sm text-center hidden"></div>

<!-- ç®¡ç†å‘˜ç™»å½•å…¥å£ -->
<div class="text-center mt-4">
<button type="button" id="showAdminLoginBtn" class="text-white/60 hover:text-white text-sm transition-colors">
<i class="ri-admin-line mr-1"></i><span data-i18n="verification.admin_login">ç®¡ç†å‘˜ç™»å½•</span>
</button>
</div>
</form>
</div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
<div class="bg-white rounded-2xl p-6 w-full max-w-sm mx-auto transform transition-all">
<div class="text-center mb-6">
<div class="inline-flex items-center justify-center w-12 h-12 bg-green-500 rounded-xl mb-4">
<i class="ri-admin-line text-white text-xl"></i>
</div>
<h3 class="text-xl font-semibold text-gray-900 mb-1" data-i18n="verification.admin_login_title">ç®¡ç†å‘˜ç™»å½•</h3>
<p class="text-gray-600 text-sm" data-i18n="verification.admin_password_prompt">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </p>
</div>

<form id="adminLoginForm" class="space-y-4">
<div>
<label class="block text-gray-700 text-sm font-medium mb-2" data-i18n="verification.password">å¯†ç </label>
<input type="password" id="adminPassword" required
class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
data-i18n="verification.password_placeholder" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
<div id="adminPasswordError" class="text-red-500 text-xs mt-1 hidden"></div>
</div>

<div class="flex space-x-3">
<button type="button" id="cancelAdminLoginBtn" class="flex-1 py-3 px-4 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors">
<span data-i18n="verification.cancel">å–æ¶ˆ</span>
</button>
<button type="submit" id="adminLoginBtn" class="flex-1 py-3 px-4 bg-green-500 text-white rounded-xl font-medium hover:bg-green-600 transition-colors flex items-center justify-center">
<span id="adminLoginText" data-i18n="verification.login">ç™»å½•</span>
<div id="adminLoginSpinner" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full loading-spinner hidden ml-2"></div>
</button>
</div>

<div id="adminLoginError" class="text-red-500 text-sm text-center hidden"></div>
</form>
</div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
<div class="bg-white rounded-2xl p-8 text-center">
<div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full loading-spinner mx-auto mb-4"></div>
<p class="text-gray-700 font-medium" data-i18n="verification.processing">æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</p>
</div>
</div>

<!-- å¤šè¯­è¨€æ”¯æŒè„šæœ¬ -->
<script src="/static/js/i18n.js"></script>

<script>
// å…¨å±€å˜é‡
let isAdminLoggedIn = false;
let examConfigs = [];

// DOMå…ƒç´ 
const adminQuickAccess = document.getElementById('adminQuickAccess');
const studentForm = document.getElementById('studentForm');
const adminLoginModal = document.getElementById('adminLoginModal');
const loadingOverlay = document.getElementById('loadingOverlay');

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', async function() {
console.log('é¡µé¢åˆå§‹åŒ–å¼€å§‹');

// ç­‰å¾…å¤šè¯­è¨€åˆå§‹åŒ–å®Œæˆ
if (window.i18n && !window.i18n.initialized) {
await new Promise(resolve => {
document.addEventListener('i18n:initialized', resolve, { once: true });
});
}

// å…ˆåˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
await loadExamTemplates();
await loadVerificationFields();
await checkAdminStatus();
await loadExamConfigs();
initEventListeners();

// æœ€åç”Ÿæˆè®¾å¤‡ä¿¡æ¯ï¼Œç¡®ä¿DOMå…ƒç´ å·²å®Œå…¨å°±ç»ª
setTimeout(async () => {
    await generateDeviceInfo();
}, 100);

console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
});

// ç»‘å®šå¤šè¯­è¨€æ›´æ–°äº‹ä»¶
document.addEventListener('i18n:languageChanged', () => {
// é‡æ–°åŠ è½½åŠ¨æ€å†…å®¹çš„ç¿»è¯‘
updateDynamicTranslations();
});

// æ›´æ–°åŠ¨æ€ç¿»è¯‘å†…å®¹
function updateDynamicTranslations() {
    // æ›´æ–°è€ƒè¯•é¡»çŸ¥
    const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
    
    if (currentLang === 'en') {
        // è‹±æ–‡ç¿»è¯‘
        const timeLimitElement = document.getElementById('examTimeLimit');
        const questionCountElement = document.getElementById('examQuestionCount');
        const subjectsElement = document.getElementById('examSubjects');
        
        if (timeLimitElement && timeLimitElement.textContent.includes('è€ƒè¯•æ—¶é—´é™åˆ¶')) {
            timeLimitElement.textContent = timeLimitElement.textContent.replace('è€ƒè¯•æ—¶é—´é™åˆ¶ï¼š', 'Time Limit: ').replace('åˆ†é’Ÿ', ' minutes');
        }
        
        if (questionCountElement && questionCountElement.textContent.includes('é¢˜ç›®æ•°é‡')) {
            questionCountElement.textContent = questionCountElement.textContent.replace('é¢˜ç›®æ•°é‡ï¼š', 'Questions: ').replace('é¢˜ï¼ˆåŒ…å«é€‰æ‹©é¢˜ã€ç®€ç­”é¢˜ç­‰ï¼‰', ' questions (multiple choice, short answer, etc.)');
        }
        
        if (subjectsElement && subjectsElement.textContent.includes('è€ƒè¯•ç§‘ç›®')) {
            subjectsElement.textContent = subjectsElement.textContent.replace('è€ƒè¯•ç§‘ç›®ï¼š', 'Subjects: ');
        }
    } else {
        // ä¸­æ–‡ç¿»è¯‘ï¼ˆæ¢å¤åŸæ–‡ï¼‰
        const timeLimitElement = document.getElementById('examTimeLimit');
        const questionCountElement = document.getElementById('examQuestionCount');
        const subjectsElement = document.getElementById('examSubjects');
        
        if (timeLimitElement && timeLimitElement.textContent.includes('Time Limit')) {
            timeLimitElement.textContent = timeLimitElement.textContent.replace('Time Limit: ', 'è€ƒè¯•æ—¶é—´é™åˆ¶ï¼š').replace(' minutes', 'åˆ†é’Ÿ');
        }
        
        if (questionCountElement && questionCountElement.textContent.includes('Questions')) {
            questionCountElement.textContent = questionCountElement.textContent.replace('Questions: ', 'é¢˜ç›®æ•°é‡ï¼š').replace(' questions (multiple choice, short answer, etc.)', 'é¢˜ï¼ˆåŒ…å«é€‰æ‹©é¢˜ã€ç®€ç­”é¢˜ç­‰ï¼‰');
        }
        
        if (subjectsElement && subjectsElement.textContent.includes('Subjects')) {
            subjectsElement.textContent = subjectsElement.textContent.replace('Subjects: ', 'è€ƒè¯•ç§‘ç›®ï¼š');
        }
    }
}

// è·å–çœŸå®è®¾å¤‡ä¿¡æ¯
async function generateDeviceInfo() {
try {
    console.log('ğŸ” å¼€å§‹ç”Ÿæˆè®¾å¤‡ä¿¡æ¯...');
    
    // æ£€æŸ¥DOMçŠ¶æ€
    console.log('ğŸ“‹ DOMçŠ¶æ€æ£€æŸ¥:');
    console.log('- deviceIdå…ƒç´ :', document.getElementById('deviceId'));
    console.log('- deviceIPå…ƒç´ :', document.getElementById('deviceIP'));
    console.log('- æ‰€æœ‰ID:', Array.from(document.querySelectorAll('[id]')).map(el => el.id));
    
    // å…ˆç”Ÿæˆè®¾å¤‡IDï¼Œè¿™ä¸ªæ¯”è¾ƒå¿«
    const deviceId = await generateDeviceFingerprint();
    console.log('ğŸ”¢ ç”Ÿæˆçš„è®¾å¤‡ID:', deviceId);
    
    // è®¾ç½®è®¾å¤‡ID - ä½¿ç”¨æ›´å¼ºå¤§çš„æŸ¥æ‰¾æ–¹æ³•
    const setDeviceId = (id) => {
        // æ–¹æ³•1ï¼šé€šè¿‡IDæŸ¥æ‰¾
        let deviceIdElement = document.getElementById('deviceId');
        
        // æ–¹æ³•2ï¼šå¦‚æœIDæ‰¾ä¸åˆ°ï¼Œé€šè¿‡å±æ€§æŸ¥æ‰¾
        if (!deviceIdElement) {
            deviceIdElement = document.querySelector('span[id="deviceId"]');
        }
        
        // æ–¹æ³•3ï¼šé€šè¿‡åŒ…å«æ–‡æœ¬æŸ¥æ‰¾
        if (!deviceIdElement) {
            const allSpans = document.querySelectorAll('span');
            deviceIdElement = Array.from(allSpans).find(span => 
                span.className.includes('font-mono') && 
                (span.textContent.includes('ç”Ÿæˆä¸­') || span.textContent.includes('æ— æ³•ç”Ÿæˆ'))
            );
        }
        
        if (deviceIdElement) {
            deviceIdElement.textContent = id;
            console.log('âœ… è®¾å¤‡IDå·²è®¾ç½®:', id);
            return true;
        } else {
            console.warn('âŒ deviceId å…ƒç´ æœªæ‰¾åˆ°');
            return false;
        }
    };
    
    if (!setDeviceId(deviceId)) {
        // é‡è¯•æœºåˆ¶
        setTimeout(() => {
            if (!setDeviceId(deviceId)) {
                console.error('âŒ é‡è¯•å¤±è´¥ï¼ŒdeviceId å…ƒç´ ä»æœªæ‰¾åˆ°');
            }
        }, 500);
    }

    // è·å–ç”¨æˆ·çœŸå®IPåœ°å€ï¼Œä½¿ç”¨å¤šç§æ–¹æ³•
    let deviceIP = 'è·å–ä¸­...';
    
    // æ–¹æ³•1ï¼šé€šè¿‡æœ¬åœ°æœåŠ¡å™¨è·å–
    try {
        const serverResponse = await fetch('/api/get-client-ip');
        if (serverResponse.ok) {
            const serverData = await serverResponse.json();
            if (serverData.success && serverData.ip) {
                deviceIP = serverData.ip;
            }
        }
    } catch (error) {
        console.warn('é€šè¿‡æœåŠ¡å™¨è·å–IPå¤±è´¥:', error);
    }
    
    // æ–¹æ³•2ï¼šå¦‚æœæœåŠ¡å™¨æ–¹æ³•å¤±è´¥ï¼Œå°è¯•WebRTCæ–¹æ³•
    if (deviceIP === 'è·å–ä¸­...') {
        try {
            deviceIP = await getLocalIP();
        } catch (error) {
            console.warn('WebRTCè·å–IPå¤±è´¥:', error);
        }
    }
    
    // æ–¹æ³•3ï¼šå¦‚æœWebRTCä¹Ÿå¤±è´¥ï¼Œå°è¯•å¤–éƒ¨APIï¼ˆä½œä¸ºæœ€åå¤‡ç”¨ï¼‰
    if (deviceIP === 'è·å–ä¸­...' || deviceIP === 'æ— æ³•è·å–') {
        try {
            const timeout = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('timeout')), 3000));
            const ipResponse = await Promise.race([
                fetch('https://api.ipify.org?format=json'),
                timeout
            ]);
            const ipData = await ipResponse.json();
            deviceIP = ipData.ip || 'æ— æ³•è·å–';
        } catch (error) {
            console.warn('å¤–éƒ¨APIè·å–IPå¤±è´¥:', error);
            deviceIP = 'æ— æ³•è·å–';
        }
    }

    // è®¾ç½®IPåœ°å€ - ä½¿ç”¨æ›´å¼ºå¤§çš„æŸ¥æ‰¾æ–¹æ³•
    const setDeviceIP = (ip) => {
        // æ–¹æ³•1ï¼šé€šè¿‡IDæŸ¥æ‰¾
        let deviceIPElement = document.getElementById('deviceIP');
        
        // æ–¹æ³•2ï¼šå¦‚æœIDæ‰¾ä¸åˆ°ï¼Œé€šè¿‡å±æ€§æŸ¥æ‰¾
        if (!deviceIPElement) {
            deviceIPElement = document.querySelector('span[id="deviceIP"]');
        }
        
        // æ–¹æ³•3ï¼šé€šè¿‡åŒ…å«æ–‡æœ¬æŸ¥æ‰¾
        if (!deviceIPElement) {
            const allSpans = document.querySelectorAll('span');
            deviceIPElement = Array.from(allSpans).find(span => 
                span.className.includes('font-mono') && 
                (span.textContent.includes('è·å–ä¸­') || span.textContent.includes('æ— æ³•è·å–') || span.textContent.includes('127.0.0.1'))
            );
        }
        
        if (deviceIPElement) {
            deviceIPElement.textContent = ip;
            console.log('âœ… è®¾å¤‡IPå·²è®¾ç½®:', ip);
            return true;
        } else {
            console.warn('âŒ deviceIP å…ƒç´ æœªæ‰¾åˆ°');
            return false;
        }
    };
    
    if (!setDeviceIP(deviceIP)) {
        // é‡è¯•æœºåˆ¶
        setTimeout(() => {
            if (!setDeviceIP(deviceIP)) {
                console.error('âŒ é‡è¯•å¤±è´¥ï¼ŒdeviceIP å…ƒç´ ä»æœªæ‰¾åˆ°');
            }
        }, 500);
    }
    
    console.log('è®¾å¤‡ä¿¡æ¯ç”Ÿæˆå®Œæˆ:', { deviceIP, deviceId });
} catch (error) {
    console.error('ç”Ÿæˆè®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);
    // ä½¿ç”¨å¤‡ç”¨ä¿¡æ¯ - ä½¿ç”¨ç›¸åŒçš„å¼ºå¤§æŸ¥æ‰¾æ–¹æ³•
    const setFallbackInfo = () => {
        // è®¾ç½®å¤‡ç”¨IP
        let deviceIPElement = document.getElementById('deviceIP') || 
                             document.querySelector('span[id="deviceIP"]') ||
                             Array.from(document.querySelectorAll('span')).find(span => 
                                span.className.includes('font-mono') && 
                                span.textContent.includes('è·å–ä¸­'));
        if (deviceIPElement) {
            deviceIPElement.textContent = 'æ— æ³•è·å–';
        } else {
            console.warn('è®¾ç½®å¤‡ç”¨IPä¿¡æ¯æ—¶ï¼ŒdeviceIP å…ƒç´ ä»æœªæ‰¾åˆ°');
        }
        
        // è®¾ç½®å¤‡ç”¨è®¾å¤‡ID
        let deviceIdElement = document.getElementById('deviceId') || 
                             document.querySelector('span[id="deviceId"]') ||
                             Array.from(document.querySelectorAll('span')).find(span => 
                                span.className.includes('font-mono') && 
                                span.textContent.includes('ç”Ÿæˆä¸­'));
        if (deviceIdElement) {
            deviceIdElement.textContent = 'æ— æ³•ç”Ÿæˆ';
        } else {
            console.warn('è®¾ç½®å¤‡ç”¨è®¾å¤‡IDä¿¡æ¯æ—¶ï¼ŒdeviceId å…ƒç´ ä»æœªæ‰¾åˆ°');
        }
    };
    
    // ç«‹å³å°è¯•è®¾ç½®
    setFallbackInfo();
    
    // å¦‚æœå¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
    setTimeout(setFallbackInfo, 500);
}
}

// è·å–æœ¬åœ°IPï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
async function getLocalIP() {
return new Promise((resolve) => {
    const rtc = new RTCPeerConnection({iceServers: []});
    rtc.createDataChannel('');
    rtc.onicecandidate = (evt) => {
        if (evt.candidate) {
            const ip = evt.candidate.candidate.split(' ')[4];
            if (ip && ip !== '0.0.0.0') {
                resolve(ip);
                rtc.close();
            }
        }
    };
    rtc.createOffer().then(offer => rtc.setLocalDescription(offer));
    
    // è¶…æ—¶ä¿æŠ¤
    setTimeout(() => {
        resolve('127.0.0.1');
        rtc.close();
    }, 3000);
});
}

// ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
async function generateDeviceFingerprint() {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
ctx.textBaseline = 'top';
ctx.font = '14px Arial';
ctx.fillText('Device fingerprint', 2, 2);

const fingerprint = [
    navigator.userAgent,
    navigator.language,
    screen.width + 'x' + screen.height,
    new Date().getTimezoneOffset(),
    canvas.toDataURL(),
    navigator.hardwareConcurrency || 'unknown'
].join('|');

// ä½¿ç”¨ç®€å•å“ˆå¸Œç”ŸæˆçŸ­ID
let hash = 0;
for (let i = 0; i < fingerprint.length; i++) {
    const char = fingerprint.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
}

return `DEV-${Math.abs(hash).toString(36).substring(0, 8).toUpperCase()}`;
}

// åŠ è½½å¯ç”¨è€ƒè¯•æ¨¡æ¿
async function loadExamTemplates() {
try {
    const response = await fetch('/api/available-exam-templates');
    const result = await response.json();
    
    if (result.success && result.templates.length > 0) {
        renderExamTemplates(result.templates);
    } else {
        const container = document.getElementById('examTemplatesList');
        container.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                <i class="ri-information-line text-xl"></i>
                <p class="mt-2 text-sm" data-i18n="verification.no_exams">æš‚æ— å¯ç”¨è€ƒè¯•</p>
            </div>
        `;
    }
} catch (error) {
    console.error('åŠ è½½è€ƒè¯•æ¨¡æ¿å¤±è´¥:', error);
    const container = document.getElementById('examTemplatesList');
    container.innerHTML = `
        <div class="text-center text-red-500 py-4">
            <i class="ri-error-warning-line text-xl"></i>
            <p class="mt-2 text-sm">åŠ è½½è€ƒè¯•å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
        </div>
    `;
}
}

// æ¸²æŸ“è€ƒè¯•æ¨¡æ¿åˆ—è¡¨
function renderExamTemplates(templates) {
const container = document.getElementById('examTemplatesList');
let html = '';

templates.forEach((template, index) => {
    const timeInfo = template.time_limit ? `${template.time_limit}åˆ†é’Ÿ` : 'ä¸é™æ—¶';
    const questionsInfo = template.questions_count ? `${template.questions_count}é¢˜` : '';
    
    // æ ¹æ®è€ƒè¯•ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡è¯†
    const typeInfo = template.type === 'config' ? 
        `<span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
            <i class="ri-settings-line mr-1"></i>é…ç½®è€ƒè¯•
        </span>` : 
        `<span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">
            <i class="ri-file-list-line mr-1"></i>å›ºå®šæ¨¡æ¿
        </span>`;
    
    // å¯¹äºé…ç½®è€ƒè¯•ï¼Œæ˜¾ç¤ºç§‘ç›®ä¿¡æ¯
    const subjectInfo = template.type === 'config' && template.subjects ? 
        `<div class="text-xs text-gray-500 mt-1">
            <i class="ri-book-line"></i> ç§‘ç›®ï¼š${template.subjects}
        </div>` : '';
    
    // é€šè¿‡ç‡ä¿¡æ¯
    const passingInfo = template.passing_score ? 
        `<span class="ml-2"><i class="ri-award-line"></i> åŠæ ¼çº¿ï¼š${template.passing_score}åˆ†</span>` : '';
    
    html += `
        <label class="exam-template-option flex items-center space-x-3 p-3 border border-green-200 rounded-lg cursor-pointer hover:bg-green-50 transition-colors ${index === 0 ? 'bg-green-50 border-green-300' : ''}">
            <input type="radio" name="examTemplate" value="${template.id}" class="text-green-600 focus:ring-green-500" ${index === 0 ? 'checked' : ''}>
            <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                    <div class="font-medium text-gray-900">${template.name}</div>
                    ${typeInfo}
                </div>
                <div class="text-sm text-gray-600 mb-2">${template.description || 'æš‚æ— æè¿°'}</div>
                <div class="text-xs text-green-600">
                    <span class="inline-flex items-center space-x-2">
                        <i class="ri-time-line"></i>
                        <span>${timeInfo}</span>
                        ${questionsInfo ? `<span class="ml-2"><i class="ri-file-list-line"></i> ${questionsInfo}</span>` : ''}
                        ${passingInfo}
                    </span>
                </div>
                ${subjectInfo}
            </div>
        </label>
    `;
});

container.innerHTML = html;

// æ·»åŠ é€‰æ‹©äº‹ä»¶ç›‘å¬
const options = container.querySelectorAll('.exam-template-option');
options.forEach(option => {
    option.addEventListener('click', function() {
        // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­æ ·å¼
        options.forEach(opt => {
            opt.classList.remove('bg-green-50', 'border-green-300');
            opt.classList.add('border-green-200');
        });
        
        // æ·»åŠ å½“å‰é€‰é¡¹çš„é€‰ä¸­æ ·å¼
        this.classList.add('bg-green-50', 'border-green-300');
        this.classList.remove('border-green-200');
        
        // é€‰ä¸­å¯¹åº”çš„radio
        this.querySelector('input[type="radio"]').checked = true;
    });
});
}

// åŠ è½½éªŒè¯å­—æ®µé…ç½®
async function loadVerificationFields() {
try {
const response = await fetch('/api/verification-config');
const result = await response.json();

if (result.success) {
renderVerificationFields(result.configs);
} else {
console.error('åŠ è½½éªŒè¯å­—æ®µé…ç½®å¤±è´¥:', result.message);
// ä½¿ç”¨é»˜è®¤é…ç½®
renderDefaultFields();
}
} catch (error) {
console.error('åŠ è½½éªŒè¯å­—æ®µé…ç½®å¤±è´¥:', error);
// ä½¿ç”¨é»˜è®¤é…ç½®
renderDefaultFields();
}
}

// æ¸²æŸ“éªŒè¯å­—æ®µ
function renderVerificationFields(configs) {
const container = document.getElementById('dynamicFieldsContainer');
container.innerHTML = '';

configs.forEach(config => {
if (config.is_enabled) {
const fieldHtml = createFieldHTML(config);
container.insertAdjacentHTML('beforeend', fieldHtml);
}
});
}

// åˆ›å»ºå­—æ®µHTML
function createFieldHTML(config) {
const fieldIcon = getFieldIcon(config.field_name);
const requiredAttr = config.is_required ? 'required' : '';
const maxLengthAttr = config.field_name === 'id_number' ? 'maxlength="18"' : '';

return `
<div class="verification-field">
<label class="block text-white/90 text-sm font-medium mb-2">
<i class="${fieldIcon} mr-1"></i>${config.display_name}${config.is_required ? ' *' : ''}
</label>
<input type="${config.field_type}" 
id="${config.field_name}" 
name="${config.field_name}" 
${requiredAttr}
${maxLengthAttr}
class="form-input w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent"
placeholder="${config.placeholder || ''}"
data-validation="${config.validation_pattern || ''}"
data-error-message="${config.error_message || ''}">
<div id="${config.field_name}Error" class="text-red-300 text-xs mt-1 hidden"></div>
</div>
`;
}

// è·å–å­—æ®µå›¾æ ‡
function getFieldIcon(fieldName) {
const icons = {
name: 'ri-user-line',
id_number: 'ri-id-card-line',
application_number: 'ri-file-text-line'
};
return icons[fieldName] || 'ri-text';
}

// æ¸²æŸ“é»˜è®¤å­—æ®µï¼ˆå¤‡ç”¨ï¼‰
function renderDefaultFields() {
const defaultConfigs = [
{
field_name: 'name',
display_name: 'å§“å',
is_required: true,
is_enabled: true,
field_type: 'text',
placeholder: 'è¯·è¾“å…¥æ‚¨çš„å§“å'
},
{
field_name: 'id_number',
display_name: 'èº«ä»½è¯å·',
is_required: true,
is_enabled: true,
field_type: 'text',
placeholder: 'è¯·è¾“å…¥18ä½èº«ä»½è¯å·',
validation_pattern: '^[1-9]\\d{5}(18|19|20)\\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\\d{3}[0-9Xx]$',
error_message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„èº«ä»½è¯å·ç '
},
{
field_name: 'application_number',
display_name: 'æŠ¥åå·',
is_required: true,
is_enabled: true,
field_type: 'text',
placeholder: 'è¯·è¾“å…¥æŠ¥åå·ç '
}
];
renderVerificationFields(defaultConfigs);
}

// æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
async function checkAdminStatus() {
try {
const response = await fetch('/api/admin/status');
const result = await response.json();
console.log('ç®¡ç†å‘˜çŠ¶æ€æ£€æŸ¥ç»“æœ:', result);

if (result.success && result.is_admin) {
isAdminLoggedIn = true;
showAdminInterface();
} else {
isAdminLoggedIn = false;
showStudentInterface();
}
} catch (error) {
console.log('æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å¤±è´¥:', error);
isAdminLoggedIn = false;
showStudentInterface();
}
}

// æ˜¾ç¤ºç®¡ç†å‘˜ç•Œé¢
function showAdminInterface() {
console.log('æ˜¾ç¤ºç®¡ç†å‘˜ç•Œé¢');
adminQuickAccess.classList.remove('hidden');
studentForm.classList.add('hidden');
}

// æ˜¾ç¤ºå­¦ç”Ÿç•Œé¢
function showStudentInterface() {
console.log('æ˜¾ç¤ºå­¦ç”Ÿç•Œé¢');
adminQuickAccess.classList.add('hidden');
studentForm.classList.remove('hidden');
}

// åŠ è½½è€ƒè¯•é…ç½®
async function loadExamConfigs() {
try {
const response = await fetch('/api/exam-configs');
const result = await response.json();

if (result.success && result.configs) {
examConfigs = result.configs;
populateConfigSelects();
} else {
console.error('åŠ è½½é…ç½®å¤±è´¥:', result.message);
showConfigError();
}
} catch (error) {
console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
showConfigError();
}
}

// å¡«å……é…ç½®é€‰æ‹©æ¡†ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
function populateConfigSelects() {
const adminSelect = document.getElementById('adminExamConfigSelect');

// æ¸…ç©ºå¹¶æ·»åŠ é»˜è®¤é€‰é¡¹
adminSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è€ƒè¯•é…ç½®</option>';

examConfigs.forEach(config => {
const option = `<option value="${config.id}" data-config='${JSON.stringify(config)}'>${config.name}</option>`;
adminSelect.innerHTML += option;
});

// è®¾ç½®é»˜è®¤é…ç½®
const defaultConfig = examConfigs.find(config => config.is_default);
if (defaultConfig) {
adminSelect.value = defaultConfig.id;
// ä¸ºç®¡ç†å‘˜è‡ªåŠ¨ä¿å­˜é»˜è®¤é…ç½®
localStorage.setItem('selectedExamConfigId', defaultConfig.id);
// æ›´æ–°å­¦ç”Ÿç•Œé¢çš„è€ƒè¯•é¡»çŸ¥
updateExamNotice(defaultConfig);
}

// æ·»åŠ ç®¡ç†å‘˜é€‰æ‹©äº‹ä»¶
adminSelect.addEventListener('change', function() {
const selectedConfig = examConfigs.find(config => config.id == this.value);
if (selectedConfig) {
localStorage.setItem('selectedExamConfigId', selectedConfig.id);
} else {
localStorage.removeItem('selectedExamConfigId');
}
});
}

// æ›´æ–°è€ƒè¯•é¡»çŸ¥ä¿¡æ¯
function updateExamNotice(config) {
const timeLimitElement = document.getElementById('examTimeLimit');
const questionCountElement = document.getElementById('examQuestionCount');
const subjectsElement = document.getElementById('examSubjects');

if (timeLimitElement) {
timeLimitElement.textContent = `â€¢ è€ƒè¯•æ—¶é—´é™åˆ¶ï¼š${config.time_limit}åˆ†é’Ÿ`;
}

if (questionCountElement) {
questionCountElement.textContent = `â€¢ é¢˜ç›®æ•°é‡ï¼š${config.total_questions}é¢˜ï¼ˆåŒ…å«é€‰æ‹©é¢˜ã€ç®€ç­”é¢˜ç­‰ï¼‰`;
}

if (subjectsElement) {
const subjects = config.subject_filter ? 
config.subject_filter.split(',').map(s => s.trim()).join('ã€') : 
'æ•°å­¦ã€è‹±è¯­ã€è®¡ç®—æœºã€é€»è¾‘ã€ç»Ÿè®¡å­¦ç­‰';
subjectsElement.textContent = `â€¢ è€ƒè¯•ç§‘ç›®ï¼š${subjects}`;
}
}


// æ˜¾ç¤ºé…ç½®é”™è¯¯
function showConfigError() {
const adminSelect = document.getElementById('adminExamConfigSelect');
adminSelect.innerHTML = '<option value="">åŠ è½½é…ç½®å¤±è´¥</option>';

// æ˜¾ç¤ºé»˜è®¤çš„è€ƒè¯•é¡»çŸ¥
updateExamNotice({
time_limit: 75,
total_questions: 5,
subject_filter: 'æ•°å­¦,è‹±è¯­,è®¡ç®—æœº,é€»è¾‘,ç»Ÿè®¡å­¦'
});
}

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function initEventListeners() {
// å­¦ç”Ÿè¡¨å•æäº¤
const verificationForm = document.getElementById('verificationForm');
if (verificationForm) {
    verificationForm.addEventListener('submit', handleStudentFormSubmit);
}

// ç®¡ç†å‘˜ç™»å½•ç›¸å…³
const showAdminLoginBtn = document.getElementById('showAdminLoginBtn');
const cancelAdminLoginBtn = document.getElementById('cancelAdminLoginBtn');
const adminLoginForm = document.getElementById('adminLoginForm');

if (showAdminLoginBtn) {
    showAdminLoginBtn.addEventListener('click', showAdminLoginModal);
}
if (cancelAdminLoginBtn) {
    cancelAdminLoginBtn.addEventListener('click', hideAdminLoginModal);
}
if (adminLoginForm) {
    adminLoginForm.addEventListener('submit', handleAdminLogin);
}

// ç®¡ç†å‘˜æ“ä½œ
const adminStartExamBtn = document.getElementById('adminStartExamBtn');
const adminLogoutBtn = document.getElementById('adminLogoutBtn');

if (adminStartExamBtn) {
    adminStartExamBtn.addEventListener('click', handleAdminStartExam);
}
if (adminLogoutBtn) {
    adminLogoutBtn.addEventListener('click', handleAdminLogout);
}

// åŠ¨æ€å­—æ®µçš„è¾“å…¥æ ¼å¼åŒ–å’ŒéªŒè¯ï¼ˆå»¶è¿Ÿç»‘å®šï¼‰
setTimeout(() => {
    bindDynamicFieldEvents();
}, 100);
}

// ç»‘å®šåŠ¨æ€å­—æ®µäº‹ä»¶
function bindDynamicFieldEvents() {
// è¾“å…¥æ ¼å¼åŒ–
const idInput = document.getElementById('id_number');
const applicationInput = document.getElementById('application_number');
const nameInput = document.getElementById('name');

if (idInput) {
    idInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^\dXx]/g, '').toUpperCase();
    });
    idInput.addEventListener('blur', function() {
        validateField('id_number', validateIdNumber);
    });
}

if (applicationInput) {
    applicationInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
    });
    applicationInput.addEventListener('blur', function() {
        validateField('application_number', validateApplicationNumber);
    });
}

if (nameInput) {
    nameInput.addEventListener('blur', function() {
        validateField('name', validateName);
    });
}
}

// æ˜¾ç¤ºç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡†
function showAdminLoginModal() {
adminLoginModal.classList.remove('hidden');
document.getElementById('adminPassword').focus();
}

// éšè—ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡†
function hideAdminLoginModal() {
adminLoginModal.classList.add('hidden');
document.getElementById('adminPassword').value = '';
hideError('adminPassword');
}

// å¤„ç†å­¦ç”Ÿè¡¨å•æäº¤
async function handleStudentFormSubmit(e) {
e.preventDefault();

// åŠ¨æ€è·å–è¡¨å•å­—æ®µå€¼
const formData = {};
const verificationFields = document.querySelectorAll('.verification-field input');
verificationFields.forEach(input => {
    formData[input.name] = input.value.trim();
});

// è·å–è®¾å¤‡ä¿¡æ¯
const deviceIPElement = document.getElementById('deviceIP');
const deviceIdElement = document.getElementById('deviceId');
const deviceIP = deviceIPElement ? deviceIPElement.textContent : 'Unknown';
const deviceId = deviceIdElement ? deviceIdElement.textContent : 'Unknown';

// éªŒè¯è¡¨å•
if (!validateForm()) return;

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
showLoading(true);
setButtonLoading('submitButton', true, 'éªŒè¯ä¸­...');

try {
// å­¦ç”Ÿèº«ä»½éªŒè¯
const verifyResponse = await fetch('/api/verify-student', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
...formData,  // åŒ…å«æ‰€æœ‰åŠ¨æ€å­—æ®µ
deviceIP: deviceIP,
deviceId: deviceId
})
});

const verifyResult = await verifyResponse.json();
if (!verifyResult.success) {
throw new Error(verifyResult.message || 'èº«ä»½éªŒè¯å¤±è´¥');
}

// è·å–é€‰æ‹©çš„è€ƒè¯•æ¨¡æ¿
const selectedTemplateElement = document.querySelector('input[name="examTemplate"]:checked');
if (!selectedTemplateElement) {
throw new Error('è¯·é€‰æ‹©ä¸€ä¸ªè€ƒè¯•');
}

const templateId = selectedTemplateElement.value;

// åˆ›å»ºè€ƒè¯• - åŸºäºæ¨¡æ¿åˆ›å»º
const examResponse = await fetch('/api/create-exam-from-template', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
template_id: templateId,
session_id: verifyResult.session_id
})
});

const examResult = await examResponse.json();
if (examResult.success) {
// æ ¹æ®è¿”å›çš„è€ƒè¯•ç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†
if (examResult.type === 'config') {
    // åŸºäºé…ç½®çš„è€ƒè¯•ï¼Œä½¿ç”¨æ—§ç³»ç»Ÿçš„exam_id
    localStorage.setItem('selectedExamId', examResult.exam_id);
    window.location.href = `/exam?exam_id=${examResult.exam_id}`;
} else {
    // åŸºäºæ¨¡æ¿çš„è€ƒè¯•ï¼Œä½¿ç”¨æ–°ç³»ç»Ÿçš„instance_id
    localStorage.setItem('selectedExamInstanceId', examResult.instance_id);
    window.location.href = `/exam?instance_id=${examResult.instance_id}`;
}
} else {
throw new Error(examResult.message || 'åˆ›å»ºè€ƒè¯•å¤±è´¥');
}

} catch (error) {
showError('general', error.message);
} finally {
showLoading(false);
setButtonLoading('submitButton', false, 'å¼€å§‹è€ƒè¯•');
}
}

// å¤„ç†ç®¡ç†å‘˜ç™»å½•
async function handleAdminLogin(e) {
e.preventDefault();

const password = document.getElementById('adminPassword').value.trim();
if (!password) {
showError('adminPassword', 'è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ');
return;
}

setButtonLoading('adminLoginBtn', true, 'ç™»å½•ä¸­...');

try {
const response = await fetch('/api/admin/login', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
username: 'admin',
password: password
})
});

const result = await response.json();
if (result.success) {
isAdminLoggedIn = true;
hideAdminLoginModal();
showAdminInterface();
await loadExamConfigs(); // é‡æ–°åŠ è½½é…ç½®
} else {
showError('adminLogin', result.message || 'ç™»å½•å¤±è´¥');
}
} catch (error) {
showError('adminLogin', 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
} finally {
setButtonLoading('adminLoginBtn', false, 'ç™»å½•');
}
}

// å¤„ç†ç®¡ç†å‘˜å¼€å§‹è€ƒè¯•
async function handleAdminStartExam() {
const selectedConfigId = document.getElementById('adminExamConfigSelect').value;
if (!selectedConfigId) {
alert('è¯·å…ˆé€‰æ‹©è€ƒè¯•é…ç½®');
return;
}

setButtonLoading('adminStartExamBtn', true, 'ç”Ÿæˆè€ƒè¯•ä¸­...');

try {
const response = await fetch('/api/create-exam-instance', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ config_id: selectedConfigId })
});

const result = await response.json();
if (result.success) {
localStorage.setItem('selectedExamConfigId', selectedConfigId);
localStorage.setItem('selectedExamId', result.exam_id);
window.location.href = `/exam?exam_id=${result.exam_id}`;
} else {
throw new Error(result.message || 'åˆ›å»ºè€ƒè¯•å¤±è´¥');
}
} catch (error) {
alert(error.message);
} finally {
setButtonLoading('adminStartExamBtn', false, 'ç›´æ¥è¿›å…¥è€ƒè¯•');
}
}

// å¤„ç†ç®¡ç†å‘˜ç™»å‡º
async function handleAdminLogout() {
try {
const response = await fetch('/api/admin/logout', {
method: 'POST',
headers: { 'Content-Type': 'application/json' }
});

const result = await response.json();
if (result.success) {
isAdminLoggedIn = false;
showStudentInterface();
} else {
alert('ç™»å‡ºå¤±è´¥: ' + result.message);
}
} catch (error) {
alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
}
}

// è¡¨å•éªŒè¯
function validateForm() {
let isValid = true;
const verificationFields = document.querySelectorAll('.verification-field input');

verificationFields.forEach(input => {
const fieldName = input.name;
const value = input.value;
const isRequired = input.hasAttribute('required');
const validationPattern = input.dataset.validation;
const errorMessage = input.dataset.errorMessage;

let error = null;

// å¿…å¡«å­—æ®µéªŒè¯
if (isRequired && !value.trim()) {
error = `è¯·è¾“å…¥${input.previousElementSibling.textContent.replace(' *', '')}`;
} 
// è‡ªå®šä¹‰éªŒè¯è§„åˆ™
else if (value.trim() && validationPattern) {
const regex = new RegExp(validationPattern);
if (!regex.test(value)) {
error = errorMessage || 'æ ¼å¼ä¸æ­£ç¡®';
}
}
// å…¶ä»–ç‰¹å®šéªŒè¯
else if (value.trim()) {
if (fieldName === 'name') {
error = validateName(value);
} else if (fieldName === 'application_number') {
error = validateApplicationNumber(value);
}
}

if (error) {
showError(fieldName, error);
isValid = false;
} else {
hideError(fieldName);
}
});

return isValid;
}

// éªŒè¯å§“å
function validateName(name) {
if (!name.trim()) return 'è¯·è¾“å…¥å§“å';
if (name.length < 2 || name.length > 20) return 'å§“åé•¿åº¦åº”åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´';
if (!/^[\u4e00-\u9fa5a-zA-Z\s]+$/.test(name)) return 'å§“ååªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡å­—æ¯å’Œç©ºæ ¼';
return null;
}

function validateField(fieldId, validatorFunction) {
const element = document.getElementById(fieldId);
if (!element) {
    console.warn(`Field ${fieldId} not found`);
    return;
}
const value = element.value;
const error = validatorFunction(value);
if (error) {
showError(fieldId, error);
} else {
hideError(fieldId);
}
}

// éªŒè¯å‡½æ•°
function validateStudentId(studentId) {
if (!studentId.trim()) return 'è¯·è¾“å…¥è€ƒå·';
if (studentId.length < 3 || studentId.length > 20) return 'è€ƒå·é•¿åº¦åº”åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´';
if (!/^[a-zA-Z0-9_-]+$/.test(studentId)) return 'è€ƒå·åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦';
return null;
}

function validateIdNumber(idNumber) {
if (!idNumber.trim()) return 'è¯·è¾“å…¥èº«ä»½è¯å·';
if (idNumber.length !== 18) return 'èº«ä»½è¯å·å¿…é¡»ä¸º18ä½';
if (!/^\d{17}[\dXx]$/.test(idNumber)) return 'èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®';
return null;
}

function validateApplicationNumber(appNumber) {
if (!appNumber.trim()) return 'è¯·è¾“å…¥ç”³è¯·å·';
if (appNumber.length < 6 || appNumber.length > 20) return 'ç”³è¯·å·é•¿åº¦åº”åœ¨6-20ä¸ªå­—ç¬¦ä¹‹é—´';
if (!/^[A-Za-z0-9]+$/.test(appNumber)) return 'ç”³è¯·å·åªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—';
return null;
}

// UIè¾…åŠ©å‡½æ•°
function showError(fieldId, message) {
const errorElementId = fieldId === 'general' ? 'generalError' : 
fieldId === 'adminLogin' ? 'adminLoginError' :
fieldId === 'adminPassword' ? 'adminPasswordError' :
fieldId + 'Error';

const errorElement = document.getElementById(errorElementId);
const inputElement = fieldId === 'general' || fieldId === 'adminLogin' ? null : document.getElementById(fieldId);

if (errorElement) {
errorElement.textContent = message;
errorElement.classList.remove('hidden');
}

if (inputElement) {
inputElement.classList.add('border-red-400', 'error-shake');
setTimeout(() => inputElement.classList.remove('error-shake'), 500);
}
}

function hideError(fieldId) {
const errorElementId = fieldId === 'general' ? 'generalError' : 
fieldId === 'adminLogin' ? 'adminLoginError' :
fieldId === 'adminPassword' ? 'adminPasswordError' :
fieldId + 'Error';

const errorElement = document.getElementById(errorElementId);
const inputElement = fieldId === 'general' || fieldId === 'adminLogin' ? null : document.getElementById(fieldId);

if (errorElement) {
errorElement.classList.add('hidden');
}

if (inputElement) {
inputElement.classList.remove('border-red-400');
}
}

function setButtonLoading(buttonId, isLoading, text) {
const button = document.getElementById(buttonId);
const textElement = button.querySelector('span');
const spinner = button.querySelector('.loading-spinner');

if (textElement) textElement.textContent = text;
if (spinner) {
if (isLoading) {
spinner.classList.remove('hidden');
} else {
spinner.classList.add('hidden');
}
}
button.disabled = isLoading;
}

function showLoading(show) {
if (show) {
loadingOverlay.classList.remove('hidden');
} else {
loadingOverlay.classList.add('hidden');
}
}
</script>
</body>
</html>