<!DOCTYPE html>
<html lang="zh-CN" id="htmlRoot">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="exam.config.title">考试配置管理 - IMBA 智能考试系统</title>
<link rel="icon" type="image/x-icon" id="faviconLink" href="/favicon.ico">
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<script src="/static/js/i18n.js"></script>
<script>
// i18n初始化由全局i18n.js处理，无需重复初始化
</script>
<script>
tailwind.config = {
theme: {
extend: {
colors: {
primary: '#2563eb',
secondary: '#3b82f6',
success: '#10b981',
warning: '#f59e0b',
danger: '#ef4444'
},
fontFamily: {
'sans': ['Inter', 'system-ui', 'sans-serif']
}
}
}
}
</script>
<style>
body {
font-family: 'Inter', sans-serif;
background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
}

.card {
background: white;
border-radius: 12px;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.card:hover {
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.config-card {
transition: all 0.3s ease;
border-left: 4px solid transparent;
position: relative;
}

.config-card:hover {
border-left-color: #2563eb;
transform: translateX(4px);
}

.config-card.default {
border-left-color: #10b981;
background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
}

.config-card.inactive {
opacity: 0.6;
border-left-color: #9ca3af;
}

.action-button {
transition: all 0.2s ease;
}

.action-button:hover {
transform: scale(1.05);
}

.toggle-switch {
position: relative;
display: inline-block;
width: 44px;
height: 24px;
}

.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}

.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: #ccc;
transition: .4s;
border-radius: 24px;
}

.slider:before {
position: absolute;
content: "";
height: 18px;
width: 18px;
left: 3px;
bottom: 3px;
background-color: white;
transition: .4s;
border-radius: 50%;
}

input:checked + .slider {
background-color: #2563eb;
}

input:checked + .slider:before {
transform: translateX(20px);
}

.fade-in {
animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
0% { opacity: 0; transform: translateY(20px); }
100% { opacity: 1; transform: translateY(0); }
}

/* 美观的难度标签样式 */
.difficulty-tag {
display: inline-block;
cursor: pointer;
transition: all 0.2s ease;
}

.difficulty-tag-content {
display: inline-flex;
align-items: center;
padding: 8px 16px;
background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
border: 2px solid #e2e8f0;
border-radius: 20px;
font-size: 0.875rem;
font-weight: 500;
color: #4a5568;
transition: all 0.2s ease;
white-space: nowrap;
}

.difficulty-icon {
margin-right: 6px;
font-size: 1rem;
}

.difficulty-tag:hover .difficulty-tag-content {
background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
border-color: #cbd5e0;
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.difficulty-tag input:checked + .difficulty-tag-content {
background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
border-color: #2563eb;
color: white;
box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.difficulty-tag input:checked + .difficulty-tag-content:hover {
background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
border-color: #1d4ed8;
}
</style>
</head>

<body class="min-h-screen">
<!-- Navigation -->
<nav class="bg-white shadow-sm border-b sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center h-16">
<div class="flex items-center space-x-4">
<a href="/admin/dashboard" class="flex items-center space-x-3">
<img id="systemLogo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzI1NjNlYiIvPgo8cGF0aCBkPSJNMTIgMTJIMjhWMTZIMTJWMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMThIMjRWMjJIMTJWMThaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMjRIMjhWMjhIMTJWMjRaIiBmaWxsPSJ3aGl0ZSIvPgo8Y2lyY2xlIGN4PSIzMCIgY3k9IjEwIiByPSIzIiBmaWxsPSIjMTBiOTgxIi8+Cjwvc3ZnPgo=" 
alt="System Logo" class="w-8 h-8 object-contain">
<span class="font-bold text-xl text-primary" data-i18n="exam.config.title_short">考试配置管理</span>
</a>
</div>
<div class="flex items-center space-x-4">
<!-- Language Toggle -->
<button id="languageToggle" class="text-gray-600 hover:text-primary transition-colors px-3 py-2 rounded-lg border border-gray-200">
<i class="ri-global-line mr-1"></i>
<span class="language-display">中</span>
</button>
<a href="/admin/dashboard" class="text-gray-600 hover:text-primary transition-colors">
<i class="ri-dashboard-line mr-1"></i><span data-i18n="nav.admin_panel">管理面板</span>
</a>
<a href="/question_management.html" class="text-gray-600 hover:text-primary transition-colors">
<i class="ri-question-line mr-1"></i><span data-i18n="question.management.title_short">题库管理</span>
</a>
<button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
<i class="ri-logout-box-line mr-1"></i><span data-i18n="nav.logout">退出登录</span>
</button>
</div>
</div>
</div>
</nav>

<!-- Main Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
<!-- Page Header -->
<div class="mb-8">
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
<div>
<h1 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="exam.config.title_short">考试配置管理</h1>
<p class="text-gray-600" data-i18n="exam.config.description">管理考试配置，设置考试参数和成绩显示策略</p>
</div>
<div class="flex space-x-3 mt-4 sm:mt-0">
<button id="addConfigBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
<i class="ri-add-line mr-2"></i><span data-i18n="exam.config.add_config">新建配置</span>
</button>
</div>
</div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
<div class="card p-6">
<div class="flex items-center">
<div class="flex-shrink-0">
<div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
<i class="ri-file-list-line text-blue-600 text-xl"></i>
</div>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500" data-i18n="exam.config.stats.total_configs">总配置数</p>
<p class="text-2xl font-bold text-gray-900" id="totalConfigs">0</p>
</div>
</div>
</div>

<div class="card p-6">
<div class="flex items-center">
<div class="flex-shrink-0">
<div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
<i class="ri-check-line text-green-600 text-xl"></i>
</div>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500" data-i18n="exam.config.stats.active_configs">启用配置</p>
<p class="text-2xl font-bold text-gray-900" id="activeConfigs">0</p>
</div>
</div>
</div>

<div class="card p-6">
<div class="flex items-center">
<div class="flex-shrink-0">
<div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
<i class="ri-star-line text-purple-600 text-xl"></i>
</div>
</div>
            <div class="ml-4">
            <p class="text-sm font-medium text-gray-500" data-i18n="exam.config.stats.current_config">当前配置</p>
            <p class="text-lg font-bold text-gray-900" id="defaultConfigName">无</p>
            </div>
</div>
</div>

<div class="card p-6">
<div class="flex items-center">
<div class="flex-shrink-0">
<div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
<i class="ri-eye-line text-orange-600 text-xl"></i>
</div>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500" data-i18n="exam.config.stats.show_results">显示成绩</p>
<p class="text-lg font-bold text-gray-900" id="showResultsCount">0</p>
</div>
</div>
</div>
</div>

<!-- Configurations List -->
<div class="card p-6">
<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-semibold text-gray-900">配置列表</h2>
<div class="flex items-center space-x-4">
<div class="flex items-center text-sm text-gray-500">
<span>共 <span id="totalCount">0</span> 个配置</span>
</div>
<button id="refreshBtn" class="text-gray-400 hover:text-gray-600 p-2">
<i class="ri-refresh-line text-lg"></i>
</button>
</div>
</div>

<!-- Loading State -->
<div id="loadingState" class="hidden text-center py-12">
<div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
<p class="text-gray-600">加载配置中...</p>
</div>

<!-- Empty State -->
<div id="emptyState" class="hidden text-center py-12">
<div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
<i class="ri-inbox-line text-gray-400 text-2xl"></i>
</div>
<h3 class="text-lg font-semibold text-gray-900 mb-2" data-i18n="exam.config.no_configs">暂无配置</h3>
<p class="text-gray-600 mb-6" data-i18n="exam.config.no_configs_desc">点击"新建配置"按钮创建您的第一个考试配置</p>
<button onclick="showAddConfigModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
<i class="ri-add-line mr-2"></i><span data-i18n="exam.config.add_config">新建配置</span>
</button>
</div>

<!-- Configurations Grid -->
<div id="configsContainer" class="space-y-4">
<!-- 动态加载配置 -->
</div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

<!-- Add/Edit Config Modal -->
<div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
<div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-6">
<h3 class="text-2xl font-semibold text-gray-900" id="modalTitle" data-i18n="exam.config.modal_title">新建考试配置</h3>
<button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
<i class="ri-close-line text-2xl"></i>
</button>
</div>

<form id="configForm" class="space-y-6">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- 基本信息 -->
<div class="space-y-6">
<h4 class="text-lg font-semibold text-gray-900 border-b pb-2" data-i18n="exam.config.basic_info">基本信息</h4>

<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.config_name">配置名称 *</label>
<input type="text" id="configName" required 
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
data-i18n-placeholder="exam.config.config_name_placeholder" placeholder="例如：数学期中考试">
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.config_description">配置描述</label>
<textarea id="configDescription" rows="3" 
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
data-i18n-placeholder="exam.config.config_description_placeholder" placeholder="描述这个配置的用途和特点..."></textarea>
</div>

                <div class="grid grid-cols-2 gap-4">
                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.question_count">题目数量 *</label>
                <input type="number" id="configQuestions" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                value="5" min="1" max="50">
                </div>

                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.time_limit">时间限制（分钟）*</label>
                <input type="number" id="configTimeLimit" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                value="75" min="30" max="300">
                </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.question_selection_mode">题目选择模式 *</label>
                <select id="questionSelectionMode" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                onchange="toggleQuestionSelectionMode()">
                <option value="filter" data-i18n="exam.config.filter_mode">筛选模式</option>
                <option value="manual" data-i18n="exam.config.manual_mode">手动选择</option>
                </select>
                <p class="text-xs text-gray-500 mt-1" data-i18n="exam.config.selection_mode_desc">筛选模式：根据条件自动选择题目；手动选择：精确选择指定题目</p>
                </div>

                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.passing_score">及格分数</label>
                <input type="number" id="configPassingScore" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                value="60" min="0" max="100" step="0.1">
                <p class="text-xs text-gray-500 mt-1" data-i18n="exam.config.passing_score_desc">百分制，用于成绩评定</p>
                </div>
                </div>

<!-- 配置选项 -->
<div class="space-y-4">
<h5 class="font-medium text-gray-900" data-i18n="exam.config.config_options">配置选项</h5>

<div class="space-y-3">
<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                <span class="font-medium text-gray-900" data-i18n="exam.config.set_as_current">设为当前考试配置</span>
                <p class="text-sm text-gray-600" data-i18n="exam.config.set_as_current_desc">新创建的考试将默认使用此配置</p>
                </div>
<label class="toggle-switch">
<input type="checkbox" id="configIsDefault">
<span class="slider"></span>
</label>
</div>

<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
<div>
<span class="font-medium text-gray-900" data-i18n="exam.config.active_status">启用状态</span>
<p class="text-sm text-gray-600" data-i18n="exam.config.active_status_desc">是否允许使用此配置</p>
</div>
<label class="toggle-switch">
<input type="checkbox" id="configIsActive" checked>
<span class="slider"></span>
</label>
</div>

<div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border border-yellow-200">
<div>
<span class="font-medium text-gray-900" data-i18n="exam.config.show_results_after_exam">考试完成后显示成绩</span>
<p class="text-sm text-yellow-700" data-i18n="exam.config.show_results_desc">取消后学生完成考试只显示确认页面</p>
</div>
<label class="toggle-switch">
<input type="checkbox" id="configShowResults" checked>
<span class="slider"></span>
</label>
</div>
</div>
</div>
</div>

<!-- 题目选择 -->
<div class="space-y-6">
<h4 class="text-lg font-semibold text-gray-900 border-b pb-2" id="questionSectionTitle">题目筛选</h4>

<!-- 筛选模式 -->
<div id="filterMode" class="space-y-6">

<!-- 精确数量控制 - 简化版 -->
<div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
<div class="flex items-start justify-between">
<div class="flex-1 pr-4">
<div class="flex items-center space-x-3 mb-2">
<h5 class="font-medium text-blue-900" data-i18n="exam.config.quantity_control">精确数量控制</h5>
<label class="toggle-switch">
<input type="checkbox" id="enableQuantityControl" onchange="toggleQuantityControl()">
<span class="slider"></span>
</label>
</div>
<p class="text-sm text-blue-700 mb-3" data-i18n="exam.config.quantity_control_desc">启用后可为每个学科、难度、题型组合指定生成数量</p>
<button type="button" id="openQuantityConfigBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
<i class="ri-settings-3-line mr-2"></i>
<span data-i18n="exam.config.configure_quantity">配置数量</span>
</button>
</div>
</div>

<!-- 数量配置状态显示 -->
<div id="quantityConfigStatus" class="hidden mt-3 p-3 bg-white rounded border border-blue-200">
<div class="flex items-center justify-between text-sm">
<span data-i18n="exam.config.configured_categories">已配置类别:</span>
<span id="configuredCategoriesCount" class="font-semibold text-blue-600">0</span>
</div>
<div class="flex items-center justify-between text-sm mt-1">
<span data-i18n="exam.config.total_configured">已配置总数:</span>
<span id="totalConfiguredCount" class="font-semibold text-green-600">0 <span data-i18n="exam.config.questions_unit">题</span></span>
</div>
<div class="flex items-center justify-between text-sm mt-1">
<span data-i18n="exam.config.target_total">目标总数:</span>
<span id="targetTotalCount" class="font-semibold text-gray-600">5 <span data-i18n="exam.config.questions_unit">题</span></span>
</div>

<!-- 题型预览 -->
<div id="questionTypePreview" class="mt-3 p-3 bg-gray-50 rounded border">
<h6 class="text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.question_type_preview">题型预览:</h6>
<div id="questionTypeBreakdown" class="space-y-1 text-xs text-gray-600">
<!-- 动态生成题型分布 -->
</div>
</div>
</div>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="exam.config.subject_filter">学科筛选</label>
<div class="grid grid-cols-2 gap-3">
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="数学">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.math">📐 数学</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="物理">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.physics">⚛️ 物理</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="统计学">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.statistics">📊 统计学</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="计算机科学">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.computer_science">💻 计算机科学</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="工程学">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.engineering">⚙️ 工程学</span>
</label>
</div>
<p class="text-xs text-gray-500 mt-2" data-i18n="exam.config.subject_filter_desc">不选择表示不限制学科</p>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="exam.config.difficulty_filter">难度筛选</label>

<!-- 基础教育难度 -->
<div class="mb-6">
<h5 class="text-sm font-medium text-gray-600 mb-3" data-i18n="exam.config.basic_education">基础教育</h5>
<div class="flex flex-wrap gap-2">
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="high_school">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.high_school">
<span class="difficulty-icon">🎓</span>高中水平
</span>
</label>
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="undergraduate_basic">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.undergraduate_basic">
<span class="difficulty-icon">📚</span>本科基础
</span>
</label>
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="undergraduate_advanced">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.undergraduate_advanced">
<span class="difficulty-icon">🎯</span>本科高级
</span>
</label>
</div>
</div>

<!-- 标准化考试难度 -->
<div class="mb-6">
<h5 class="text-sm font-medium text-gray-600 mb-3" data-i18n="exam.config.standardized_tests">标准化考试</h5>
<div class="flex flex-wrap gap-2">
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="gre_level">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.gre_level">
<span class="difficulty-icon">🎯</span>GRE难度
</span>
</label>
</div>
</div>

<!-- 学术研究难度 -->
<div class="mb-6">
<h5 class="text-sm font-medium text-gray-600 mb-3" data-i18n="exam.config.academic_research">学术研究</h5>
<div class="flex flex-wrap gap-2">
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="graduate_study">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.graduate_study">
<span class="difficulty-icon">🏛️</span>研究生水平
</span>
</label>
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="doctoral_research">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.doctoral_research">
<span class="difficulty-icon">🔬</span>博士研究
</span>
</label>
</div>
</div>

<p class="text-xs text-gray-500 mt-2" data-i18n="exam.config.difficulty_filter_desc">不选择表示不限制难度</p>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="exam.config.type_filter">题型筛选</label>
<div class="grid grid-cols-3 gap-3">
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="multiple_choice">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.multiple_choice">📝 选择题</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="short_answer">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.short_answer">📄 简答题</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="programming">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.programming">💻 编程题</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="true_false">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.true_false">✅ 判断题</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="fill_blank">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.fill_blank">📝 填空题</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="essay">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.essay">📖 论述题</span>
</label>
</div>
<p class="text-xs text-gray-500 mt-2" data-i18n="exam.config.type_filter_desc">不选择表示不限制题型</p>
</div>
</div>

<!-- 手动选择模式 -->
<div id="manualMode" class="hidden">
    <div class="mb-4">
        <button type="button" id="openManualSelectionBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i class="ri-hand-coin-line mr-2"></i>
            <span data-i18n="manual.open_selection">打开手动选择窗口</span>
        </button>
        <p class="text-sm text-gray-600 mt-2" data-i18n="manual.selection_desc">在独立窗口中进行题目筛选和选择操作</p>
    </div>
    
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <h4 class="text-md font-medium text-gray-800 mb-3" data-i18n="manual.selected_summary">已选择的题目</h4>
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600" data-i18n="manual.total_selected">总共选择:</span>
                <span id="manualSelectedCount" class="text-lg font-semibold text-blue-600">0 题</span>
            </div>
            <button type="button" id="clearAllSelectedBtn" class="px-3 py-1 text-sm text-gray-600 border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                <i class="ri-close-line mr-1"></i>
                <span data-i18n="manual.clear_all">清空所有</span>
            </button>
        </div>
    </div>
</div>

<!-- 手动选择模态窗口 -->
<div id="manualSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg w-full max-w-6xl h-[90vh] flex flex-col">
    
        <!-- 窗口头部 -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <i class="ri-hand-coin-line text-2xl text-blue-600"></i>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="manual.window_title">手动选择题目</h3>
                    <p class="text-sm text-gray-600" data-i18n="manual.window_subtitle">筛选并选择考试题目</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button type="button" id="closeManualSelectionBtn" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- 窗口内容 -->
        <div class="flex-1 overflow-hidden flex">
            <!-- 左侧筛选面板 -->
            <div class="w-80 border-r border-gray-200 p-4 bg-gray-50 overflow-y-auto">
                <h4 class="text-md font-medium text-gray-900 mb-4" data-i18n="manual.filter_conditions">筛选条件</h4>
                
                <!-- 学科筛选 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manual.subject">学科</label>
                    <select id="manualSubjectFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="" data-i18n="manual.all_subjects">所有学科</option>
                        <option value="数学">数学</option>
                        <option value="计算机科学">计算机科学</option>
                        <option value="统计学">统计学</option>
                        <option value="工程学">工程学</option>
                        <option value="英语">英语</option>
                        <option value="逻辑学">逻辑学</option>
                    </select>
                </div>
                
                <!-- 难度筛选 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manual.difficulty">难度</label>
                    <select id="manualDifficultyFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="" data-i18n="manual.all_difficulties">所有难度</option>
                        <option value="high_school">高中水平</option>
                        <option value="undergraduate_basic">本科基础</option>
                        <option value="undergraduate_advanced">本科进阶</option>
                        <option value="graduate">研究生水平</option>
                    </select>
                </div>
                
                <!-- 题型筛选 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manual.question_type">题型</label>
                    <select id="manualTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="" data-i18n="manual.all_types">所有题型</option>
                        <option value="multiple_choice">选择题</option>
                        <option value="short_answer">简答题</option>
                        <option value="programming">编程题</option>
                    </select>
                </div>
                
                <!-- 搜索框 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manual.search_content">搜索内容</label>
                    <input type="text" id="manualQuestionSearch" 
                           placeholder="输入关键词搜索题目..." 
                           data-i18n-placeholder="manual.search_placeholder"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- 操作按钮 -->
                <div class="space-y-2 mb-6">
                    <button type="button" id="searchQuestionsBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                        <i class="ri-search-line mr-2"></i>
                        <span data-i18n="manual.search">搜索题目</span>
                    </button>
                    <button type="button" id="selectAllQuestionsBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                        <i class="ri-checkbox-line mr-2"></i>
                        <span data-i18n="manual.select_all">全选当前</span>
                    </button>
                    <button type="button" id="clearSelectedBtn" class="w-full px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                        <i class="ri-close-line mr-2"></i>
                        <span data-i18n="manual.clear">清空选择</span>
                    </button>
                </div>
                
                <!-- 随机选择 -->
                <div class="border-t pt-4">
                    <h5 class="text-sm font-medium text-gray-900 mb-3" data-i18n="manual.random_selection">随机选择</h5>
                    <div class="flex items-center space-x-2 mb-2">
                        <label class="text-sm text-gray-700" data-i18n="manual.select_count">选择数量:</label>
                        <input type="number" id="randomSelectCount" min="1" max="100" value="5" 
                               class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        <span class="text-sm text-gray-600" data-i18n="manual.questions_unit">题</span>
                    </div>
                    <button type="button" id="randomSelectBtn" class="w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">
                        <i class="ri-shuffle-line mr-2"></i>
                        <span data-i18n="manual.random_select_btn">随机选取</span>
                    </button>
                </div>
                
                <!-- 购物车操作 -->
                <div class="border-t pt-4 mt-4">
                    <h5 class="text-sm font-medium text-gray-900 mb-3" data-i18n="manual.cart_operations">购物车操作</h5>
                    <div class="space-y-2">
                        <button type="button" id="addToCartBtn" class="w-full px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
                            <i class="ri-shopping-cart-line mr-2"></i>
                            <span data-i18n="manual.add_to_cart">加入购物车</span>
                        </button>
                        <button type="button" id="clearCartBtn" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                            <i class="ri-delete-bin-line mr-2"></i>
                            <span data-i18n="cart.clear">清空购物车</span>
                        </button>
                        <button type="button" id="confirmCartBtn" class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                            <i class="ri-check-line mr-2"></i>
                            <span data-i18n="cart.confirm">确认选择</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 右侧内容区域 -->
            <div class="flex-1 flex flex-col">
                <!-- 顶部状态栏 -->
                <div class="p-4 border-b border-gray-200 bg-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-6">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600" data-i18n="status.available_questions">筛选结果:</span>
                                <span id="manualAvailableCount" class="text-sm font-semibold text-blue-600">0 题</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600" data-i18n="status.selected_questions">已选择:</span>
                                <span id="manualSelectedCount" class="text-sm font-semibold text-green-600">0 题</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600" data-i18n="cart.in_cart">购物车:</span>
                                <span id="cartCount" class="text-sm font-semibold text-purple-600">0 题</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 购物车预览区域 -->
                <div class="p-4 bg-purple-50 border-b border-gray-200">
                    <h4 class="text-sm font-medium text-gray-900 mb-2" data-i18n="cart.preview">购物车预览</h4>
                    <div id="cartPreview" class="max-h-20 overflow-y-auto">
                        <div class="text-sm text-gray-500" data-i18n="cart.empty_desc">购物车为空，选择题目后点击"加入购物车"</div>
                    </div>
                </div>
                
                <!-- 题目列表 -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="manualQuestionsList">
                        <div class="text-center text-gray-500 py-12">
                            <i class="ri-search-line text-4xl mb-4 block text-gray-300"></i>
                            <h4 class="text-lg font-medium mb-2" data-i18n="questions.empty_title">准备开始筛选题目</h4>
                            <p class="text-sm text-gray-400" data-i18n="questions.empty_desc">设置筛选条件后点击"搜索题目"按钮</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 窗口底部 -->
        <div class="p-4 border-t border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <span data-i18n="manual.instruction">提示: 选择题目后加入购物车，可以跨科目收集题目，最后统一确认</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" id="closeAndConfirmBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                        <i class="ri-check-double-line mr-2"></i>
                        <span data-i18n="manual.close_and_confirm">关闭并确认</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 精确数量控制模态窗口 -->
<div id="quantityControlModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
<div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] flex flex-col shadow-2xl">

<!-- 窗口头部 -->
<div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
<div class="flex items-center space-x-3">
<div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center">
<i class="ri-settings-3-line text-white text-xl"></i>
</div>
<div>
<h3 class="text-xl font-bold text-gray-900" data-i18n="exam.config.quantity_modal_title">精确数量控制配置</h3>
<p class="text-sm text-gray-600" data-i18n="exam.config.quantity_modal_subtitle">为每个学科、难度、题型组合设置精确的题目数量</p>
</div>
</div>
<button id="closeQuantityModalBtn" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors">
<i class="ri-close-line text-2xl"></i>
</button>
</div>

<!-- 窗口内容 -->
<div class="flex-1 overflow-hidden flex">
<!-- 左侧配置面板 -->
<div class="w-80 border-r border-gray-200 bg-gray-50 flex flex-col">
<!-- 配置工具栏 -->
<div class="p-4 border-b border-gray-200 bg-white">
<h4 class="text-md font-semibold text-gray-900 mb-3" data-i18n="exam.config.quantity_tools">配置工具</h4>
<div class="space-y-2">
<button type="button" id="addQuantityConfigBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
<i class="ri-add-line mr-2"></i>
<span data-i18n="exam.config.add_quantity_config">添加数量配置</span>
</button>
<button type="button" id="autoGenerateConfigBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
<i class="ri-magic-line mr-2"></i>
<span data-i18n="exam.config.auto_generate_config">智能分配</span>
</button>
<button type="button" id="clearQuantityConfigBtn" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
<i class="ri-delete-bin-line mr-2"></i>
<span data-i18n="exam.config.clear_config">清空配置</span>
</button>
</div>
</div>

<!-- 统计信息 -->
<div class="p-4 border-b border-gray-200 bg-white">
<h4 class="text-md font-semibold text-gray-900 mb-3" data-i18n="exam.config.quantity_stats">配置统计</h4>
<div class="space-y-3">
<div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
<span class="text-sm font-medium text-blue-800" data-i18n="exam.config.configured_categories">已配置类别</span>
<span id="modalConfiguredCategoriesCount" class="text-lg font-bold text-blue-600">0</span>
</div>
<div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
<span class="text-sm font-medium text-green-800" data-i18n="exam.config.total_configured">已配置总数</span>
<span id="modalTotalConfiguredCount" class="text-lg font-bold text-green-600">0 <span data-i18n="exam.config.questions_unit">题</span></span>
</div>
<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
<span class="text-sm font-medium text-gray-800" data-i18n="exam.config.target_total">目标总数</span>
<span id="modalTargetTotalCount" class="text-lg font-bold text-gray-600">5 <span data-i18n="exam.config.questions_unit">题</span></span>
</div>
</div>
</div>

<!-- 使用说明 -->
<div class="flex-1 p-4 overflow-y-auto">
<h4 class="text-md font-semibold text-gray-900 mb-3" data-i18n="exam.config.usage_guide">使用说明</h4>
<div class="space-y-3 text-sm text-gray-600">
<div class="flex items-start space-x-2">
<span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">1</span>
<p data-i18n="exam.config.guide_step1">先在右侧主配置中选择学科、难度、题型筛选条件</p>
</div>
<div class="flex items-start space-x-2">
<span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">2</span>
<p data-i18n="exam.config.guide_step2">点击"添加数量配置"生成所有可能的组合</p>
</div>
<div class="flex items-start space-x-2">
<span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">3</span>
<p data-i18n="exam.config.guide_step3">手动调整每个组合的题目数量，或使用"智能分配"</p>
</div>
<div class="flex items-start space-x-2">
<span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">4</span>
<p data-i18n="exam.config.guide_step4">确保配置总数与目标总数一致后点击"确认配置"</p>
</div>
</div>
</div>
</div>

<!-- 右侧配置列表 -->
<div class="flex-1 flex flex-col">
<!-- 配置列表头部 -->
<div class="p-4 border-b border-gray-200 bg-white">
<div class="flex items-center justify-between">
<h4 class="text-md font-semibold text-gray-900" data-i18n="exam.config.quantity_distribution">数量分配配置</h4>
<div class="text-sm text-gray-500">
<span data-i18n="exam.config.edit_tip">点击数量输入框可直接编辑</span>
</div>
</div>
</div>

<!-- 配置列表内容 -->
<div class="flex-1 overflow-y-auto p-4">
<div id="quantityConfigList" class="space-y-3">
<!-- 空状态 -->
<div id="quantityConfigEmpty" class="text-center py-12">
<div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
<i class="ri-settings-line text-gray-400 text-2xl"></i>
</div>
<h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="exam.config.no_quantity_config">暂无数量配置</h3>
<p class="text-gray-600 mb-6" data-i18n="exam.config.quantity_help">请先选择下方的学科、难度、题型筛选条件，然后点击"添加数量配置"按钮</p>
<button type="button" onclick="document.getElementById('addQuantityConfigBtn').click()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
<i class="ri-add-line mr-2"></i>
<span data-i18n="exam.config.add_first_config">添加第一个配置</span>
</button>
</div>
</div>
</div>
</div>
</div>

<!-- 窗口底部 -->
<div class="p-6 border-t border-gray-200 bg-gray-50">
<div class="flex items-center justify-between">
<div class="text-sm text-gray-600">
<span data-i18n="exam.config.quantity_note">注意：配置总数必须与目标题目数量一致</span>
</div>
<div class="flex items-center space-x-3">
<button type="button" id="cancelQuantityConfigBtn" class="px-6 py-3 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
<span data-i18n="exam.config.cancel">取消</span>
</button>
<button type="button" id="confirmQuantityConfigBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
<i class="ri-check-line mr-2"></i>
<span data-i18n="exam.config.confirm_config">确认配置</span>
</button>
</div>
</div>
</div>
</div>
</div>

<div class="flex justify-end space-x-4 pt-6 border-t">
<button type="button" id="cancelBtn" class="px-6 py-3 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
<span data-i18n="exam.config.cancel">取消</span>
</button>
<button type="submit" id="saveBtn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
<span id="saveText" data-i18n="exam.config.save_config">保存配置</span>
</button>
</div>
</form>
</div>
</div>

<script>
// 全局变量
let currentConfigs = [];
let editingConfigId = null;
let selectedQuestions = new Set();
let availableQuestions = [];
let questionCart = new Map(); // 购物车：存储题目ID -> 题目对象的映射
let quantityDistribution = {}; // 精确数量控制配置：{学科-难度-题型: 数量}

// 消息显示函数
function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    alertDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="ri-error-warning-line"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // 3秒后自动消失
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    alertDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="ri-check-line"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // 3秒后自动消失
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// 购物车显示更新函数
function updateCartDisplay() {
    const cartCountElement = document.getElementById('cartCount');
    const cartPreviewElement = document.getElementById('cartPreview');
    
    if (!cartCountElement || !cartPreviewElement) return;
    
    const count = questionCart.size;
    cartCountElement.textContent = count;
    
    if (count === 0) {
        cartPreviewElement.innerHTML = `
            <div class="text-sm text-gray-500">购物车为空，选择题目后点击"加入购物车"</div>
        `;
    } else {
        // 按学科分组显示购物车内容
        const groupedBySubject = {};
        questionCart.forEach((question, questionId) => {
            const subject = question.addedFrom?.subject || question.subject || '未分类';
            if (!groupedBySubject[subject]) {
                groupedBySubject[subject] = [];
            }
            groupedBySubject[subject].push(question);
        });
        
        let cartHtml = '';
        Object.entries(groupedBySubject).forEach(([subject, questions]) => {
            cartHtml += `
                <div class="mb-2">
                    <div class="text-xs font-medium text-purple-700">${subject} (${questions.length}题)</div>
                    <div class="text-xs text-gray-600 pl-2">
                        ${questions.map(q => `• ${(q.content || '').substring(0, 20)}...`).join('<br>')}
                    </div>
                </div>
            `;
        });
        
        cartPreviewElement.innerHTML = cartHtml;
    }
}

// 购物车相关函数
function addSelectedToCart() {
    if (selectedQuestions.size === 0) {
        showErrorMessage('请先选择题目再加入购物车');
        return;
    }
    
    let addedCount = 0;
    selectedQuestions.forEach(questionId => {
        if (!questionCart.has(questionId)) {
            // 从availableQuestions中找到对应的题目对象
            const question = availableQuestions.find(q => q.id == questionId);
            if (question) {
                // 添加来源信息
                question.addedFrom = {
                    subject: document.getElementById('manualSubjectFilter').value || '未指定',
                    difficulty: document.getElementById('manualDifficultyFilter').value || '未指定',
                    type: document.getElementById('manualTypeFilter').value || '未指定'
                };
                questionCart.set(questionId, question);
                addedCount++;
            }
        }
    });
    
    // 清空当前选择
    selectedQuestions.clear();
    updateSelectedCount();
    updateCartDisplay();
    
    if (addedCount > 0) {
        showSuccessMessage(`已将 ${addedCount} 题加入购物车`);
    } else {
        showErrorMessage('选中的题目已在购物车中');
    }
}

function clearCart() {
    if (questionCart.size === 0) {
        showErrorMessage('购物车已为空');
        return;
    }
    
    const count = questionCart.size;
    questionCart.clear();
    updateCartDisplay();
    showSuccessMessage(`已清空购物车，移除 ${count} 题`);
}

function confirmCartSelection() {
    if (questionCart.size === 0) {
        showErrorMessage('购物车为空，无法确认选择');
        return;
    }
    
    // 将购物车中的题目ID添加到最终选择中
    selectedQuestions.clear();
    questionCart.forEach((question, questionId) => {
        selectedQuestions.add(questionId);
    });
    
    // 更新题目数量输入框
    const totalQuestions = selectedQuestions.size;
    document.getElementById('configQuestions').value = totalQuestions;
    
    // 清空购物车
    questionCart.clear();
    
    // 更新显示
    updateSelectedCount();
    updateCartDisplay();
    
    console.log('确认选择的题目ID:', Array.from(selectedQuestions)); // 调试日志
    showSuccessMessage(`已确认选择 ${totalQuestions} 题到最终题目列表，可以保存配置了`);
}

// 检查管理员权限
async function checkAdminStatus() {
    try {
        const response = await fetch('/api/admin/status');
        const result = await response.json();
        
        if (!result.success || !result.is_admin) {
            alert('请先登录管理员账户');
            window.location.href = '/admin/login';
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('检查管理员状态失败:', error);
        alert('权限验证失败，请重新登录');
        window.location.href = '/admin/login';
        return false;
    }
}

// 页面初始化
document.addEventListener('DOMContentLoaded', async function() {
// 等待多语言初始化完成
if (window.i18n && !window.i18n.initialized) {
await new Promise(resolve => {
document.addEventListener('i18n:initialized', resolve, { once: true });
});
}

// 首先检查管理员权限
if (!(await checkAdminStatus())) {
    return; // 如果权限验证失败，停止后续初始化
}

// 确保i18n系统已经完全加载后再初始化事件监听器
initEventListeners();
loadConfigs();
initializeSystemConfig();
});

// 初始化系统配置
async function initializeSystemConfig() {
try {
// 等待i18n初始化完成
if (typeof window.i18nManager !== 'undefined') {
await window.i18nManager.init();
} else {
// 如果i18n未加载，设置监听器
document.addEventListener('i18n:initialized', () => {
applySystemConfiguration();
});
}
await applySystemConfiguration();
} catch (error) {
console.error('初始化系统配置失败:', error);
}
}

// 应用系统配置
async function applySystemConfiguration() {
try {
const response = await fetch('/api/system-config');
if (response.ok) {
const result = await response.json();
const config = result.data;

// 应用logo
if (config.logo) {
const systemLogo = document.getElementById('systemLogo');
if (systemLogo) {
systemLogo.src = config.logo;
}
}

// 应用语言设置
if (config.language && window.i18nManager) {
window.i18nManager.setLanguage(config.language);
}
}
} catch (error) {
console.error('应用系统配置失败:', error);
}
}

// 初始化事件监听器
function initEventListeners() {
// 语言切换按钮由 i18n.js 自动处理，无需手动绑定

// 多语言变化事件监听
        document.addEventListener('i18n:languageChanged', () => {
            console.log('Language changed in exam config management page');
            // 语言切换按钮的文本更新现在由 i18n.js 自动处理
            // 重新加载配置列表以应用新语言
            loadConfigs();
            // 更新选择框选项
            updateSelectOptions();
            // 更新手动选择窗口的翻译
            updateManualSelectionTranslations();
        });

// 按钮事件
document.getElementById('addConfigBtn').addEventListener('click', showAddConfigModal);
document.getElementById('refreshBtn').addEventListener('click', loadConfigs);
document.getElementById('closeModalBtn').addEventListener('click', hideConfigModal);
document.getElementById('cancelBtn').addEventListener('click', hideConfigModal);
document.getElementById('configForm').addEventListener('submit', handleSaveConfig);

// 手动选择模式的事件监听器
document.getElementById('searchQuestionsBtn').addEventListener('click', loadQuestionsForManualSelection);
document.getElementById('selectAllQuestionsBtn').addEventListener('click', selectAllQuestions);
document.getElementById('clearSelectedBtn').addEventListener('click', clearSelectedQuestions);
document.getElementById('randomSelectBtn').addEventListener('click', randomSelectQuestions);
// 新的模态窗口事件监听器
document.getElementById('openManualSelectionBtn').addEventListener('click', openManualSelectionModal);
document.getElementById('closeManualSelectionBtn').addEventListener('click', closeManualSelectionModal);
document.getElementById('closeAndConfirmBtn').addEventListener('click', closeAndConfirmSelection);
document.getElementById('clearAllSelectedBtn').addEventListener('click', clearAllSelectedQuestions);

// 保留原有的手动选择模式事件监听器（在模态窗口内）
document.getElementById('searchQuestionsBtn').addEventListener('click', loadQuestionsForManualSelection);
document.getElementById('selectAllQuestionsBtn').addEventListener('click', selectAllQuestions);
document.getElementById('clearSelectedBtn').addEventListener('click', clearSelectedQuestions);
document.getElementById('randomSelectBtn').addEventListener('click', randomSelectQuestions);
document.getElementById('addToCartBtn').addEventListener('click', addSelectedToCart);
document.getElementById('clearCartBtn').addEventListener('click', clearCart);
document.getElementById('confirmCartBtn').addEventListener('click', confirmCartSelection);

// 精确数量控制相关事件监听器
document.getElementById('openQuantityConfigBtn').addEventListener('click', openQuantityControlModal);
document.getElementById('closeQuantityModalBtn').addEventListener('click', closeQuantityControlModal);
document.getElementById('cancelQuantityConfigBtn').addEventListener('click', closeQuantityControlModal);
document.getElementById('confirmQuantityConfigBtn').addEventListener('click', confirmQuantityControlConfig);
document.getElementById('addQuantityConfigBtn').addEventListener('click', addQuantityConfig);
document.getElementById('autoGenerateConfigBtn').addEventListener('click', autoGenerateQuantityConfig);
document.getElementById('clearQuantityConfigBtn').addEventListener('click', clearQuantityConfig);

// 题目数量输入框变化监听
document.getElementById('configQuestions').addEventListener('input', () => {
    updateTargetTotalCount();
    updateQuestionTypePreview();
});

// 题型选择变化监听
document.querySelectorAll('input[name="questionTypes"]').forEach(checkbox => {
    checkbox.addEventListener('change', updateQuestionTypePreview);
});

// 语言切换按钮已由 i18n.js 全局处理，无需再次绑定

// 筛选条件变化监听器
document.getElementById('manualSubjectFilter').addEventListener('change', loadQuestionsForManualSelection);
document.getElementById('manualDifficultyFilter').addEventListener('change', loadQuestionsForManualSelection);
document.getElementById('manualTypeFilter').addEventListener('change', loadQuestionsForManualSelection);
document.getElementById('manualQuestionSearch').addEventListener('input', debounce(() => {
    loadQuestionsForManualSelection();
}, 300));

// 题型名称映射函数
function getTypeName(type) {
    const typeMap = {
        'multiple_choice': '选择题',
        'short_answer': '简答题',
        'programming': '编程题',
        'true_false': '判断题',
        'fill_blank': '填空题',
        'essay': '论述题'
    };
    return typeMap[type] || type;
}

// 显示错误消息
function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    alertDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="ri-error-warning-line"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // 3秒后自动消失
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// 显示成功消息
function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    alertDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="ri-check-line"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // 3秒后自动消失
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// =============  购物车系统函数 =============

// 将已选择的题目添加到购物车
function addSelectedToCart() {
    if (selectedQuestions.size === 0) {
        showErrorMessage('请先选择题目再加入购物车');
        return;
    }
    
    let addedCount = 0;
    let duplicateCount = 0;
    
    // 将选中的题目添加到购物车
    selectedQuestions.forEach(questionId => {
        if (questionCart.has(questionId)) {
            duplicateCount++;
        } else {
            // 找到对应的题目对象
            const question = availableQuestions.find(q => q.id === questionId);
            if (question) {
                questionCart.set(questionId, {
                    ...question,
                    addedFrom: {
                        subject: document.getElementById('manualSubjectFilter').value || '未指定',
                        difficulty: document.getElementById('manualDifficultyFilter').value || '未指定',
                        type: document.getElementById('manualTypeFilter').value || '未指定'
                    }
                });
                addedCount++;
            }
        }
    });
    
    // 清空当前选择
    selectedQuestions.clear();
    updateSelectedCount();
    renderQuestionsForSelection();
    
    // 更新购物车显示
    updateCartDisplay();
    
    // 显示结果信息
    if (addedCount > 0) {
        let message = `成功加入购物车 ${addedCount} 题`;
        if (duplicateCount > 0) {
            message += `，跳过重复题目 ${duplicateCount} 题`;
        }
        showSuccessMessage(message);
    } else if (duplicateCount > 0) {
        showErrorMessage(`所选题目已在购物车中，跳过 ${duplicateCount} 题`);
    }
}

// 清空购物车
function clearCart() {
    if (questionCart.size === 0) {
        showErrorMessage('购物车已为空');
        return;
    }
    
    const count = questionCart.size;
    questionCart.clear();
    updateCartDisplay();
    showSuccessMessage(`已清空购物车，移除 ${count} 题`);
}

// 确认购物车选择（将购物车内容应用到最终选择）
function confirmCartSelection() {
    if (questionCart.size === 0) {
        showErrorMessage('购物车为空，无法确认选择');
        return;
    }
    
    // 将购物车中的题目ID添加到最终选择中
    selectedQuestions.clear();
    questionCart.forEach((question, questionId) => {
        selectedQuestions.add(questionId);
    });
    
    // 更新题目数量输入框
    const totalQuestions = selectedQuestions.size;
    document.getElementById('configQuestions').value = totalQuestions;
    
    // 清空购物车
    questionCart.clear();
    
    // 更新显示
    updateSelectedCount();
    updateCartDisplay();
    
    console.log('确认选择的题目ID:', Array.from(selectedQuestions)); // 调试日志
    showSuccessMessage(`已确认选择 ${totalQuestions} 题到最终题目列表，可以保存配置了`);
}

// 更新购物车显示
function updateCartDisplay() {
    const cartCountElement = document.getElementById('cartCount');
    const cartPreviewElement = document.getElementById('cartPreview');
    
    const cartSize = questionCart.size;
    if (cartCountElement) cartCountElement.textContent = cartSize;
    
    if (!cartPreviewElement) return;
    
    if (cartSize === 0) {
        const emptyText = window.i18n && window.i18n.initialized 
            ? window.i18n.translate('cart.empty_desc', '购物车为空，选择题目后点击"加入购物车"')
            : '购物车为空，选择题目后点击"加入购物车"';
            
        cartPreviewElement.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                <i class="ri-shopping-cart-line text-2xl mb-1 block"></i>
                <div class="text-xs">${emptyText}</div>
            </div>
        `;
    } else {
        // 按科目分组显示购物车内容
        const groupedBySubject = {};
        questionCart.forEach((question, questionId) => {
            const subject = question.addedFrom?.subject || question.subject || '未分类';
            if (!groupedBySubject[subject]) {
                groupedBySubject[subject] = [];
            }
            groupedBySubject[subject].push(question);
        });
        
        const questionsUnit = window.i18n && window.i18n.initialized
            ? window.i18n.translate('manual.questions_unit', '题')
            : '题';
        
        let cartHtml = '';
        Object.keys(groupedBySubject).forEach(subject => {
            const questions = groupedBySubject[subject];
            cartHtml += `
                <div class="mb-2 p-2 bg-white rounded border border-blue-100">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-medium text-blue-700">${subject}</span>
                        <span class="text-xs text-blue-600">${questions.length}${questionsUnit}</span>
                    </div>
                    <div class="text-xs text-gray-600">
                        ${questions.map(q => {
                            const content = (q.content || '').length > 30 ? (q.content || '').substring(0, 30) + '...' : (q.content || '');
                            return `• ${content}`;
                        }).join('<br>')}
                    </div>
                </div>
            `;
        });
        
        cartPreviewElement.innerHTML = cartHtml;
    }
}

// 更新手动选择窗口的翻译
function updateManualSelectionTranslations() {
    if (!window.i18n || !window.i18n.initialized) return;
    
    // 更新选择框选项的翻译
    const subjectOptions = document.querySelectorAll('#manualSubjectFilter option');
    subjectOptions.forEach(option => {
        if (option.value === '') {
            option.textContent = window.i18n.translate('manual.all_subjects', '所有学科');
        }
    });
    
    const difficultyOptions = document.querySelectorAll('#manualDifficultyFilter option');
    difficultyOptions.forEach(option => {
        if (option.value === '') {
            option.textContent = window.i18n.translate('manual.all_difficulties', '所有难度');
        }
    });
    
    const typeOptions = document.querySelectorAll('#manualTypeFilter option');
    typeOptions.forEach(option => {
        if (option.value === '') {
            option.textContent = window.i18n.translate('manual.all_types', '所有题型');
        }
    });
    
    // 更新购物车显示
    updateCartDisplay();
}

// 更新购物车显示的翻译文本
function updateCartDisplayTranslations() {
    const cartPreviewElement = document.getElementById('cartPreview');
    if (!cartPreviewElement || !window.i18n) return;
    
    if (questionCart.size === 0) {
        cartPreviewElement.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                <i class="ri-shopping-cart-line text-2xl mb-1 block"></i>
                <div class="text-xs">${window.i18n.translate('cart.empty_desc', '购物车为空，选择题目后点击"加入购物车"')}</div>
            </div>
        `;
    }
}

// 页面专用的手动选择窗口翻译更新（简化版）
function updateManualWindowTranslations() {
    if (!window.i18n || !window.i18n.initialized) return;
    
    // 更新空状态文本
    const emptyStates = document.querySelectorAll('#manualQuestionsList .text-center');
    emptyStates.forEach(state => {
        if (state.textContent.includes('准备开始筛选题目')) {
            state.querySelector('h4').textContent = window.i18n.translate('questions.empty_title', '准备开始筛选题目');
            state.querySelector('p').textContent = window.i18n.translate('questions.empty_desc', '设置筛选条件后点击"搜索题目"按钮');
        }
    });
    
    // 更新购物车显示翻译
    updateCartDisplayTranslations();
}

// 开打手动选择模态窗口时更新翻译
function ensureManualModalTranslations() {
    // 确保模态窗口打开时更新翻译
    setTimeout(() => {
        updateManualSelectionTranslations();
        updateManualWindowTranslations();
    }, 100);
}

// 手动选择模态窗口相关函数
function openManualSelectionModal() {
    const modal = document.getElementById('manualSelectionModal');
    modal.classList.remove('hidden');
    
    // 清空之前的搜索结果
    const questionsList = document.getElementById('manualQuestionsList');
    questionsList.innerHTML = `
        <div class="text-center text-gray-500 py-12">
            <i class="ri-search-line text-4xl mb-4 block text-gray-300"></i>
            <h4 class="text-lg font-medium mb-2" data-i18n="questions.empty_title">准备开始筛选题目</h4>
            <p class="text-sm text-gray-400" data-i18n="questions.empty_desc">设置筛选条件后点击"搜索题目"按钮</p>
        </div>
    `;
    
    // 确保模态窗口打开时更新翻译
    ensureManualModalTranslations();
}

function closeManualSelectionModal() {
    const modal = document.getElementById('manualSelectionModal');
    modal.classList.add('hidden');
}

function closeAndConfirmSelection() {
    // 先确认购物车中的选择
    if (questionCart.size > 0) {
        confirmCartSelection();
    }
    // 然后关闭模态窗口
    closeManualSelectionModal();
}

function clearAllSelectedQuestions() {
    if (confirm('确定要清空所有已选择的题目吗？')) {
        selectedQuestions.clear();
        questionCart.clear();
        updateSelectedCount();
        updateCartDisplay();
        // 更新主界面显示
        const mainSelectedCount = document.querySelector('#manualMode #manualSelectedCount');
        if (mainSelectedCount) {
            mainSelectedCount.textContent = '0 题';
        }
        showSuccessMessage('已清空所有选择');
    }
}

// 登出
document.getElementById('logoutBtn').addEventListener('click', handleLogout);
}

// 更新select选项的翻译
function updateSelectOptions() {
if (!window.i18n || !window.i18n.initialized) return;

// 更新题目选择模式的选项
const questionSelectionMode = document.getElementById('questionSelectionMode');
if (questionSelectionMode) {
const filterOption = questionSelectionMode.querySelector('option[value="filter"]');
const manualOption = questionSelectionMode.querySelector('option[value="manual"]');
if (filterOption) filterOption.textContent = window.i18n.translate('exam.config.filter_mode', '筛选模式');
if (manualOption) manualOption.textContent = window.i18n.translate('exam.config.manual_mode', '手动选择');
}
}

// 加载配置列表
async function loadConfigs() {
try {
showLoading(true);
const response = await fetch('/api/exam-configs');
const result = await response.json();

if (result.success) {
currentConfigs = result.configs;
updateConfigsList(result.configs);
updateStatistics(result.configs);
showLoading(false);
} else {
showError('加载配置失败: ' + result.message);
showLoading(false);
}
} catch (error) {
console.error('加载配置失败:', error);
showError('加载配置失败，请重试');
showLoading(false);
}
}

// 显示/隐藏加载状态
function showLoading(show) {
const loadingState = document.getElementById('loadingState');
const configsContainer = document.getElementById('configsContainer');
const emptyState = document.getElementById('emptyState');

if (show) {
loadingState.classList.remove('hidden');
configsContainer.classList.add('hidden');
emptyState.classList.add('hidden');
} else {
loadingState.classList.add('hidden');
configsContainer.classList.remove('hidden');
}
}

// 更新统计信息
function updateStatistics(configs) {
const totalConfigs = configs.length;
const activeConfigs = configs.filter(c => c.is_active).length;
const defaultConfig = configs.find(c => c.is_default);
const showResultsCount = configs.filter(c => c.show_results !== false).length;

document.getElementById('totalConfigs').textContent = totalConfigs;
document.getElementById('activeConfigs').textContent = activeConfigs;
document.getElementById('defaultConfigName').textContent = defaultConfig ? defaultConfig.name : '无';
document.getElementById('showResultsCount').textContent = showResultsCount;
document.getElementById('totalCount').textContent = totalConfigs;
}

// 更新配置列表
function updateConfigsList(configs) {
const container = document.getElementById('configsContainer');
const emptyState = document.getElementById('emptyState');

if (configs.length === 0) {
container.classList.add('hidden');
emptyState.classList.remove('hidden');
return;
}

container.classList.remove('hidden');
emptyState.classList.add('hidden');

container.innerHTML = configs.map(config => `
<div class="config-card card p-6 ${config.is_default ? 'default' : ''} ${!config.is_active ? 'inactive' : ''}">
<div class="flex items-start justify-between">
<div class="flex-1">
<div class="flex items-center space-x-3 mb-3">
<h3 class="text-lg font-semibold text-gray-900">${config.name}</h3>
            ${config.is_default ? `<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.current', '当前配置') : '当前配置'}</span>` : ''}
${config.is_active ? `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.active', '已启用') : '已启用'}</span>` : `<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.inactive', '未启用') : '未启用'}</span>`}
${config.show_results !== false ? `<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.show_results', '显示成绩') : '显示成绩'}</span>` : `<span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.hide_results', '不显示成绩') : '不显示成绩'}</span>`}
</div>
<p class="text-sm text-gray-600 mb-4">${config.description || '暂无描述'}</p>

<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-lg font-semibold text-gray-900">${config.total_questions}</div>
<div class="text-xs text-gray-600">${window.i18n ? window.i18n.translate('exam.config.question_count_short', '题目数量') : '题目数量'}</div>
</div>
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-lg font-semibold text-gray-900">${config.time_limit}${window.i18n ? window.i18n.translate('exam.config.minutes', '分') : '分'}</div>
<div class="text-xs text-gray-600">${window.i18n ? window.i18n.translate('exam.config.time_limit_short', '时间限制') : '时间限制'}</div>
</div>
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-sm font-medium text-gray-900">${config.subject_filter || (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.no_limit', '不限制') : '不限制')}</div>
<div class="text-xs text-gray-600">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.subject_filter', '学科筛选') : '学科筛选'}</div>
</div>
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-sm font-medium text-gray-900">${formatDifficultyFilter(config.difficulty_filter)}</div>
<div class="text-xs text-gray-600">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.difficulty_filter', '难度筛选') : '难度筛选'}</div>
</div>
</div>
</div>

<div class="flex flex-col space-y-2 ml-4">
<!-- 快速操作按钮 -->
<div class="flex space-x-2">
<button onclick="editConfig(${config.id})" class="action-button bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm">
<i class="ri-edit-line mr-1"></i>${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.edit', '编辑') : '编辑'}
</button>
                <button onclick="toggleDefault(${config.id})" class="action-button ${config.is_default ? 'bg-gray-500' : 'bg-green-500'} text-white px-4 py-2 rounded-lg hover:opacity-80 text-sm">
                <i class="ri-star-line mr-1"></i>${config.is_default ? 
                    (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.unset_current', '取消当前配置') : '取消当前配置') : 
                    (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.set_current', '设为当前配置') : '设为当前配置')
                }
                </button>
</div>
<div class="flex space-x-2">
<button onclick="toggleActive(${config.id})" class="action-button ${config.is_active ? 'bg-orange-500' : 'bg-green-500'} text-white px-4 py-2 rounded-lg hover:opacity-80 text-sm">
<i class="ri-toggle-line mr-1"></i>${config.is_active ? 
                    (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.disable', '禁用') : '禁用') : 
                    (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.enable', '启用') : '启用')
                }
</button>
<button onclick="deleteConfig(${config.id})" class="action-button bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">
<i class="ri-delete-bin-line mr-1"></i>${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.delete', '删除') : '删除'}
</button>
</div>
</div>
</div>

<div class="text-xs text-gray-500 mt-4 pt-4 border-t">
${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.created_time', '创建时间') : '创建时间'}：${formatDate(config.created_at)}
</div>
</div>
`).join('');
}

// 快速切换默认配置
async function toggleDefault(configId) {
try {
const config = currentConfigs.find(c => c.id === configId);
const newDefaultState = !config.is_default;

const response = await fetch(`/api/exam-configs/${configId}`, {
method: 'PUT',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ is_default: newDefaultState })
});

const result = await response.json();
        if (result.success) {
        showSuccess(newDefaultState ? 
            (window.i18n ? window.i18n.translate('exam.config.set_as_current_success', '已设为当前考试配置') : '已设为当前考试配置') : 
            (window.i18n ? window.i18n.translate('exam.config.unset_current_success', '已取消当前考试配置') : '已取消当前考试配置'));
        loadConfigs(); // 重新加载配置列表
        } else {
showError('操作失败: ' + result.message);
}
} catch (error) {
console.error('切换默认配置失败:', error);
showError('操作失败，请重试');
}
}

// 快速切换启用状态
async function toggleActive(configId) {
try {
const config = currentConfigs.find(c => c.id === configId);
const newActiveState = !config.is_active;

const response = await fetch(`/api/exam-configs/${configId}`, {
method: 'PUT',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ is_active: newActiveState })
});

const result = await response.json();
if (result.success) {
showSuccess(newActiveState ? '配置已启用' : '配置已禁用');
loadConfigs(); // 重新加载配置列表
} else {
showError('操作失败: ' + result.message);
}
} catch (error) {
console.error('切换配置状态失败:', error);
showError('操作失败，请重试');
}
}

// 显示添加配置模态框
function showAddConfigModal() {
editingConfigId = null;
document.getElementById('modalTitle').textContent = window.i18n ? window.i18n.translate('exam.config.modal_title', '新建考试配置') : '新建考试配置';
document.getElementById('saveText').textContent = window.i18n ? window.i18n.translate('exam.config.save_config', '保存配置') : '保存配置';

// 重置表单
document.getElementById('configForm').reset();
document.getElementById('configQuestions').value = 5;
document.getElementById('configTimeLimit').value = 75;
document.getElementById('configPassingScore').value = 60;
document.getElementById('configIsActive').checked = true;
document.getElementById('configShowResults').checked = true;
document.getElementById('questionSelectionMode').value = 'filter';

// 重置精确数量控制
document.getElementById('enableQuantityControl').checked = false;
quantityDistribution = {};
toggleQuantityControl();

// 重置题目选择
selectedQuestions.clear();
updateSelectedCount();
toggleQuestionSelectionMode();

// 清除所有筛选条件
document.querySelectorAll('.subject-filter, .difficulty-filter, .type-filter').forEach(checkbox => {
checkbox.checked = false;
});

document.getElementById('configModal').classList.remove('hidden');
}

// 编辑配置
async function editConfig(configId) {
const config = currentConfigs.find(c => c.id === configId);
if (!config) return;

editingConfigId = configId;
document.getElementById('modalTitle').textContent = '编辑配置';
document.getElementById('saveText').textContent = '更新配置';

// 填充基本表单
document.getElementById('configName').value = config.name;
document.getElementById('configDescription').value = config.description || '';
document.getElementById('configQuestions').value = config.total_questions;
document.getElementById('configTimeLimit').value = config.time_limit;
document.getElementById('configPassingScore').value = config.passing_score || 60;
document.getElementById('configIsDefault').checked = config.is_default;
document.getElementById('configIsActive').checked = config.is_active;
document.getElementById('configShowResults').checked = config.show_results !== false;
document.getElementById('questionSelectionMode').value = config.question_selection_mode || 'filter';

// 加载精确数量控制配置
document.getElementById('enableQuantityControl').checked = config.enable_quantity_control || false;
quantityDistribution = config.quantity_distribution || {};
toggleQuantityControl();
updateQuantityConfigDisplay();

// 重置题目选择
selectedQuestions.clear();

// 如果是手动选择模式，加载选中的题目
if (config.question_selection_mode === 'manual') {
try {
    const response = await fetch(`/api/exam-configs/${configId}/questions`);
    const result = await response.json();
    if (result.success && result.questions) {
        result.questions.forEach(cq => {
            if (cq.question_id) {
                selectedQuestions.add(cq.question_id);
            }
        });
    }
} catch (error) {
    console.error('加载配置题目失败:', error);
}
}

// 设置题目选择模式
toggleQuestionSelectionMode();
updateSelectedCount();

// 设置筛选条件
const subjects = config.subject_filter ? config.subject_filter.split(',').map(s => s.trim()) : [];
document.querySelectorAll('.subject-filter').forEach(checkbox => {
checkbox.checked = subjects.includes(checkbox.value);
});

const difficulties = config.difficulty_filter ? config.difficulty_filter.split(',').map(d => d.trim()) : [];
document.querySelectorAll('.difficulty-filter').forEach(checkbox => {
checkbox.checked = difficulties.includes(checkbox.value);
});

const types = config.type_filter ? config.type_filter.split(',').map(t => t.trim()) : [];
document.querySelectorAll('.type-filter').forEach(checkbox => {
checkbox.checked = types.includes(checkbox.value);
});

document.getElementById('configModal').classList.remove('hidden');
}

// 隐藏配置模态框
function hideConfigModal() {
document.getElementById('configModal').classList.add('hidden');
editingConfigId = null;
selectedQuestions.clear();
questionCart.clear(); // 清空购物车
updateSelectedCount();
updateCartDisplay();
}

// 题目选择模式切换
function toggleQuestionSelectionMode() {
const mode = document.getElementById('questionSelectionMode').value;
const filterMode = document.getElementById('filterMode');
const manualMode = document.getElementById('manualMode');
const questionSectionTitle = document.getElementById('questionSectionTitle');

if (mode === 'manual') {
    filterMode.classList.add('hidden');
    manualMode.classList.remove('hidden');
    questionSectionTitle.textContent = '精确选择题目';
    // 自动加载题目列表
    loadQuestionsForManualSelection();
    // 初始化购物车显示
    updateCartDisplay();
} else {
    filterMode.classList.remove('hidden');
    manualMode.classList.add('hidden');
    questionSectionTitle.textContent = '题目筛选';
    selectedQuestions.clear();
    updateSelectedCount();
}
}

// 加载题目用于手动选择
async function loadQuestionsForManualSelection() {
try {
    showQuestionsLoading();
    
    const params = new URLSearchParams();
    
    // 只添加非空的参数
    const subject = document.getElementById('manualSubjectFilter').value;
    const difficulty = document.getElementById('manualDifficultyFilter').value;
    const type = document.getElementById('manualTypeFilter').value;
    const search = document.getElementById('manualQuestionSearch').value;
    
    if (subject) params.append('subject', subject);
    if (difficulty) params.append('difficulty', difficulty);
    if (type) params.append('type', type);
    if (search) params.append('search', search);
    params.append('is_active', 'true');
    params.append('per_page', '100'); // 增加每页数量以便筛选

    const response = await fetch(`/api/questions?${params}`);
    const result = await response.json();

    if (result.success) {
        availableQuestions = result.questions;
        renderQuestionsForSelection();
    } else {
        showErrorMessage('加载题目失败: ' + result.message);
    }
} catch (error) {
    console.error('加载题目失败:', error);
    showErrorMessage('加载题目失败，请重试');
} finally {
    hideQuestionsLoading();
}
}

// 显示题目加载状态
function showQuestionsLoading() {
const container = document.getElementById('manualQuestionsList');
container.innerHTML = `
    <div class="text-center text-gray-500 py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-3"></div>
        <div class="text-sm">正在加载题目...</div>
    </div>
`;
}

// 隐藏题目加载状态
function hideQuestionsLoading() {
// 加载状态会在renderQuestionsForSelection中被替换
}

// 渲染题目选择列表
function renderQuestionsForSelection() {
const container = document.getElementById('manualQuestionsList');
container.innerHTML = '';

// 更新可用题目数量显示
const availableCountElement = document.getElementById('manualAvailableCount');
if (availableCountElement) {
    availableCountElement.textContent = `筛选结果: ${availableQuestions.length} 题`;
}

// 智能调整随机选取数量的建议值
const randomCountInput = document.getElementById('randomSelectCount');
if (randomCountInput && availableQuestions.length > 0) {
    const currentValue = parseInt(randomCountInput.value) || 5;
    const maxValue = Math.min(availableQuestions.length, 100);
    randomCountInput.max = maxValue;
    
    // 如果当前值超过可用数量，自动调整为建议值
    if (currentValue > availableQuestions.length) {
        const suggestedValue = Math.min(Math.max(Math.floor(availableQuestions.length * 0.3), 1), availableQuestions.length);
        randomCountInput.value = suggestedValue;
    }
    
    // 更新提示文本
    randomCountInput.title = `输入要随机选择的题目数量 (最多${maxValue}题)`;
}

if (availableQuestions.length === 0) {
    const noQuestionsText = window.i18n && window.i18n.initialized
        ? window.i18n.translate('questions.no_questions', '暂无题目')
        : '暂无题目';
    const adjustFilterText = window.i18n && window.i18n.initialized
        ? window.i18n.translate('questions.adjust_filter', '请调整筛选条件或添加新题目')
        : '请调整筛选条件或添加新题目';
        
    container.innerHTML = `
        <div class="text-center text-gray-500 py-8">
            <i class="ri-question-line text-3xl mb-3 block"></i>
            <div class="text-sm">${noQuestionsText}</div>
            <div class="text-xs text-gray-400 mt-1">${adjustFilterText}</div>
        </div>
    `;
    return;
}

availableQuestions.forEach(question => {
    const isSelected = selectedQuestions.has(question.id);
    const questionDiv = document.createElement('div');
    questionDiv.className = `group p-3 border rounded-lg cursor-pointer transition-all duration-200 ${
        isSelected 
        ? 'border-primary bg-blue-50 shadow-sm' 
        : 'border-gray-200 hover:border-gray-300 hover:shadow-sm'
    }`;
    questionDiv.onclick = (e) => {
        if (e.target.type === 'checkbox') return;
        toggleQuestionSelection(question.id);
    };
    
    questionDiv.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-shrink-0 mt-1">
                <input type="checkbox" ${isSelected ? 'checked' : ''} 
                onchange="toggleQuestionSelection(${question.id})"
                class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded transition-colors">
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-gray-900 leading-relaxed mb-2" title="${question.content}">
                    ${question.content.length > 120 ? question.content.substring(0, 120) + '...' : question.content}
                </div>
                <div class="flex flex-wrap gap-2 mb-2">
                    <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${question.subject}</span>
                    <span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">${question.difficulty}</span>
                    <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">${getTypeName(question.question_type || question.type)}</span>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${window.i18n && window.i18n.initialized ? window.i18n.translate('question.points', '分值') : '分值'}: ${question.points || 1}${window.i18n && window.i18n.initialized ? window.i18n.translate('question.points_unit', '分') : '分'}</span>
                    ${isSelected ? `<span class="text-primary font-medium"><i class="ri-check-line mr-1"></i>${window.i18n && window.i18n.initialized ? window.i18n.translate('question.selected', '已选择') : '已选择'}</span>` : ''}
                </div>
            </div>
        </div>
    `;
    container.appendChild(questionDiv);
});

updateSelectedCount();
}

// 切换题目选择状态
function toggleQuestionSelection(questionId) {
if (selectedQuestions.has(questionId)) {
    selectedQuestions.delete(questionId);
} else {
    selectedQuestions.add(questionId);
}
updateSelectedCount();
renderQuestionsForSelection();
}

// 全选题目
function selectAllQuestions() {
availableQuestions.forEach(question => {
    selectedQuestions.add(question.id);
});
updateSelectedCount();
renderQuestionsForSelection();
}

// 清空选择
function clearSelectedQuestions() {
selectedQuestions.clear();
updateSelectedCount();
renderQuestionsForSelection();
}

// 随机选取指定数量的题目
function randomSelectQuestions() {
    const countInput = document.getElementById('randomSelectCount');
    const requestedCount = parseInt(countInput.value) || 5;
    
    if (availableQuestions.length === 0) {
        showErrorMessage('请先搜索题目再使用随机选取功能');
        return;
    }
    
    if (requestedCount > availableQuestions.length) {
        showErrorMessage(`要求选择${requestedCount}题，但筛选结果只有${availableQuestions.length}题。请减少数量或调整筛选条件。`);
        return;
    }
    
    if (requestedCount <= 0) {
        showErrorMessage('选择数量必须大于0');
        return;
    }
    
    // 清空当前选择
    selectedQuestions.clear();
    
    // 创建可用题目ID的副本并随机打乱
    const shuffledQuestionIds = [...availableQuestions.map(q => q.id)];
    
    // Fisher-Yates 洗牌算法
    for (let i = shuffledQuestionIds.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledQuestionIds[i], shuffledQuestionIds[j]] = [shuffledQuestionIds[j], shuffledQuestionIds[i]];
    }
    
    // 选择前 requestedCount 个题目
    for (let i = 0; i < requestedCount; i++) {
        selectedQuestions.add(shuffledQuestionIds[i]);
    }
    
    // 更新显示
    updateSelectedCount();
    renderQuestionsForSelection();
    
    // 显示成功信息
    showSuccessMessage(`已随机选择${requestedCount}题（从${availableQuestions.length}题中选取），点击"加入购物车"以保存选择`);
}

// 更新已选择题目计数
function updateSelectedCount() {
    const count = selectedQuestions.size;
    const questionsUnit = window.i18n && window.i18n.initialized
        ? window.i18n.translate('manual.questions_unit', '题')
        : '题';
    
    // 更新模态窗口内的计数显示
    const modalSelectedCountElements = document.querySelectorAll('#manualSelectedCount');
    modalSelectedCountElements.forEach(element => {
        element.textContent = `${count} ${questionsUnit}`;
        if (count > 0) {
            element.className = 'text-sm font-semibold text-green-600';
        } else {
            element.className = 'text-sm font-semibold text-gray-500';
        }
    });
    
    // 更新主界面中的计数显示
    const mainSelectedCount = document.querySelector('#manualMode .text-blue-600');
    if (mainSelectedCount && (mainSelectedCount.textContent.includes('题') || mainSelectedCount.textContent.includes('question'))) {
        mainSelectedCount.textContent = `${count} ${questionsUnit}`;
        if (count > 0) {
            mainSelectedCount.className = 'text-lg font-semibold text-blue-600';
        } else {
            mainSelectedCount.className = 'text-lg font-semibold text-gray-500';
        }
    }

    // 同步更新题目数量输入框
    if (count > 0) {
        document.getElementById('configQuestions').value = count;
    }
}

// 获取题目类型名称
function getTypeName(type) {
    if (window.i18n && window.i18n.initialized) {
        const typeTranslations = {
            'multiple_choice': window.i18n.translate('exam.config.type.multiple_choice', '选择题'),
            'short_answer': window.i18n.translate('exam.config.type.short_answer', '简答题'),
            'programming': window.i18n.translate('exam.config.type.programming', '编程题'),
            'true_false': window.i18n.translate('exam.config.type.true_false', '判断题'),
            'fill_blank': window.i18n.translate('exam.config.type.fill_blank', '填空题'),
            'essay': window.i18n.translate('exam.config.type.essay', '论述题')
        };
        return typeTranslations[type] || type;
    } else {
        const names = {
            'multiple_choice': '选择题',
            'short_answer': '简答题',
            'programming': '编程题',
            'true_false': '判断题',
            'fill_blank': '填空题',
            'essay': '论述题'
        };
        return names[type] || type;
    }
}

// 防抖函数
function debounce(func, wait) {
let timeout;
return function executedFunction(...args) {
    const later = () => {
        clearTimeout(timeout);
        func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
};
}

// 处理保存配置
async function handleSaveConfig(e) {
e.preventDefault();

const saveBtn = document.getElementById('saveBtn');
const originalText = saveBtn.innerHTML;
saveBtn.disabled = true;
saveBtn.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>保存中...';

try {
const questionSelectionMode = document.getElementById('questionSelectionMode').value;

// 验证手动选择模式下是否选择了题目
if (questionSelectionMode === 'manual' && selectedQuestions.size === 0) {
    console.log('手动选择模式验证失败:', {
        questionSelectionMode,
        selectedQuestionsSize: selectedQuestions.size,
        selectedQuestionsArray: Array.from(selectedQuestions)
    });
    showErrorMessage('手动选择模式下必须至少选择一道题目。请先从购物车确认选择题目。');
    return;
}

// 验证精确数量控制配置
if (document.getElementById('enableQuantityControl').checked) {
    const totalConfigured = Object.values(quantityDistribution).reduce((sum, count) => sum + count, 0);
    const targetTotal = parseInt(document.getElementById('configQuestions').value);
    
    if (Object.keys(quantityDistribution).length === 0) {
        showErrorMessage('启用精确数量控制后必须添加至少一个数量配置');
        return;
    }
    
    if (totalConfigured !== targetTotal) {
        showErrorMessage(`精确数量控制配置总数（${totalConfigured}题）与目标总数（${targetTotal}题）不匹配，请调整配置`);
        return;
    }
}

const subjects = Array.from(document.querySelectorAll('.subject-filter:checked')).map(cb => cb.value);
const difficulties = Array.from(document.querySelectorAll('.difficulty-filter:checked')).map(cb => cb.value);
const types = Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);

const configData = {
name: document.getElementById('configName').value,
description: document.getElementById('configDescription').value,
total_questions: parseInt(document.getElementById('configQuestions').value),
time_limit: parseInt(document.getElementById('configTimeLimit').value),
subject_filter: subjects.join(','),
difficulty_filter: difficulties.join(','),
type_filter: types.join(','),
is_default: document.getElementById('configIsDefault').checked,
is_active: document.getElementById('configIsActive').checked,
show_results: document.getElementById('configShowResults').checked,
question_selection_mode: questionSelectionMode,
passing_score: parseFloat(document.getElementById('configPassingScore').value) || 60.0,
enable_quantity_control: document.getElementById('enableQuantityControl').checked,
quantity_distribution: quantityDistribution
};

// 如果是手动选择模式，添加选中的题目ID
if (questionSelectionMode === 'manual') {
    configData.question_ids = Array.from(selectedQuestions);
    console.log('手动选择模式保存数据:', {
        selectedQuestionsSize: selectedQuestions.size,
        questionIds: configData.question_ids,
        totalQuestions: configData.total_questions
    });
}

let response;
if (editingConfigId) {
response = await fetch(`/api/exam-configs/${editingConfigId}`, {
method: 'PUT',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(configData)
});
} else {
response = await fetch('/api/exam-configs', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(configData)
});
}

const result = await response.json();
if (result.success) {
showSuccess(editingConfigId ? '配置更新成功！' : '配置创建成功！');
hideConfigModal();
loadConfigs(); // 重新加载配置列表
} else {
showError('保存失败: ' + result.message);
}
} catch (error) {
console.error('保存配置失败:', error);
showError('保存失败，请重试');
} finally {
saveBtn.disabled = false;
saveBtn.innerHTML = originalText;
}
}

// 删除配置
async function deleteConfig(configId) {
const config = currentConfigs.find(c => c.id === configId);
if (!config) return;

if (!confirm(`确定要删除配置"${config.name}"吗？此操作不可恢复！`)) {
return;
}

try {
const response = await fetch(`/api/exam-configs/${configId}`, {
method: 'DELETE',
headers: { 'Content-Type': 'application/json' }
});

const result = await response.json();
if (result.success) {
showSuccess('配置删除成功！');
loadConfigs();
} else {
showError('删除失败: ' + result.message);
}
} catch (error) {
console.error('删除配置失败:', error);
showError('删除失败，请重试');
}
}

// 处理登出
function handleLogout() {
if (confirm('确定要退出登录吗？')) {
fetch('/api/admin/logout', { method: 'POST' })
.then(() => {
window.location.href = '/admin/login';
})
.catch(() => {
window.location.href = '/admin/login';
});
}
}

// 工具函数
function formatDate(dateString) {
return new Date(dateString).toLocaleString('zh-CN');
}

// 将难度筛选值转换为美观的标签显示
function formatDifficultyFilter(difficultyFilter) {
if (!difficultyFilter) {
    return '<span class="text-gray-500">不限制</span>';
}

const difficultyMap = {
    'high_school': { icon: '🎓', name: '高中水平', color: 'bg-blue-100 text-blue-800' },
    'undergraduate_basic': { icon: '📚', name: '本科基础', color: 'bg-green-100 text-green-800' },
    'undergraduate_advanced': { icon: '🎯', name: '本科进阶', color: 'bg-purple-100 text-purple-800' },
    'graduate': { icon: '🏛️', name: '研究生水平', color: 'bg-indigo-100 text-indigo-800' }
};

const difficulties = difficultyFilter.split(',').map(d => d.trim()).filter(d => d);

if (difficulties.length === 0) {
    return '<span class="text-gray-500">不限制</span>';
}

const tags = difficulties.map(difficulty => {
    const info = difficultyMap[difficulty];
    if (!info) return null;
    return `<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ${info.color}">
        <span class="mr-1">${info.icon}</span>${info.name}
    </span>`;
}).filter(tag => tag);

return tags.length > 0 ? tags.join(' ') : '<span class="text-gray-500">不限制</span>';
}

function showSuccess(message) {
showMessage(message, 'success');
}

function showError(message) {
showMessage(message, 'error');
}

function showMessage(message, type) {
const container = document.getElementById('messageContainer');
const messageId = 'msg-' + Date.now();

const messageDiv = document.createElement('div');
messageDiv.id = messageId;
messageDiv.className = `mb-4 p-4 rounded-lg shadow-lg transition-all duration-300 ${
type === 'success' 
? 'bg-green-100 border border-green-200 text-green-800' 
: 'bg-red-100 border border-red-200 text-red-800'
}`;

messageDiv.innerHTML = `
<div class="flex items-center">
<i class="ri-${type === 'success' ? 'check-circle' : 'error-warning'}-line mr-2"></i>
<span>${message}</span>
<button onclick="document.getElementById('${messageId}').remove()" class="ml-auto text-current opacity-70 hover:opacity-100">
<i class="ri-close-line"></i>
</button>
</div>
`;

container.appendChild(messageDiv);

// 自动删除消息
setTimeout(() => {
const msg = document.getElementById(messageId);
if (msg) {
msg.style.opacity = '0';
msg.style.transform = 'translateX(100%)';
setTimeout(() => msg.remove(), 300);
}
}, 5000);
}

// ==================== 精确数量控制功能 ====================

// 切换精确数量控制
function toggleQuantityControl() {
    const isEnabled = document.getElementById('enableQuantityControl').checked;
    const statusSection = document.getElementById('quantityConfigStatus');
    
    if (isEnabled) {
        statusSection.classList.remove('hidden');
        updateQuantityConfigDisplay();
        updateTargetTotalCount();
        updateQuestionTypePreview();
    } else {
        statusSection.classList.add('hidden');
        quantityDistribution = {};
        updateQuantityConfigDisplay();
        updateQuestionTypePreview();
    }
}

// 打开精确数量控制模态窗口
function openQuantityControlModal() {
    const modal = document.getElementById('quantityControlModal');
    modal.classList.remove('hidden');
    
    // 同步目标总数到模态窗口
    updateModalTargetCount();
    updateQuantityConfigDisplay();
    
    // 确保模态窗口打开时更新翻译
    setTimeout(() => {
        if (window.i18n && window.i18n.initialized) {
            // 触发翻译更新
            const elements = modal.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (window.i18n.translations[window.i18n.currentLanguage] && 
                    window.i18n.translations[window.i18n.currentLanguage][key]) {
                    element.textContent = window.i18n.translations[window.i18n.currentLanguage][key];
                }
            });
        }
    }, 100);
}

// 关闭精确数量控制模态窗口
function closeQuantityControlModal() {
    const modal = document.getElementById('quantityControlModal');
    modal.classList.add('hidden');
}

// 确认精确数量控制配置
function confirmQuantityControlConfig() {
    const totalConfigured = Object.values(quantityDistribution).reduce((sum, count) => sum + count, 0);
    const targetTotal = parseInt(document.getElementById('configQuestions').value) || 5;
    
    if (Object.keys(quantityDistribution).length === 0) {
        showErrorMessage(window.i18n ? window.i18n.translate('exam.config.no_config_error', '请至少添加一个数量配置') : '请至少添加一个数量配置');
        return;
    }
    
    if (totalConfigured !== targetTotal) {
        showErrorMessage(window.i18n ? 
            window.i18n.translate('exam.config.total_mismatch_error', `配置总数（${totalConfigured}题）与目标总数（${targetTotal}题）不匹配`) : 
            `配置总数（${totalConfigured}题）与目标总数（${targetTotal}题）不匹配`);
        return;
    }
    
    // 启用精确数量控制
    document.getElementById('enableQuantityControl').checked = true;
    toggleQuantityControl();
    
    // 关闭模态窗口
    closeQuantityControlModal();
    
    showSuccessMessage(window.i18n ? 
        window.i18n.translate('exam.config.config_confirmed', `已确认数量配置，共${Object.keys(quantityDistribution).length}个类别，${totalConfigured}题`) : 
        `已确认数量配置，共${Object.keys(quantityDistribution).length}个类别，${totalConfigured}题`);
}

// 更新模态窗口中的目标总数
function updateModalTargetCount() {
    const targetCount = parseInt(document.getElementById('configQuestions').value) || 5;
    const modalTargetElement = document.getElementById('modalTargetTotalCount');
    if (modalTargetElement) {
        const questionsUnit = window.i18n ? window.i18n.translate('exam.config.questions_unit', '题') : '题';
        modalTargetElement.innerHTML = `${targetCount} <span data-i18n="exam.config.questions_unit">${questionsUnit}</span>`;
    }
}

// 更新题型预览
function updateQuestionTypePreview() {
    const previewContainer = document.getElementById('questionTypeBreakdown');
    if (!previewContainer) return;
    
    const isQuantityControlEnabled = document.getElementById('enableQuantityControl').checked;
    
    if (isQuantityControlEnabled && Object.keys(quantityDistribution).length > 0) {
        // 精确数量控制模式 - 显示详细配置
        const typeBreakdown = {};
        
        for (const [key, count] of Object.entries(quantityDistribution)) {
            const parts = key.split('-');
            if (parts.length === 3) {
                const [subject, difficulty, questionType] = parts;
                const typeKey = getQuestionTypeName(questionType);
                
                if (!typeBreakdown[typeKey]) {
                    typeBreakdown[typeKey] = 0;
                }
                typeBreakdown[typeKey] += count;
            }
        }
        
        let html = '';
        for (const [type, count] of Object.entries(typeBreakdown)) {
            const percentage = ((count / Object.values(quantityDistribution).reduce((a, b) => a + b, 0)) * 100).toFixed(1);
            html += `
                <div class="flex justify-between items-center">
                    <span>${type}:</span>
                    <span class="font-medium">${count}题 (${percentage}%)</span>
                </div>
            `;
        }
        
        previewContainer.innerHTML = html || '<div class="text-gray-500">暂无配置</div>';
    } else {
        // 传统筛选模式 - 显示筛选条件
        const selectedTypes = [];
        document.querySelectorAll('input[name="questionTypes"]:checked').forEach(checkbox => {
            selectedTypes.push(getQuestionTypeName(checkbox.value));
        });
        
        if (selectedTypes.length > 0) {
            const totalQuestions = parseInt(document.getElementById('configQuestions').value) || 5;
            const avgPerType = Math.ceil(totalQuestions / selectedTypes.length);
            
            let html = '';
            selectedTypes.forEach(type => {
                html += `
                    <div class="flex justify-between items-center">
                        <span>${type}:</span>
                        <span class="font-medium">约${avgPerType}题</span>
                    </div>
                `;
            });
            
            previewContainer.innerHTML = html;
        } else {
            previewContainer.innerHTML = '<div class="text-gray-500">请选择题型</div>';
        }
    }
}

// 获取题型中文名称
function getQuestionTypeName(type) {
    const typeNames = {
        'multiple_choice': '选择题',
        'short_answer': '简答题', 
        'programming': '编程题',
        'true_false': '判断题',
        'fill_blank': '填空题',
        'essay': '论述题'
    };
    return typeNames[type] || type;
}

// 添加数量配置
function addQuantityConfig() {
    // 获取当前选中的筛选条件
    const selectedSubjects = Array.from(document.querySelectorAll('.subject-filter:checked')).map(cb => cb.value);
    const selectedDifficulties = Array.from(document.querySelectorAll('.difficulty-filter:checked')).map(cb => cb.value);
    const selectedTypes = Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);
    
    if (selectedSubjects.length === 0 || selectedDifficulties.length === 0 || selectedTypes.length === 0) {
        showErrorMessage('请先选择学科、难度和题型筛选条件');
        return;
    }
    
    // 生成所有组合
    const combinations = [];
    selectedSubjects.forEach(subject => {
        selectedDifficulties.forEach(difficulty => {
            selectedTypes.forEach(type => {
                const key = `${subject}-${difficulty}-${type}`;
                if (!quantityDistribution[key]) {
                    combinations.push({ key, subject, difficulty, type });
                }
            });
        });
    });
    
    if (combinations.length === 0) {
        showErrorMessage('所选条件的组合已经存在，请选择其他条件或修改现有配置');
        return;
    }
    
    // 为每个组合添加配置（默认1题）
    combinations.forEach(combo => {
        quantityDistribution[combo.key] = 1;
    });
    
    updateQuantityConfigDisplay();
    showSuccessMessage(`已添加 ${combinations.length} 个数量配置`);
}

// 智能分配数量
function autoGenerateQuantityConfig() {
    const totalQuestions = parseInt(document.getElementById('configQuestions').value) || 5;
    const configCount = Object.keys(quantityDistribution).length;
    
    if (configCount === 0) {
        showErrorMessage('请先添加数量配置');
        return;
    }
    
    // 平均分配，余数给前几个配置
    const baseCount = Math.floor(totalQuestions / configCount);
    const remainder = totalQuestions % configCount;
    
    let index = 0;
    for (const key in quantityDistribution) {
        quantityDistribution[key] = baseCount + (index < remainder ? 1 : 0);
        index++;
    }
    
    updateQuantityConfigDisplay();
    showSuccessMessage(`已智能分配总计 ${totalQuestions} 题到 ${configCount} 个配置`);
}

// 清空数量配置
function clearQuantityConfig() {
    if (Object.keys(quantityDistribution).length === 0) {
        showErrorMessage('没有配置需要清空');
        return;
    }
    
    if (confirm('确定要清空所有数量配置吗？')) {
        quantityDistribution = {};
        updateQuantityConfigDisplay();
        showSuccessMessage('已清空所有数量配置');
    }
}

// 更新数量配置显示
function updateQuantityConfigDisplay() {
    const container = document.getElementById('quantityConfigList');
    const emptyState = document.getElementById('quantityConfigEmpty');
    const totalConfiguredElement = document.getElementById('totalConfiguredCount');
    const modalTotalConfiguredElement = document.getElementById('modalTotalConfiguredCount');
    const configuredCategoriesElement = document.getElementById('configuredCategoriesCount');
    const modalConfiguredCategoriesElement = document.getElementById('modalConfiguredCategoriesCount');
    
    let totalConfigured = 0;
    const categoryCount = Object.keys(quantityDistribution).length;
    const questionsUnit = window.i18n ? window.i18n.translate('exam.config.questions_unit', '题') : '题';
    
    // 更新类别计数
    if (configuredCategoriesElement) configuredCategoriesElement.textContent = categoryCount;
    if (modalConfiguredCategoriesElement) modalConfiguredCategoriesElement.textContent = categoryCount;
    
    if (categoryCount === 0) {
        // 显示空状态
        if (emptyState) emptyState.classList.remove('hidden');
        container.innerHTML = '';
    } else {
        // 隐藏空状态，显示配置列表
        if (emptyState) emptyState.classList.add('hidden');
        
        container.innerHTML = '';
        Object.entries(quantityDistribution).forEach(([key, count]) => {
            const [subject, difficulty, type] = key.split('-');
            const configItem = document.createElement('div');
            configItem.className = 'flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow';
            
            configItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-lg flex items-center justify-center">
                        <i class="ri-bookmark-line text-white text-sm"></i>
                    </div>
                    <div>
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-sm font-semibold text-gray-800">${subject}</span>
                            <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">${getDifficultyDisplayName(difficulty)}</span>
                            <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">${getTypeDisplayName(type)}</span>
                        </div>
                        <div class="text-xs text-gray-500">${key}</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2">
                        <input type="number" min="0" max="50" value="${count}" 
                               class="w-20 px-3 py-2 text-sm border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onchange="updateQuantityCount('${key}', this.value)"
                               placeholder="0">
                        <span class="text-sm text-gray-600">${questionsUnit}</span>
                    </div>
                    <button type="button" onclick="removeQuantityConfig('${key}')" 
                            class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                            title="${window.i18n ? window.i18n.translate('exam.config.remove_config', '移除此配置') : '移除此配置'}">
                        <i class="ri-delete-bin-line text-sm"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(configItem);
            totalConfigured += count;
        });
    }
    
    // 更新总数显示
    const totalText = `${totalConfigured} ${questionsUnit}`;
    if (totalConfiguredElement) {
        totalConfiguredElement.innerHTML = `${totalConfigured} <span data-i18n="exam.config.questions_unit">${questionsUnit}</span>`;
    }
    if (modalTotalConfiguredElement) {
        modalTotalConfiguredElement.innerHTML = `${totalConfigured} <span data-i18n="exam.config.questions_unit">${questionsUnit}</span>`;
    }
    
    // 更新配置计数的颜色
    const targetCount = parseInt(document.getElementById('configQuestions').value) || 5;
    let colorClass = 'font-semibold text-blue-600';
    if (totalConfigured === targetCount) {
        colorClass = 'font-semibold text-green-600';
    } else if (totalConfigured > targetCount) {
        colorClass = 'font-semibold text-red-600';
    }
    
    if (totalConfiguredElement) totalConfiguredElement.className = colorClass;
    if (modalTotalConfiguredElement) modalTotalConfiguredElement.className = `text-lg font-bold ${colorClass.replace('font-semibold', '')}`;
    
    // 更新题型预览
    updateQuestionTypePreview();
}

// 更新单个配置的数量
function updateQuantityCount(key, newValue) {
    const count = parseInt(newValue) || 0;
    if (count <= 0) {
        delete quantityDistribution[key];
    } else {
        quantityDistribution[key] = count;
    }
    updateQuantityConfigDisplay();
}

// 移除单个数量配置
function removeQuantityConfig(key) {
    delete quantityDistribution[key];
    updateQuantityConfigDisplay();
}

// 更新目标总数显示
function updateTargetTotalCount() {
    const targetCount = parseInt(document.getElementById('configQuestions').value) || 5;
    const questionsUnit = window.i18n ? window.i18n.translate('exam.config.questions_unit', '题') : '题';
    
    const targetElement = document.getElementById('targetTotalCount');
    if (targetElement) {
        targetElement.innerHTML = `${targetCount} <span data-i18n="exam.config.questions_unit">${questionsUnit}</span>`;
    }
    
    // 同步更新模态窗口中的目标总数
    updateModalTargetCount();
    
    // 同时更新已配置数量的颜色
    updateQuantityConfigDisplay();
}

// 获取难度显示名称
function getDifficultyDisplayName(difficulty) {
    const difficultyMap = {
        'high_school': '高中水平',
        'undergraduate_basic': '本科基础', 
        'undergraduate_advanced': '本科进阶',
        'graduate': '研究生水平'
    };
    return difficultyMap[difficulty] || difficulty;
}

// 获取题型显示名称  
function getTypeDisplayName(type) {
    const typeMap = {
        'multiple_choice': '选择题',
        'short_answer': '简答题',
        'programming': '编程题',
        'true_false': '判断题',
        'fill_blank': '填空题',
        'essay': '论述题'
    };
    return typeMap[type] || type;
}
</script>
</body>
</html>
