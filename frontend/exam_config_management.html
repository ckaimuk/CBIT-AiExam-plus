<!DOCTYPE html>
<html lang="zh-CN" id="htmlRoot">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="exam.config.title">è€ƒè¯•é…ç½®ç®¡ç† - IMBA æ™ºèƒ½è€ƒè¯•ç³»ç»Ÿ</title>
<link rel="icon" type="image/x-icon" id="faviconLink" href="/favicon.ico">
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<script src="/static/js/i18n.js"></script>
<script>
// i18nåˆå§‹åŒ–ç”±å…¨å±€i18n.jså¤„ç†ï¼Œæ— éœ€é‡å¤åˆå§‹åŒ–
</script>
<script>
tailwind.config = {
theme: {
extend: {
colors: {
primary: '#2563eb',
secondary: '#3b82f6',
success: '#10b981',
warning: '#f59e0b',
danger: '#ef4444'
},
fontFamily: {
'sans': ['Inter', 'system-ui', 'sans-serif']
}
}
}
}
</script>
<style>
body {
font-family: 'Inter', sans-serif;
background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
}

.card {
background: white;
border-radius: 12px;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.card:hover {
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.config-card {
transition: all 0.3s ease;
border-left: 4px solid transparent;
position: relative;
}

.config-card:hover {
border-left-color: #2563eb;
transform: translateX(4px);
}

.config-card.default {
border-left-color: #10b981;
background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
}

.config-card.inactive {
opacity: 0.6;
border-left-color: #9ca3af;
}

.action-button {
transition: all 0.2s ease;
}

.action-button:hover {
transform: scale(1.05);
}

.toggle-switch {
position: relative;
display: inline-block;
width: 44px;
height: 24px;
}

.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}

.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: #ccc;
transition: .4s;
border-radius: 24px;
}

.slider:before {
position: absolute;
content: "";
height: 18px;
width: 18px;
left: 3px;
bottom: 3px;
background-color: white;
transition: .4s;
border-radius: 50%;
}

input:checked + .slider {
background-color: #2563eb;
}

input:checked + .slider:before {
transform: translateX(20px);
}

.fade-in {
animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
0% { opacity: 0; transform: translateY(20px); }
100% { opacity: 1; transform: translateY(0); }
}

/* ç¾è§‚çš„éš¾åº¦æ ‡ç­¾æ ·å¼ */
.difficulty-tag {
display: inline-block;
cursor: pointer;
transition: all 0.2s ease;
}

.difficulty-tag-content {
display: inline-flex;
align-items: center;
padding: 8px 16px;
background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
border: 2px solid #e2e8f0;
border-radius: 20px;
font-size: 0.875rem;
font-weight: 500;
color: #4a5568;
transition: all 0.2s ease;
white-space: nowrap;
}

.difficulty-icon {
margin-right: 6px;
font-size: 1rem;
}

.difficulty-tag:hover .difficulty-tag-content {
background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
border-color: #cbd5e0;
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.difficulty-tag input:checked + .difficulty-tag-content {
background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
border-color: #2563eb;
color: white;
box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.difficulty-tag input:checked + .difficulty-tag-content:hover {
background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
border-color: #1d4ed8;
}
</style>
</head>

<body class="min-h-screen">
<!-- Navigation -->
<nav class="bg-white shadow-sm border-b sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex justify-between items-center h-16">
<div class="flex items-center space-x-4">
<a href="/admin/dashboard" class="flex items-center space-x-3">
<img id="systemLogo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzI1NjNlYiIvPgo8cGF0aCBkPSJNMTIgMTJIMjhWMTZIMTJWMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMThIMjRWMjJIMTJWMThaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMjRIMjhWMjhIMTJWMjRaIiBmaWxsPSJ3aGl0ZSIvPgo8Y2lyY2xlIGN4PSIzMCIgY3k9IjEwIiByPSIzIiBmaWxsPSIjMTBiOTgxIi8+Cjwvc3ZnPgo=" 
alt="System Logo" class="w-8 h-8 object-contain">
<span class="font-bold text-xl text-primary" data-i18n="exam.config.title_short">è€ƒè¯•é…ç½®ç®¡ç†</span>
</a>
</div>
<div class="flex items-center space-x-4">
<!-- Language Toggle -->
<button id="languageToggle" class="text-gray-600 hover:text-primary transition-colors px-3 py-2 rounded-lg border border-gray-200">
<i class="ri-global-line mr-1"></i>
<span class="language-display">ä¸­</span>
</button>
<a href="/admin/dashboard" class="text-gray-600 hover:text-primary transition-colors">
<i class="ri-dashboard-line mr-1"></i><span data-i18n="nav.admin_panel">ç®¡ç†é¢æ¿</span>
</a>
<a href="/question_management.html" class="text-gray-600 hover:text-primary transition-colors">
<i class="ri-question-line mr-1"></i><span data-i18n="question.management.title_short">é¢˜åº“ç®¡ç†</span>
</a>
<button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
<i class="ri-logout-box-line mr-1"></i><span data-i18n="nav.logout">é€€å‡ºç™»å½•</span>
</button>
</div>
</div>
</div>
</nav>

<!-- Main Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
<!-- Page Header -->
<div class="mb-8">
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
<div>
<h1 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="exam.config.title_short">è€ƒè¯•é…ç½®ç®¡ç†</h1>
<p class="text-gray-600" data-i18n="exam.config.description">ç®¡ç†è€ƒè¯•é…ç½®ï¼Œè®¾ç½®è€ƒè¯•å‚æ•°å’Œæˆç»©æ˜¾ç¤ºç­–ç•¥</p>
</div>
<div class="flex space-x-3 mt-4 sm:mt-0">
<button id="addConfigBtn" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
<i class="ri-add-line mr-2"></i><span data-i18n="exam.config.add_config">æ–°å»ºé…ç½®</span>
</button>
</div>
</div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
<div class="card p-6">
<div class="flex items-center">
<div class="flex-shrink-0">
<div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
<i class="ri-file-list-line text-blue-600 text-xl"></i>
</div>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500" data-i18n="exam.config.stats.total_configs">æ€»é…ç½®æ•°</p>
<p class="text-2xl font-bold text-gray-900" id="totalConfigs">0</p>
</div>
</div>
</div>

<div class="card p-6">
<div class="flex items-center">
<div class="flex-shrink-0">
<div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
<i class="ri-check-line text-green-600 text-xl"></i>
</div>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500" data-i18n="exam.config.stats.active_configs">å¯ç”¨é…ç½®</p>
<p class="text-2xl font-bold text-gray-900" id="activeConfigs">0</p>
</div>
</div>
</div>

<div class="card p-6">
<div class="flex items-center">
<div class="flex-shrink-0">
<div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
<i class="ri-star-line text-purple-600 text-xl"></i>
</div>
</div>
            <div class="ml-4">
            <p class="text-sm font-medium text-gray-500" data-i18n="exam.config.stats.current_config">å½“å‰é…ç½®</p>
            <p class="text-lg font-bold text-gray-900" id="defaultConfigName">æ— </p>
            </div>
</div>
</div>

<div class="card p-6">
<div class="flex items-center">
<div class="flex-shrink-0">
<div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
<i class="ri-eye-line text-orange-600 text-xl"></i>
</div>
</div>
<div class="ml-4">
<p class="text-sm font-medium text-gray-500" data-i18n="exam.config.stats.show_results">æ˜¾ç¤ºæˆç»©</p>
<p class="text-lg font-bold text-gray-900" id="showResultsCount">0</p>
</div>
</div>
</div>
</div>

<!-- Configurations List -->
<div class="card p-6">
<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-semibold text-gray-900">é…ç½®åˆ—è¡¨</h2>
<div class="flex items-center space-x-4">
<div class="flex items-center text-sm text-gray-500">
<span>å…± <span id="totalCount">0</span> ä¸ªé…ç½®</span>
</div>
<button id="refreshBtn" class="text-gray-400 hover:text-gray-600 p-2">
<i class="ri-refresh-line text-lg"></i>
</button>
</div>
</div>

<!-- Loading State -->
<div id="loadingState" class="hidden text-center py-12">
<div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-4"></div>
<p class="text-gray-600">åŠ è½½é…ç½®ä¸­...</p>
</div>

<!-- Empty State -->
<div id="emptyState" class="hidden text-center py-12">
<div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
<i class="ri-inbox-line text-gray-400 text-2xl"></i>
</div>
<h3 class="text-lg font-semibold text-gray-900 mb-2" data-i18n="exam.config.no_configs">æš‚æ— é…ç½®</h3>
<p class="text-gray-600 mb-6" data-i18n="exam.config.no_configs_desc">ç‚¹å‡»"æ–°å»ºé…ç½®"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªè€ƒè¯•é…ç½®</p>
<button onclick="showAddConfigModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
<i class="ri-add-line mr-2"></i><span data-i18n="exam.config.add_config">æ–°å»ºé…ç½®</span>
</button>
</div>

<!-- Configurations Grid -->
<div id="configsContainer" class="space-y-4">
<!-- åŠ¨æ€åŠ è½½é…ç½® -->
</div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

<!-- Add/Edit Config Modal -->
<div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
<div class="bg-white rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
<div class="flex justify-between items-center mb-6">
<h3 class="text-2xl font-semibold text-gray-900" id="modalTitle" data-i18n="exam.config.modal_title">æ–°å»ºè€ƒè¯•é…ç½®</h3>
<button id="closeModalBtn" class="text-gray-400 hover:text-gray-600">
<i class="ri-close-line text-2xl"></i>
</button>
</div>

<form id="configForm" class="space-y-6">
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<!-- åŸºæœ¬ä¿¡æ¯ -->
<div class="space-y-6">
<h4 class="text-lg font-semibold text-gray-900 border-b pb-2" data-i18n="exam.config.basic_info">åŸºæœ¬ä¿¡æ¯</h4>

<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.config_name">é…ç½®åç§° *</label>
<input type="text" id="configName" required 
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
data-i18n-placeholder="exam.config.config_name_placeholder" placeholder="ä¾‹å¦‚ï¼šæ•°å­¦æœŸä¸­è€ƒè¯•">
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.config_description">é…ç½®æè¿°</label>
<textarea id="configDescription" rows="3" 
class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
data-i18n-placeholder="exam.config.config_description_placeholder" placeholder="æè¿°è¿™ä¸ªé…ç½®çš„ç”¨é€”å’Œç‰¹ç‚¹..."></textarea>
</div>

                <div class="grid grid-cols-2 gap-4">
                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.question_count">é¢˜ç›®æ•°é‡ *</label>
                <input type="number" id="configQuestions" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                value="5" min="1" max="50">
                </div>

                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.time_limit">æ—¶é—´é™åˆ¶ï¼ˆåˆ†é’Ÿï¼‰*</label>
                <input type="number" id="configTimeLimit" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                value="75" min="30" max="300">
                </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.question_selection_mode">é¢˜ç›®é€‰æ‹©æ¨¡å¼ *</label>
                <select id="questionSelectionMode" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                onchange="toggleQuestionSelectionMode()">
                <option value="filter" data-i18n="exam.config.filter_mode">ç­›é€‰æ¨¡å¼</option>
                <option value="manual" data-i18n="exam.config.manual_mode">æ‰‹åŠ¨é€‰æ‹©</option>
                </select>
                <p class="text-xs text-gray-500 mt-1" data-i18n="exam.config.selection_mode_desc">ç­›é€‰æ¨¡å¼ï¼šæ ¹æ®æ¡ä»¶è‡ªåŠ¨é€‰æ‹©é¢˜ç›®ï¼›æ‰‹åŠ¨é€‰æ‹©ï¼šç²¾ç¡®é€‰æ‹©æŒ‡å®šé¢˜ç›®</p>
                </div>

                <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.passing_score">åŠæ ¼åˆ†æ•°</label>
                <input type="number" id="configPassingScore" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                value="60" min="0" max="100" step="0.1">
                <p class="text-xs text-gray-500 mt-1" data-i18n="exam.config.passing_score_desc">ç™¾åˆ†åˆ¶ï¼Œç”¨äºæˆç»©è¯„å®š</p>
                </div>
                </div>

<!-- é…ç½®é€‰é¡¹ -->
<div class="space-y-4">
<h5 class="font-medium text-gray-900" data-i18n="exam.config.config_options">é…ç½®é€‰é¡¹</h5>

<div class="space-y-3">
<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                <span class="font-medium text-gray-900" data-i18n="exam.config.set_as_current">è®¾ä¸ºå½“å‰è€ƒè¯•é…ç½®</span>
                <p class="text-sm text-gray-600" data-i18n="exam.config.set_as_current_desc">æ–°åˆ›å»ºçš„è€ƒè¯•å°†é»˜è®¤ä½¿ç”¨æ­¤é…ç½®</p>
                </div>
<label class="toggle-switch">
<input type="checkbox" id="configIsDefault">
<span class="slider"></span>
</label>
</div>

<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
<div>
<span class="font-medium text-gray-900" data-i18n="exam.config.active_status">å¯ç”¨çŠ¶æ€</span>
<p class="text-sm text-gray-600" data-i18n="exam.config.active_status_desc">æ˜¯å¦å…è®¸ä½¿ç”¨æ­¤é…ç½®</p>
</div>
<label class="toggle-switch">
<input type="checkbox" id="configIsActive" checked>
<span class="slider"></span>
</label>
</div>

<div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border border-yellow-200">
<div>
<span class="font-medium text-gray-900" data-i18n="exam.config.show_results_after_exam">è€ƒè¯•å®Œæˆåæ˜¾ç¤ºæˆç»©</span>
<p class="text-sm text-yellow-700" data-i18n="exam.config.show_results_desc">å–æ¶ˆåå­¦ç”Ÿå®Œæˆè€ƒè¯•åªæ˜¾ç¤ºç¡®è®¤é¡µé¢</p>
</div>
<label class="toggle-switch">
<input type="checkbox" id="configShowResults" checked>
<span class="slider"></span>
</label>
</div>
</div>
</div>
</div>

<!-- é¢˜ç›®é€‰æ‹© -->
<div class="space-y-6">
<h4 class="text-lg font-semibold text-gray-900 border-b pb-2" id="questionSectionTitle">é¢˜ç›®ç­›é€‰</h4>

<!-- ç­›é€‰æ¨¡å¼ -->
<div id="filterMode" class="space-y-6">

<!-- ç²¾ç¡®æ•°é‡æ§åˆ¶ - ç®€åŒ–ç‰ˆ -->
<div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
<div class="flex items-start justify-between">
<div class="flex-1 pr-4">
<div class="flex items-center space-x-3 mb-2">
<h5 class="font-medium text-blue-900" data-i18n="exam.config.quantity_control">ç²¾ç¡®æ•°é‡æ§åˆ¶</h5>
<label class="toggle-switch">
<input type="checkbox" id="enableQuantityControl" onchange="toggleQuantityControl()">
<span class="slider"></span>
</label>
</div>
<p class="text-sm text-blue-700 mb-3" data-i18n="exam.config.quantity_control_desc">å¯ç”¨åå¯ä¸ºæ¯ä¸ªå­¦ç§‘ã€éš¾åº¦ã€é¢˜å‹ç»„åˆæŒ‡å®šç”Ÿæˆæ•°é‡</p>
<button type="button" id="openQuantityConfigBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center">
<i class="ri-settings-3-line mr-2"></i>
<span data-i18n="exam.config.configure_quantity">é…ç½®æ•°é‡</span>
</button>
</div>
</div>

<!-- æ•°é‡é…ç½®çŠ¶æ€æ˜¾ç¤º -->
<div id="quantityConfigStatus" class="hidden mt-3 p-3 bg-white rounded border border-blue-200">
<div class="flex items-center justify-between text-sm">
<span data-i18n="exam.config.configured_categories">å·²é…ç½®ç±»åˆ«:</span>
<span id="configuredCategoriesCount" class="font-semibold text-blue-600">0</span>
</div>
<div class="flex items-center justify-between text-sm mt-1">
<span data-i18n="exam.config.total_configured">å·²é…ç½®æ€»æ•°:</span>
<span id="totalConfiguredCount" class="font-semibold text-green-600">0 <span data-i18n="exam.config.questions_unit">é¢˜</span></span>
</div>
<div class="flex items-center justify-between text-sm mt-1">
<span data-i18n="exam.config.target_total">ç›®æ ‡æ€»æ•°:</span>
<span id="targetTotalCount" class="font-semibold text-gray-600">5 <span data-i18n="exam.config.questions_unit">é¢˜</span></span>
</div>

<!-- é¢˜å‹é¢„è§ˆ -->
<div id="questionTypePreview" class="mt-3 p-3 bg-gray-50 rounded border">
<h6 class="text-sm font-medium text-gray-700 mb-2" data-i18n="exam.config.question_type_preview">é¢˜å‹é¢„è§ˆ:</h6>
<div id="questionTypeBreakdown" class="space-y-1 text-xs text-gray-600">
<!-- åŠ¨æ€ç”Ÿæˆé¢˜å‹åˆ†å¸ƒ -->
</div>
</div>
</div>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="exam.config.subject_filter">å­¦ç§‘ç­›é€‰</label>
<div class="grid grid-cols-2 gap-3">
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="æ•°å­¦">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.math">ğŸ“ æ•°å­¦</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="ç‰©ç†">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.physics">âš›ï¸ ç‰©ç†</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="ç»Ÿè®¡å­¦">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.statistics">ğŸ“Š ç»Ÿè®¡å­¦</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="è®¡ç®—æœºç§‘å­¦">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.computer_science">ğŸ’» è®¡ç®—æœºç§‘å­¦</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="subject-filter rounded text-primary mr-3" value="å·¥ç¨‹å­¦">
<span class="text-sm text-gray-700" data-i18n="exam.config.subject.engineering">âš™ï¸ å·¥ç¨‹å­¦</span>
</label>
</div>
<p class="text-xs text-gray-500 mt-2" data-i18n="exam.config.subject_filter_desc">ä¸é€‰æ‹©è¡¨ç¤ºä¸é™åˆ¶å­¦ç§‘</p>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="exam.config.difficulty_filter">éš¾åº¦ç­›é€‰</label>

<!-- åŸºç¡€æ•™è‚²éš¾åº¦ -->
<div class="mb-6">
<h5 class="text-sm font-medium text-gray-600 mb-3" data-i18n="exam.config.basic_education">åŸºç¡€æ•™è‚²</h5>
<div class="flex flex-wrap gap-2">
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="high_school">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.high_school">
<span class="difficulty-icon">ğŸ“</span>é«˜ä¸­æ°´å¹³
</span>
</label>
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="undergraduate_basic">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.undergraduate_basic">
<span class="difficulty-icon">ğŸ“š</span>æœ¬ç§‘åŸºç¡€
</span>
</label>
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="undergraduate_advanced">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.undergraduate_advanced">
<span class="difficulty-icon">ğŸ¯</span>æœ¬ç§‘é«˜çº§
</span>
</label>
</div>
</div>

<!-- æ ‡å‡†åŒ–è€ƒè¯•éš¾åº¦ -->
<div class="mb-6">
<h5 class="text-sm font-medium text-gray-600 mb-3" data-i18n="exam.config.standardized_tests">æ ‡å‡†åŒ–è€ƒè¯•</h5>
<div class="flex flex-wrap gap-2">
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="gre_level">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.gre_level">
<span class="difficulty-icon">ğŸ¯</span>GREéš¾åº¦
</span>
</label>
</div>
</div>

<!-- å­¦æœ¯ç ”ç©¶éš¾åº¦ -->
<div class="mb-6">
<h5 class="text-sm font-medium text-gray-600 mb-3" data-i18n="exam.config.academic_research">å­¦æœ¯ç ”ç©¶</h5>
<div class="flex flex-wrap gap-2">
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="graduate_study">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.graduate_study">
<span class="difficulty-icon">ğŸ›ï¸</span>ç ”ç©¶ç”Ÿæ°´å¹³
</span>
</label>
<label class="difficulty-tag">
<input type="checkbox" class="difficulty-filter sr-only" value="doctoral_research">
<span class="difficulty-tag-content" data-i18n="exam.config.difficulty.doctoral_research">
<span class="difficulty-icon">ğŸ”¬</span>åšå£«ç ”ç©¶
</span>
</label>
</div>
</div>

<p class="text-xs text-gray-500 mt-2" data-i18n="exam.config.difficulty_filter_desc">ä¸é€‰æ‹©è¡¨ç¤ºä¸é™åˆ¶éš¾åº¦</p>
</div>

<div>
<label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="exam.config.type_filter">é¢˜å‹ç­›é€‰</label>
<div class="grid grid-cols-3 gap-3">
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="multiple_choice">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.multiple_choice">ğŸ“ é€‰æ‹©é¢˜</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="short_answer">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.short_answer">ğŸ“„ ç®€ç­”é¢˜</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="programming">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.programming">ğŸ’» ç¼–ç¨‹é¢˜</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="true_false">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.true_false">âœ… åˆ¤æ–­é¢˜</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="fill_blank">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.fill_blank">ğŸ“ å¡«ç©ºé¢˜</span>
</label>
<label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
<input type="checkbox" class="type-filter rounded text-primary mr-3" value="essay">
<span class="text-sm text-gray-700" data-i18n="exam.config.type.essay">ğŸ“– è®ºè¿°é¢˜</span>
</label>
</div>
<p class="text-xs text-gray-500 mt-2" data-i18n="exam.config.type_filter_desc">ä¸é€‰æ‹©è¡¨ç¤ºä¸é™åˆ¶é¢˜å‹</p>
</div>
</div>

<!-- æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼ -->
<div id="manualMode" class="hidden">
    <div class="mb-4">
        <button type="button" id="openManualSelectionBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i class="ri-hand-coin-line mr-2"></i>
            <span data-i18n="manual.open_selection">æ‰“å¼€æ‰‹åŠ¨é€‰æ‹©çª—å£</span>
        </button>
        <p class="text-sm text-gray-600 mt-2" data-i18n="manual.selection_desc">åœ¨ç‹¬ç«‹çª—å£ä¸­è¿›è¡Œé¢˜ç›®ç­›é€‰å’Œé€‰æ‹©æ“ä½œ</p>
    </div>
    
    <div class="bg-white rounded-lg p-4 border border-gray-200">
        <h4 class="text-md font-medium text-gray-800 mb-3" data-i18n="manual.selected_summary">å·²é€‰æ‹©çš„é¢˜ç›®</h4>
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600" data-i18n="manual.total_selected">æ€»å…±é€‰æ‹©:</span>
                <span id="manualSelectedCount" class="text-lg font-semibold text-blue-600">0 é¢˜</span>
            </div>
            <button type="button" id="clearAllSelectedBtn" class="px-3 py-1 text-sm text-gray-600 border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                <i class="ri-close-line mr-1"></i>
                <span data-i18n="manual.clear_all">æ¸…ç©ºæ‰€æœ‰</span>
            </button>
        </div>
    </div>
</div>

<!-- æ‰‹åŠ¨é€‰æ‹©æ¨¡æ€çª—å£ -->
<div id="manualSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-lg w-full max-w-6xl h-[90vh] flex flex-col">
    
        <!-- çª—å£å¤´éƒ¨ -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <i class="ri-hand-coin-line text-2xl text-blue-600"></i>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900" data-i18n="manual.window_title">æ‰‹åŠ¨é€‰æ‹©é¢˜ç›®</h3>
                    <p class="text-sm text-gray-600" data-i18n="manual.window_subtitle">ç­›é€‰å¹¶é€‰æ‹©è€ƒè¯•é¢˜ç›®</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button type="button" id="closeManualSelectionBtn" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- çª—å£å†…å®¹ -->
        <div class="flex-1 overflow-hidden flex">
            <!-- å·¦ä¾§ç­›é€‰é¢æ¿ -->
            <div class="w-80 border-r border-gray-200 p-4 bg-gray-50 overflow-y-auto">
                <h4 class="text-md font-medium text-gray-900 mb-4" data-i18n="manual.filter_conditions">ç­›é€‰æ¡ä»¶</h4>
                
                <!-- å­¦ç§‘ç­›é€‰ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manual.subject">å­¦ç§‘</label>
                    <select id="manualSubjectFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="" data-i18n="manual.all_subjects">æ‰€æœ‰å­¦ç§‘</option>
                        <option value="æ•°å­¦">æ•°å­¦</option>
                        <option value="è®¡ç®—æœºç§‘å­¦">è®¡ç®—æœºç§‘å­¦</option>
                        <option value="ç»Ÿè®¡å­¦">ç»Ÿè®¡å­¦</option>
                        <option value="å·¥ç¨‹å­¦">å·¥ç¨‹å­¦</option>
                        <option value="è‹±è¯­">è‹±è¯­</option>
                        <option value="é€»è¾‘å­¦">é€»è¾‘å­¦</option>
                    </select>
                </div>
                
                <!-- éš¾åº¦ç­›é€‰ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manual.difficulty">éš¾åº¦</label>
                    <select id="manualDifficultyFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="" data-i18n="manual.all_difficulties">æ‰€æœ‰éš¾åº¦</option>
                        <option value="high_school">é«˜ä¸­æ°´å¹³</option>
                        <option value="undergraduate_basic">æœ¬ç§‘åŸºç¡€</option>
                        <option value="undergraduate_advanced">æœ¬ç§‘è¿›é˜¶</option>
                        <option value="graduate">ç ”ç©¶ç”Ÿæ°´å¹³</option>
                    </select>
                </div>
                
                <!-- é¢˜å‹ç­›é€‰ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manual.question_type">é¢˜å‹</label>
                    <select id="manualTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="" data-i18n="manual.all_types">æ‰€æœ‰é¢˜å‹</option>
                        <option value="multiple_choice">é€‰æ‹©é¢˜</option>
                        <option value="short_answer">ç®€ç­”é¢˜</option>
                        <option value="programming">ç¼–ç¨‹é¢˜</option>
                    </select>
                </div>
                
                <!-- æœç´¢æ¡† -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="manual.search_content">æœç´¢å†…å®¹</label>
                    <input type="text" id="manualQuestionSearch" 
                           placeholder="è¾“å…¥å…³é”®è¯æœç´¢é¢˜ç›®..." 
                           data-i18n-placeholder="manual.search_placeholder"
                           class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="space-y-2 mb-6">
                    <button type="button" id="searchQuestionsBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                        <i class="ri-search-line mr-2"></i>
                        <span data-i18n="manual.search">æœç´¢é¢˜ç›®</span>
                    </button>
                    <button type="button" id="selectAllQuestionsBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                        <i class="ri-checkbox-line mr-2"></i>
                        <span data-i18n="manual.select_all">å…¨é€‰å½“å‰</span>
                    </button>
                    <button type="button" id="clearSelectedBtn" class="w-full px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                        <i class="ri-close-line mr-2"></i>
                        <span data-i18n="manual.clear">æ¸…ç©ºé€‰æ‹©</span>
                    </button>
                </div>
                
                <!-- éšæœºé€‰æ‹© -->
                <div class="border-t pt-4">
                    <h5 class="text-sm font-medium text-gray-900 mb-3" data-i18n="manual.random_selection">éšæœºé€‰æ‹©</h5>
                    <div class="flex items-center space-x-2 mb-2">
                        <label class="text-sm text-gray-700" data-i18n="manual.select_count">é€‰æ‹©æ•°é‡:</label>
                        <input type="number" id="randomSelectCount" min="1" max="100" value="5" 
                               class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        <span class="text-sm text-gray-600" data-i18n="manual.questions_unit">é¢˜</span>
                    </div>
                    <button type="button" id="randomSelectBtn" class="w-full px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition-colors">
                        <i class="ri-shuffle-line mr-2"></i>
                        <span data-i18n="manual.random_select_btn">éšæœºé€‰å–</span>
                    </button>
                </div>
                
                <!-- è´­ç‰©è½¦æ“ä½œ -->
                <div class="border-t pt-4 mt-4">
                    <h5 class="text-sm font-medium text-gray-900 mb-3" data-i18n="manual.cart_operations">è´­ç‰©è½¦æ“ä½œ</h5>
                    <div class="space-y-2">
                        <button type="button" id="addToCartBtn" class="w-full px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600 transition-colors">
                            <i class="ri-shopping-cart-line mr-2"></i>
                            <span data-i18n="manual.add_to_cart">åŠ å…¥è´­ç‰©è½¦</span>
                        </button>
                        <button type="button" id="clearCartBtn" class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                            <i class="ri-delete-bin-line mr-2"></i>
                            <span data-i18n="cart.clear">æ¸…ç©ºè´­ç‰©è½¦</span>
                        </button>
                        <button type="button" id="confirmCartBtn" class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                            <i class="ri-check-line mr-2"></i>
                            <span data-i18n="cart.confirm">ç¡®è®¤é€‰æ‹©</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 flex flex-col">
                <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
                <div class="p-4 border-b border-gray-200 bg-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-6">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600" data-i18n="status.available_questions">ç­›é€‰ç»“æœ:</span>
                                <span id="manualAvailableCount" class="text-sm font-semibold text-blue-600">0 é¢˜</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600" data-i18n="status.selected_questions">å·²é€‰æ‹©:</span>
                                <span id="manualSelectedCount" class="text-sm font-semibold text-green-600">0 é¢˜</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600" data-i18n="cart.in_cart">è´­ç‰©è½¦:</span>
                                <span id="cartCount" class="text-sm font-semibold text-purple-600">0 é¢˜</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- è´­ç‰©è½¦é¢„è§ˆåŒºåŸŸ -->
                <div class="p-4 bg-purple-50 border-b border-gray-200">
                    <h4 class="text-sm font-medium text-gray-900 mb-2" data-i18n="cart.preview">è´­ç‰©è½¦é¢„è§ˆ</h4>
                    <div id="cartPreview" class="max-h-20 overflow-y-auto">
                        <div class="text-sm text-gray-500" data-i18n="cart.empty_desc">è´­ç‰©è½¦ä¸ºç©ºï¼Œé€‰æ‹©é¢˜ç›®åç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"</div>
                    </div>
                </div>
                
                <!-- é¢˜ç›®åˆ—è¡¨ -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div id="manualQuestionsList">
                        <div class="text-center text-gray-500 py-12">
                            <i class="ri-search-line text-4xl mb-4 block text-gray-300"></i>
                            <h4 class="text-lg font-medium mb-2" data-i18n="questions.empty_title">å‡†å¤‡å¼€å§‹ç­›é€‰é¢˜ç›®</h4>
                            <p class="text-sm text-gray-400" data-i18n="questions.empty_desc">è®¾ç½®ç­›é€‰æ¡ä»¶åç‚¹å‡»"æœç´¢é¢˜ç›®"æŒ‰é’®</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- çª—å£åº•éƒ¨ -->
        <div class="p-4 border-t border-gray-200 bg-gray-50">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <span data-i18n="manual.instruction">æç¤º: é€‰æ‹©é¢˜ç›®ååŠ å…¥è´­ç‰©è½¦ï¼Œå¯ä»¥è·¨ç§‘ç›®æ”¶é›†é¢˜ç›®ï¼Œæœ€åç»Ÿä¸€ç¡®è®¤</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button type="button" id="closeAndConfirmBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                        <i class="ri-check-double-line mr-2"></i>
                        <span data-i18n="manual.close_and_confirm">å…³é—­å¹¶ç¡®è®¤</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç²¾ç¡®æ•°é‡æ§åˆ¶æ¨¡æ€çª—å£ -->
<div id="quantityControlModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
<div class="bg-white rounded-2xl w-full max-w-6xl max-h-[90vh] flex flex-col shadow-2xl">

<!-- çª—å£å¤´éƒ¨ -->
<div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
<div class="flex items-center space-x-3">
<div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center">
<i class="ri-settings-3-line text-white text-xl"></i>
</div>
<div>
<h3 class="text-xl font-bold text-gray-900" data-i18n="exam.config.quantity_modal_title">ç²¾ç¡®æ•°é‡æ§åˆ¶é…ç½®</h3>
<p class="text-sm text-gray-600" data-i18n="exam.config.quantity_modal_subtitle">ä¸ºæ¯ä¸ªå­¦ç§‘ã€éš¾åº¦ã€é¢˜å‹ç»„åˆè®¾ç½®ç²¾ç¡®çš„é¢˜ç›®æ•°é‡</p>
</div>
</div>
<button id="closeQuantityModalBtn" class="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors">
<i class="ri-close-line text-2xl"></i>
</button>
</div>

<!-- çª—å£å†…å®¹ -->
<div class="flex-1 overflow-hidden flex">
<!-- å·¦ä¾§é…ç½®é¢æ¿ -->
<div class="w-80 border-r border-gray-200 bg-gray-50 flex flex-col">
<!-- é…ç½®å·¥å…·æ  -->
<div class="p-4 border-b border-gray-200 bg-white">
<h4 class="text-md font-semibold text-gray-900 mb-3" data-i18n="exam.config.quantity_tools">é…ç½®å·¥å…·</h4>
<div class="space-y-2">
<button type="button" id="addQuantityConfigBtn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
<i class="ri-add-line mr-2"></i>
<span data-i18n="exam.config.add_quantity_config">æ·»åŠ æ•°é‡é…ç½®</span>
</button>
<button type="button" id="autoGenerateConfigBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
<i class="ri-magic-line mr-2"></i>
<span data-i18n="exam.config.auto_generate_config">æ™ºèƒ½åˆ†é…</span>
</button>
<button type="button" id="clearQuantityConfigBtn" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors flex items-center justify-center">
<i class="ri-delete-bin-line mr-2"></i>
<span data-i18n="exam.config.clear_config">æ¸…ç©ºé…ç½®</span>
</button>
</div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="p-4 border-b border-gray-200 bg-white">
<h4 class="text-md font-semibold text-gray-900 mb-3" data-i18n="exam.config.quantity_stats">é…ç½®ç»Ÿè®¡</h4>
<div class="space-y-3">
<div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
<span class="text-sm font-medium text-blue-800" data-i18n="exam.config.configured_categories">å·²é…ç½®ç±»åˆ«</span>
<span id="modalConfiguredCategoriesCount" class="text-lg font-bold text-blue-600">0</span>
</div>
<div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
<span class="text-sm font-medium text-green-800" data-i18n="exam.config.total_configured">å·²é…ç½®æ€»æ•°</span>
<span id="modalTotalConfiguredCount" class="text-lg font-bold text-green-600">0 <span data-i18n="exam.config.questions_unit">é¢˜</span></span>
</div>
<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
<span class="text-sm font-medium text-gray-800" data-i18n="exam.config.target_total">ç›®æ ‡æ€»æ•°</span>
<span id="modalTargetTotalCount" class="text-lg font-bold text-gray-600">5 <span data-i18n="exam.config.questions_unit">é¢˜</span></span>
</div>
</div>
</div>

<!-- ä½¿ç”¨è¯´æ˜ -->
<div class="flex-1 p-4 overflow-y-auto">
<h4 class="text-md font-semibold text-gray-900 mb-3" data-i18n="exam.config.usage_guide">ä½¿ç”¨è¯´æ˜</h4>
<div class="space-y-3 text-sm text-gray-600">
<div class="flex items-start space-x-2">
<span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">1</span>
<p data-i18n="exam.config.guide_step1">å…ˆåœ¨å³ä¾§ä¸»é…ç½®ä¸­é€‰æ‹©å­¦ç§‘ã€éš¾åº¦ã€é¢˜å‹ç­›é€‰æ¡ä»¶</p>
</div>
<div class="flex items-start space-x-2">
<span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">2</span>
<p data-i18n="exam.config.guide_step2">ç‚¹å‡»"æ·»åŠ æ•°é‡é…ç½®"ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„ç»„åˆ</p>
</div>
<div class="flex items-start space-x-2">
<span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">3</span>
<p data-i18n="exam.config.guide_step3">æ‰‹åŠ¨è°ƒæ•´æ¯ä¸ªç»„åˆçš„é¢˜ç›®æ•°é‡ï¼Œæˆ–ä½¿ç”¨"æ™ºèƒ½åˆ†é…"</p>
</div>
<div class="flex items-start space-x-2">
<span class="flex-shrink-0 w-5 h-5 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold">4</span>
<p data-i18n="exam.config.guide_step4">ç¡®ä¿é…ç½®æ€»æ•°ä¸ç›®æ ‡æ€»æ•°ä¸€è‡´åç‚¹å‡»"ç¡®è®¤é…ç½®"</p>
</div>
</div>
</div>
</div>

<!-- å³ä¾§é…ç½®åˆ—è¡¨ -->
<div class="flex-1 flex flex-col">
<!-- é…ç½®åˆ—è¡¨å¤´éƒ¨ -->
<div class="p-4 border-b border-gray-200 bg-white">
<div class="flex items-center justify-between">
<h4 class="text-md font-semibold text-gray-900" data-i18n="exam.config.quantity_distribution">æ•°é‡åˆ†é…é…ç½®</h4>
<div class="text-sm text-gray-500">
<span data-i18n="exam.config.edit_tip">ç‚¹å‡»æ•°é‡è¾“å…¥æ¡†å¯ç›´æ¥ç¼–è¾‘</span>
</div>
</div>
</div>

<!-- é…ç½®åˆ—è¡¨å†…å®¹ -->
<div class="flex-1 overflow-y-auto p-4">
<div id="quantityConfigList" class="space-y-3">
<!-- ç©ºçŠ¶æ€ -->
<div id="quantityConfigEmpty" class="text-center py-12">
<div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
<i class="ri-settings-line text-gray-400 text-2xl"></i>
</div>
<h3 class="text-lg font-medium text-gray-900 mb-2" data-i18n="exam.config.no_quantity_config">æš‚æ— æ•°é‡é…ç½®</h3>
<p class="text-gray-600 mb-6" data-i18n="exam.config.quantity_help">è¯·å…ˆé€‰æ‹©ä¸‹æ–¹çš„å­¦ç§‘ã€éš¾åº¦ã€é¢˜å‹ç­›é€‰æ¡ä»¶ï¼Œç„¶åç‚¹å‡»"æ·»åŠ æ•°é‡é…ç½®"æŒ‰é’®</p>
<button type="button" onclick="document.getElementById('addQuantityConfigBtn').click()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
<i class="ri-add-line mr-2"></i>
<span data-i18n="exam.config.add_first_config">æ·»åŠ ç¬¬ä¸€ä¸ªé…ç½®</span>
</button>
</div>
</div>
</div>
</div>
</div>

<!-- çª—å£åº•éƒ¨ -->
<div class="p-6 border-t border-gray-200 bg-gray-50">
<div class="flex items-center justify-between">
<div class="text-sm text-gray-600">
<span data-i18n="exam.config.quantity_note">æ³¨æ„ï¼šé…ç½®æ€»æ•°å¿…é¡»ä¸ç›®æ ‡é¢˜ç›®æ•°é‡ä¸€è‡´</span>
</div>
<div class="flex items-center space-x-3">
<button type="button" id="cancelQuantityConfigBtn" class="px-6 py-3 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
<span data-i18n="exam.config.cancel">å–æ¶ˆ</span>
</button>
<button type="button" id="confirmQuantityConfigBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
<i class="ri-check-line mr-2"></i>
<span data-i18n="exam.config.confirm_config">ç¡®è®¤é…ç½®</span>
</button>
</div>
</div>
</div>
</div>
</div>

<div class="flex justify-end space-x-4 pt-6 border-t">
<button type="button" id="cancelBtn" class="px-6 py-3 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
<span data-i18n="exam.config.cancel">å–æ¶ˆ</span>
</button>
<button type="submit" id="saveBtn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
<span id="saveText" data-i18n="exam.config.save_config">ä¿å­˜é…ç½®</span>
</button>
</div>
</form>
</div>
</div>

<script>
// å…¨å±€å˜é‡
let currentConfigs = [];
let editingConfigId = null;
let selectedQuestions = new Set();
let availableQuestions = [];
let questionCart = new Map(); // è´­ç‰©è½¦ï¼šå­˜å‚¨é¢˜ç›®ID -> é¢˜ç›®å¯¹è±¡çš„æ˜ å°„
let quantityDistribution = {}; // ç²¾ç¡®æ•°é‡æ§åˆ¶é…ç½®ï¼š{å­¦ç§‘-éš¾åº¦-é¢˜å‹: æ•°é‡}

// æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    alertDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="ri-error-warning-line"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    alertDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="ri-check-line"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// è´­ç‰©è½¦æ˜¾ç¤ºæ›´æ–°å‡½æ•°
function updateCartDisplay() {
    const cartCountElement = document.getElementById('cartCount');
    const cartPreviewElement = document.getElementById('cartPreview');
    
    if (!cartCountElement || !cartPreviewElement) return;
    
    const count = questionCart.size;
    cartCountElement.textContent = count;
    
    if (count === 0) {
        cartPreviewElement.innerHTML = `
            <div class="text-sm text-gray-500">è´­ç‰©è½¦ä¸ºç©ºï¼Œé€‰æ‹©é¢˜ç›®åç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"</div>
        `;
    } else {
        // æŒ‰å­¦ç§‘åˆ†ç»„æ˜¾ç¤ºè´­ç‰©è½¦å†…å®¹
        const groupedBySubject = {};
        questionCart.forEach((question, questionId) => {
            const subject = question.addedFrom?.subject || question.subject || 'æœªåˆ†ç±»';
            if (!groupedBySubject[subject]) {
                groupedBySubject[subject] = [];
            }
            groupedBySubject[subject].push(question);
        });
        
        let cartHtml = '';
        Object.entries(groupedBySubject).forEach(([subject, questions]) => {
            cartHtml += `
                <div class="mb-2">
                    <div class="text-xs font-medium text-purple-700">${subject} (${questions.length}é¢˜)</div>
                    <div class="text-xs text-gray-600 pl-2">
                        ${questions.map(q => `â€¢ ${(q.content || '').substring(0, 20)}...`).join('<br>')}
                    </div>
                </div>
            `;
        });
        
        cartPreviewElement.innerHTML = cartHtml;
    }
}

// è´­ç‰©è½¦ç›¸å…³å‡½æ•°
function addSelectedToCart() {
    if (selectedQuestions.size === 0) {
        showErrorMessage('è¯·å…ˆé€‰æ‹©é¢˜ç›®å†åŠ å…¥è´­ç‰©è½¦');
        return;
    }
    
    let addedCount = 0;
    selectedQuestions.forEach(questionId => {
        if (!questionCart.has(questionId)) {
            // ä»availableQuestionsä¸­æ‰¾åˆ°å¯¹åº”çš„é¢˜ç›®å¯¹è±¡
            const question = availableQuestions.find(q => q.id == questionId);
            if (question) {
                // æ·»åŠ æ¥æºä¿¡æ¯
                question.addedFrom = {
                    subject: document.getElementById('manualSubjectFilter').value || 'æœªæŒ‡å®š',
                    difficulty: document.getElementById('manualDifficultyFilter').value || 'æœªæŒ‡å®š',
                    type: document.getElementById('manualTypeFilter').value || 'æœªæŒ‡å®š'
                };
                questionCart.set(questionId, question);
                addedCount++;
            }
        }
    });
    
    // æ¸…ç©ºå½“å‰é€‰æ‹©
    selectedQuestions.clear();
    updateSelectedCount();
    updateCartDisplay();
    
    if (addedCount > 0) {
        showSuccessMessage(`å·²å°† ${addedCount} é¢˜åŠ å…¥è´­ç‰©è½¦`);
    } else {
        showErrorMessage('é€‰ä¸­çš„é¢˜ç›®å·²åœ¨è´­ç‰©è½¦ä¸­');
    }
}

function clearCart() {
    if (questionCart.size === 0) {
        showErrorMessage('è´­ç‰©è½¦å·²ä¸ºç©º');
        return;
    }
    
    const count = questionCart.size;
    questionCart.clear();
    updateCartDisplay();
    showSuccessMessage(`å·²æ¸…ç©ºè´­ç‰©è½¦ï¼Œç§»é™¤ ${count} é¢˜`);
}

function confirmCartSelection() {
    if (questionCart.size === 0) {
        showErrorMessage('è´­ç‰©è½¦ä¸ºç©ºï¼Œæ— æ³•ç¡®è®¤é€‰æ‹©');
        return;
    }
    
    // å°†è´­ç‰©è½¦ä¸­çš„é¢˜ç›®IDæ·»åŠ åˆ°æœ€ç»ˆé€‰æ‹©ä¸­
    selectedQuestions.clear();
    questionCart.forEach((question, questionId) => {
        selectedQuestions.add(questionId);
    });
    
    // æ›´æ–°é¢˜ç›®æ•°é‡è¾“å…¥æ¡†
    const totalQuestions = selectedQuestions.size;
    document.getElementById('configQuestions').value = totalQuestions;
    
    // æ¸…ç©ºè´­ç‰©è½¦
    questionCart.clear();
    
    // æ›´æ–°æ˜¾ç¤º
    updateSelectedCount();
    updateCartDisplay();
    
    console.log('ç¡®è®¤é€‰æ‹©çš„é¢˜ç›®ID:', Array.from(selectedQuestions)); // è°ƒè¯•æ—¥å¿—
    showSuccessMessage(`å·²ç¡®è®¤é€‰æ‹© ${totalQuestions} é¢˜åˆ°æœ€ç»ˆé¢˜ç›®åˆ—è¡¨ï¼Œå¯ä»¥ä¿å­˜é…ç½®äº†`);
}

// æ£€æŸ¥ç®¡ç†å‘˜æƒé™
async function checkAdminStatus() {
    try {
        const response = await fetch('/api/admin/status');
        const result = await response.json();
        
        if (!result.success || !result.is_admin) {
            alert('è¯·å…ˆç™»å½•ç®¡ç†å‘˜è´¦æˆ·');
            window.location.href = '/admin/login';
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å¤±è´¥:', error);
        alert('æƒé™éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
        window.location.href = '/admin/login';
        return false;
    }
}

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async function() {
// ç­‰å¾…å¤šè¯­è¨€åˆå§‹åŒ–å®Œæˆ
if (window.i18n && !window.i18n.initialized) {
await new Promise(resolve => {
document.addEventListener('i18n:initialized', resolve, { once: true });
});
}

// é¦–å…ˆæ£€æŸ¥ç®¡ç†å‘˜æƒé™
if (!(await checkAdminStatus())) {
    return; // å¦‚æœæƒé™éªŒè¯å¤±è´¥ï¼Œåœæ­¢åç»­åˆå§‹åŒ–
}

// ç¡®ä¿i18nç³»ç»Ÿå·²ç»å®Œå…¨åŠ è½½åå†åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
initEventListeners();
loadConfigs();
initializeSystemConfig();
});

// åˆå§‹åŒ–ç³»ç»Ÿé…ç½®
async function initializeSystemConfig() {
try {
// ç­‰å¾…i18nåˆå§‹åŒ–å®Œæˆ
if (typeof window.i18nManager !== 'undefined') {
await window.i18nManager.init();
} else {
// å¦‚æœi18næœªåŠ è½½ï¼Œè®¾ç½®ç›‘å¬å™¨
document.addEventListener('i18n:initialized', () => {
applySystemConfiguration();
});
}
await applySystemConfiguration();
} catch (error) {
console.error('åˆå§‹åŒ–ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
}
}

// åº”ç”¨ç³»ç»Ÿé…ç½®
async function applySystemConfiguration() {
try {
const response = await fetch('/api/system-config');
if (response.ok) {
const result = await response.json();
const config = result.data;

// åº”ç”¨logo
if (config.logo) {
const systemLogo = document.getElementById('systemLogo');
if (systemLogo) {
systemLogo.src = config.logo;
}
}

// åº”ç”¨è¯­è¨€è®¾ç½®
if (config.language && window.i18nManager) {
window.i18nManager.setLanguage(config.language);
}
}
} catch (error) {
console.error('åº”ç”¨ç³»ç»Ÿé…ç½®å¤±è´¥:', error);
}
}

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function initEventListeners() {
// è¯­è¨€åˆ‡æ¢æŒ‰é’®ç”± i18n.js è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨ç»‘å®š

// å¤šè¯­è¨€å˜åŒ–äº‹ä»¶ç›‘å¬
        document.addEventListener('i18n:languageChanged', () => {
            console.log('Language changed in exam config management page');
            // è¯­è¨€åˆ‡æ¢æŒ‰é’®çš„æ–‡æœ¬æ›´æ–°ç°åœ¨ç”± i18n.js è‡ªåŠ¨å¤„ç†
            // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨ä»¥åº”ç”¨æ–°è¯­è¨€
            loadConfigs();
            // æ›´æ–°é€‰æ‹©æ¡†é€‰é¡¹
            updateSelectOptions();
            // æ›´æ–°æ‰‹åŠ¨é€‰æ‹©çª—å£çš„ç¿»è¯‘
            updateManualSelectionTranslations();
        });

// æŒ‰é’®äº‹ä»¶
document.getElementById('addConfigBtn').addEventListener('click', showAddConfigModal);
document.getElementById('refreshBtn').addEventListener('click', loadConfigs);
document.getElementById('closeModalBtn').addEventListener('click', hideConfigModal);
document.getElementById('cancelBtn').addEventListener('click', hideConfigModal);
document.getElementById('configForm').addEventListener('submit', handleSaveConfig);

// æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼çš„äº‹ä»¶ç›‘å¬å™¨
document.getElementById('searchQuestionsBtn').addEventListener('click', loadQuestionsForManualSelection);
document.getElementById('selectAllQuestionsBtn').addEventListener('click', selectAllQuestions);
document.getElementById('clearSelectedBtn').addEventListener('click', clearSelectedQuestions);
document.getElementById('randomSelectBtn').addEventListener('click', randomSelectQuestions);
// æ–°çš„æ¨¡æ€çª—å£äº‹ä»¶ç›‘å¬å™¨
document.getElementById('openManualSelectionBtn').addEventListener('click', openManualSelectionModal);
document.getElementById('closeManualSelectionBtn').addEventListener('click', closeManualSelectionModal);
document.getElementById('closeAndConfirmBtn').addEventListener('click', closeAndConfirmSelection);
document.getElementById('clearAllSelectedBtn').addEventListener('click', clearAllSelectedQuestions);

// ä¿ç•™åŸæœ‰çš„æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼äº‹ä»¶ç›‘å¬å™¨ï¼ˆåœ¨æ¨¡æ€çª—å£å†…ï¼‰
document.getElementById('searchQuestionsBtn').addEventListener('click', loadQuestionsForManualSelection);
document.getElementById('selectAllQuestionsBtn').addEventListener('click', selectAllQuestions);
document.getElementById('clearSelectedBtn').addEventListener('click', clearSelectedQuestions);
document.getElementById('randomSelectBtn').addEventListener('click', randomSelectQuestions);
document.getElementById('addToCartBtn').addEventListener('click', addSelectedToCart);
document.getElementById('clearCartBtn').addEventListener('click', clearCart);
document.getElementById('confirmCartBtn').addEventListener('click', confirmCartSelection);

// ç²¾ç¡®æ•°é‡æ§åˆ¶ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
document.getElementById('openQuantityConfigBtn').addEventListener('click', openQuantityControlModal);
document.getElementById('closeQuantityModalBtn').addEventListener('click', closeQuantityControlModal);
document.getElementById('cancelQuantityConfigBtn').addEventListener('click', closeQuantityControlModal);
document.getElementById('confirmQuantityConfigBtn').addEventListener('click', confirmQuantityControlConfig);
document.getElementById('addQuantityConfigBtn').addEventListener('click', addQuantityConfig);
document.getElementById('autoGenerateConfigBtn').addEventListener('click', autoGenerateQuantityConfig);
document.getElementById('clearQuantityConfigBtn').addEventListener('click', clearQuantityConfig);

// é¢˜ç›®æ•°é‡è¾“å…¥æ¡†å˜åŒ–ç›‘å¬
document.getElementById('configQuestions').addEventListener('input', () => {
    updateTargetTotalCount();
    updateQuestionTypePreview();
});

// é¢˜å‹é€‰æ‹©å˜åŒ–ç›‘å¬
document.querySelectorAll('input[name="questionTypes"]').forEach(checkbox => {
    checkbox.addEventListener('change', updateQuestionTypePreview);
});

// è¯­è¨€åˆ‡æ¢æŒ‰é’®å·²ç”± i18n.js å…¨å±€å¤„ç†ï¼Œæ— éœ€å†æ¬¡ç»‘å®š

// ç­›é€‰æ¡ä»¶å˜åŒ–ç›‘å¬å™¨
document.getElementById('manualSubjectFilter').addEventListener('change', loadQuestionsForManualSelection);
document.getElementById('manualDifficultyFilter').addEventListener('change', loadQuestionsForManualSelection);
document.getElementById('manualTypeFilter').addEventListener('change', loadQuestionsForManualSelection);
document.getElementById('manualQuestionSearch').addEventListener('input', debounce(() => {
    loadQuestionsForManualSelection();
}, 300));

// é¢˜å‹åç§°æ˜ å°„å‡½æ•°
function getTypeName(type) {
    const typeMap = {
        'multiple_choice': 'é€‰æ‹©é¢˜',
        'short_answer': 'ç®€ç­”é¢˜',
        'programming': 'ç¼–ç¨‹é¢˜',
        'true_false': 'åˆ¤æ–­é¢˜',
        'fill_blank': 'å¡«ç©ºé¢˜',
        'essay': 'è®ºè¿°é¢˜'
    };
    return typeMap[type] || type;
}

// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    alertDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="ri-error-warning-line"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
    alertDiv.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="ri-check-line"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 3000);
}

// =============  è´­ç‰©è½¦ç³»ç»Ÿå‡½æ•° =============

// å°†å·²é€‰æ‹©çš„é¢˜ç›®æ·»åŠ åˆ°è´­ç‰©è½¦
function addSelectedToCart() {
    if (selectedQuestions.size === 0) {
        showErrorMessage('è¯·å…ˆé€‰æ‹©é¢˜ç›®å†åŠ å…¥è´­ç‰©è½¦');
        return;
    }
    
    let addedCount = 0;
    let duplicateCount = 0;
    
    // å°†é€‰ä¸­çš„é¢˜ç›®æ·»åŠ åˆ°è´­ç‰©è½¦
    selectedQuestions.forEach(questionId => {
        if (questionCart.has(questionId)) {
            duplicateCount++;
        } else {
            // æ‰¾åˆ°å¯¹åº”çš„é¢˜ç›®å¯¹è±¡
            const question = availableQuestions.find(q => q.id === questionId);
            if (question) {
                questionCart.set(questionId, {
                    ...question,
                    addedFrom: {
                        subject: document.getElementById('manualSubjectFilter').value || 'æœªæŒ‡å®š',
                        difficulty: document.getElementById('manualDifficultyFilter').value || 'æœªæŒ‡å®š',
                        type: document.getElementById('manualTypeFilter').value || 'æœªæŒ‡å®š'
                    }
                });
                addedCount++;
            }
        }
    });
    
    // æ¸…ç©ºå½“å‰é€‰æ‹©
    selectedQuestions.clear();
    updateSelectedCount();
    renderQuestionsForSelection();
    
    // æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤º
    updateCartDisplay();
    
    // æ˜¾ç¤ºç»“æœä¿¡æ¯
    if (addedCount > 0) {
        let message = `æˆåŠŸåŠ å…¥è´­ç‰©è½¦ ${addedCount} é¢˜`;
        if (duplicateCount > 0) {
            message += `ï¼Œè·³è¿‡é‡å¤é¢˜ç›® ${duplicateCount} é¢˜`;
        }
        showSuccessMessage(message);
    } else if (duplicateCount > 0) {
        showErrorMessage(`æ‰€é€‰é¢˜ç›®å·²åœ¨è´­ç‰©è½¦ä¸­ï¼Œè·³è¿‡ ${duplicateCount} é¢˜`);
    }
}

// æ¸…ç©ºè´­ç‰©è½¦
function clearCart() {
    if (questionCart.size === 0) {
        showErrorMessage('è´­ç‰©è½¦å·²ä¸ºç©º');
        return;
    }
    
    const count = questionCart.size;
    questionCart.clear();
    updateCartDisplay();
    showSuccessMessage(`å·²æ¸…ç©ºè´­ç‰©è½¦ï¼Œç§»é™¤ ${count} é¢˜`);
}

// ç¡®è®¤è´­ç‰©è½¦é€‰æ‹©ï¼ˆå°†è´­ç‰©è½¦å†…å®¹åº”ç”¨åˆ°æœ€ç»ˆé€‰æ‹©ï¼‰
function confirmCartSelection() {
    if (questionCart.size === 0) {
        showErrorMessage('è´­ç‰©è½¦ä¸ºç©ºï¼Œæ— æ³•ç¡®è®¤é€‰æ‹©');
        return;
    }
    
    // å°†è´­ç‰©è½¦ä¸­çš„é¢˜ç›®IDæ·»åŠ åˆ°æœ€ç»ˆé€‰æ‹©ä¸­
    selectedQuestions.clear();
    questionCart.forEach((question, questionId) => {
        selectedQuestions.add(questionId);
    });
    
    // æ›´æ–°é¢˜ç›®æ•°é‡è¾“å…¥æ¡†
    const totalQuestions = selectedQuestions.size;
    document.getElementById('configQuestions').value = totalQuestions;
    
    // æ¸…ç©ºè´­ç‰©è½¦
    questionCart.clear();
    
    // æ›´æ–°æ˜¾ç¤º
    updateSelectedCount();
    updateCartDisplay();
    
    console.log('ç¡®è®¤é€‰æ‹©çš„é¢˜ç›®ID:', Array.from(selectedQuestions)); // è°ƒè¯•æ—¥å¿—
    showSuccessMessage(`å·²ç¡®è®¤é€‰æ‹© ${totalQuestions} é¢˜åˆ°æœ€ç»ˆé¢˜ç›®åˆ—è¡¨ï¼Œå¯ä»¥ä¿å­˜é…ç½®äº†`);
}

// æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤º
function updateCartDisplay() {
    const cartCountElement = document.getElementById('cartCount');
    const cartPreviewElement = document.getElementById('cartPreview');
    
    const cartSize = questionCart.size;
    if (cartCountElement) cartCountElement.textContent = cartSize;
    
    if (!cartPreviewElement) return;
    
    if (cartSize === 0) {
        const emptyText = window.i18n && window.i18n.initialized 
            ? window.i18n.translate('cart.empty_desc', 'è´­ç‰©è½¦ä¸ºç©ºï¼Œé€‰æ‹©é¢˜ç›®åç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"')
            : 'è´­ç‰©è½¦ä¸ºç©ºï¼Œé€‰æ‹©é¢˜ç›®åç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"';
            
        cartPreviewElement.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                <i class="ri-shopping-cart-line text-2xl mb-1 block"></i>
                <div class="text-xs">${emptyText}</div>
            </div>
        `;
    } else {
        // æŒ‰ç§‘ç›®åˆ†ç»„æ˜¾ç¤ºè´­ç‰©è½¦å†…å®¹
        const groupedBySubject = {};
        questionCart.forEach((question, questionId) => {
            const subject = question.addedFrom?.subject || question.subject || 'æœªåˆ†ç±»';
            if (!groupedBySubject[subject]) {
                groupedBySubject[subject] = [];
            }
            groupedBySubject[subject].push(question);
        });
        
        const questionsUnit = window.i18n && window.i18n.initialized
            ? window.i18n.translate('manual.questions_unit', 'é¢˜')
            : 'é¢˜';
        
        let cartHtml = '';
        Object.keys(groupedBySubject).forEach(subject => {
            const questions = groupedBySubject[subject];
            cartHtml += `
                <div class="mb-2 p-2 bg-white rounded border border-blue-100">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-medium text-blue-700">${subject}</span>
                        <span class="text-xs text-blue-600">${questions.length}${questionsUnit}</span>
                    </div>
                    <div class="text-xs text-gray-600">
                        ${questions.map(q => {
                            const content = (q.content || '').length > 30 ? (q.content || '').substring(0, 30) + '...' : (q.content || '');
                            return `â€¢ ${content}`;
                        }).join('<br>')}
                    </div>
                </div>
            `;
        });
        
        cartPreviewElement.innerHTML = cartHtml;
    }
}

// æ›´æ–°æ‰‹åŠ¨é€‰æ‹©çª—å£çš„ç¿»è¯‘
function updateManualSelectionTranslations() {
    if (!window.i18n || !window.i18n.initialized) return;
    
    // æ›´æ–°é€‰æ‹©æ¡†é€‰é¡¹çš„ç¿»è¯‘
    const subjectOptions = document.querySelectorAll('#manualSubjectFilter option');
    subjectOptions.forEach(option => {
        if (option.value === '') {
            option.textContent = window.i18n.translate('manual.all_subjects', 'æ‰€æœ‰å­¦ç§‘');
        }
    });
    
    const difficultyOptions = document.querySelectorAll('#manualDifficultyFilter option');
    difficultyOptions.forEach(option => {
        if (option.value === '') {
            option.textContent = window.i18n.translate('manual.all_difficulties', 'æ‰€æœ‰éš¾åº¦');
        }
    });
    
    const typeOptions = document.querySelectorAll('#manualTypeFilter option');
    typeOptions.forEach(option => {
        if (option.value === '') {
            option.textContent = window.i18n.translate('manual.all_types', 'æ‰€æœ‰é¢˜å‹');
        }
    });
    
    // æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤º
    updateCartDisplay();
}

// æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤ºçš„ç¿»è¯‘æ–‡æœ¬
function updateCartDisplayTranslations() {
    const cartPreviewElement = document.getElementById('cartPreview');
    if (!cartPreviewElement || !window.i18n) return;
    
    if (questionCart.size === 0) {
        cartPreviewElement.innerHTML = `
            <div class="text-center text-gray-500 py-4">
                <i class="ri-shopping-cart-line text-2xl mb-1 block"></i>
                <div class="text-xs">${window.i18n.translate('cart.empty_desc', 'è´­ç‰©è½¦ä¸ºç©ºï¼Œé€‰æ‹©é¢˜ç›®åç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"')}</div>
            </div>
        `;
    }
}

// é¡µé¢ä¸“ç”¨çš„æ‰‹åŠ¨é€‰æ‹©çª—å£ç¿»è¯‘æ›´æ–°ï¼ˆç®€åŒ–ç‰ˆï¼‰
function updateManualWindowTranslations() {
    if (!window.i18n || !window.i18n.initialized) return;
    
    // æ›´æ–°ç©ºçŠ¶æ€æ–‡æœ¬
    const emptyStates = document.querySelectorAll('#manualQuestionsList .text-center');
    emptyStates.forEach(state => {
        if (state.textContent.includes('å‡†å¤‡å¼€å§‹ç­›é€‰é¢˜ç›®')) {
            state.querySelector('h4').textContent = window.i18n.translate('questions.empty_title', 'å‡†å¤‡å¼€å§‹ç­›é€‰é¢˜ç›®');
            state.querySelector('p').textContent = window.i18n.translate('questions.empty_desc', 'è®¾ç½®ç­›é€‰æ¡ä»¶åç‚¹å‡»"æœç´¢é¢˜ç›®"æŒ‰é’®');
        }
    });
    
    // æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤ºç¿»è¯‘
    updateCartDisplayTranslations();
}

// å¼€æ‰“æ‰‹åŠ¨é€‰æ‹©æ¨¡æ€çª—å£æ—¶æ›´æ–°ç¿»è¯‘
function ensureManualModalTranslations() {
    // ç¡®ä¿æ¨¡æ€çª—å£æ‰“å¼€æ—¶æ›´æ–°ç¿»è¯‘
    setTimeout(() => {
        updateManualSelectionTranslations();
        updateManualWindowTranslations();
    }, 100);
}

// æ‰‹åŠ¨é€‰æ‹©æ¨¡æ€çª—å£ç›¸å…³å‡½æ•°
function openManualSelectionModal() {
    const modal = document.getElementById('manualSelectionModal');
    modal.classList.remove('hidden');
    
    // æ¸…ç©ºä¹‹å‰çš„æœç´¢ç»“æœ
    const questionsList = document.getElementById('manualQuestionsList');
    questionsList.innerHTML = `
        <div class="text-center text-gray-500 py-12">
            <i class="ri-search-line text-4xl mb-4 block text-gray-300"></i>
            <h4 class="text-lg font-medium mb-2" data-i18n="questions.empty_title">å‡†å¤‡å¼€å§‹ç­›é€‰é¢˜ç›®</h4>
            <p class="text-sm text-gray-400" data-i18n="questions.empty_desc">è®¾ç½®ç­›é€‰æ¡ä»¶åç‚¹å‡»"æœç´¢é¢˜ç›®"æŒ‰é’®</p>
        </div>
    `;
    
    // ç¡®ä¿æ¨¡æ€çª—å£æ‰“å¼€æ—¶æ›´æ–°ç¿»è¯‘
    ensureManualModalTranslations();
}

function closeManualSelectionModal() {
    const modal = document.getElementById('manualSelectionModal');
    modal.classList.add('hidden');
}

function closeAndConfirmSelection() {
    // å…ˆç¡®è®¤è´­ç‰©è½¦ä¸­çš„é€‰æ‹©
    if (questionCart.size > 0) {
        confirmCartSelection();
    }
    // ç„¶åå…³é—­æ¨¡æ€çª—å£
    closeManualSelectionModal();
}

function clearAllSelectedQuestions() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å·²é€‰æ‹©çš„é¢˜ç›®å—ï¼Ÿ')) {
        selectedQuestions.clear();
        questionCart.clear();
        updateSelectedCount();
        updateCartDisplay();
        // æ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤º
        const mainSelectedCount = document.querySelector('#manualMode #manualSelectedCount');
        if (mainSelectedCount) {
            mainSelectedCount.textContent = '0 é¢˜';
        }
        showSuccessMessage('å·²æ¸…ç©ºæ‰€æœ‰é€‰æ‹©');
    }
}

// ç™»å‡º
document.getElementById('logoutBtn').addEventListener('click', handleLogout);
}

// æ›´æ–°selecté€‰é¡¹çš„ç¿»è¯‘
function updateSelectOptions() {
if (!window.i18n || !window.i18n.initialized) return;

// æ›´æ–°é¢˜ç›®é€‰æ‹©æ¨¡å¼çš„é€‰é¡¹
const questionSelectionMode = document.getElementById('questionSelectionMode');
if (questionSelectionMode) {
const filterOption = questionSelectionMode.querySelector('option[value="filter"]');
const manualOption = questionSelectionMode.querySelector('option[value="manual"]');
if (filterOption) filterOption.textContent = window.i18n.translate('exam.config.filter_mode', 'ç­›é€‰æ¨¡å¼');
if (manualOption) manualOption.textContent = window.i18n.translate('exam.config.manual_mode', 'æ‰‹åŠ¨é€‰æ‹©');
}
}

// åŠ è½½é…ç½®åˆ—è¡¨
async function loadConfigs() {
try {
showLoading(true);
const response = await fetch('/api/exam-configs');
const result = await response.json();

if (result.success) {
currentConfigs = result.configs;
updateConfigsList(result.configs);
updateStatistics(result.configs);
showLoading(false);
} else {
showError('åŠ è½½é…ç½®å¤±è´¥: ' + result.message);
showLoading(false);
}
} catch (error) {
console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
showError('åŠ è½½é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
showLoading(false);
}
}

// æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
function showLoading(show) {
const loadingState = document.getElementById('loadingState');
const configsContainer = document.getElementById('configsContainer');
const emptyState = document.getElementById('emptyState');

if (show) {
loadingState.classList.remove('hidden');
configsContainer.classList.add('hidden');
emptyState.classList.add('hidden');
} else {
loadingState.classList.add('hidden');
configsContainer.classList.remove('hidden');
}
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStatistics(configs) {
const totalConfigs = configs.length;
const activeConfigs = configs.filter(c => c.is_active).length;
const defaultConfig = configs.find(c => c.is_default);
const showResultsCount = configs.filter(c => c.show_results !== false).length;

document.getElementById('totalConfigs').textContent = totalConfigs;
document.getElementById('activeConfigs').textContent = activeConfigs;
document.getElementById('defaultConfigName').textContent = defaultConfig ? defaultConfig.name : 'æ— ';
document.getElementById('showResultsCount').textContent = showResultsCount;
document.getElementById('totalCount').textContent = totalConfigs;
}

// æ›´æ–°é…ç½®åˆ—è¡¨
function updateConfigsList(configs) {
const container = document.getElementById('configsContainer');
const emptyState = document.getElementById('emptyState');

if (configs.length === 0) {
container.classList.add('hidden');
emptyState.classList.remove('hidden');
return;
}

container.classList.remove('hidden');
emptyState.classList.add('hidden');

container.innerHTML = configs.map(config => `
<div class="config-card card p-6 ${config.is_default ? 'default' : ''} ${!config.is_active ? 'inactive' : ''}">
<div class="flex items-start justify-between">
<div class="flex-1">
<div class="flex items-center space-x-3 mb-3">
<h3 class="text-lg font-semibold text-gray-900">${config.name}</h3>
            ${config.is_default ? `<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.current', 'å½“å‰é…ç½®') : 'å½“å‰é…ç½®'}</span>` : ''}
${config.is_active ? `<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.active', 'å·²å¯ç”¨') : 'å·²å¯ç”¨'}</span>` : `<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.inactive', 'æœªå¯ç”¨') : 'æœªå¯ç”¨'}</span>`}
${config.show_results !== false ? `<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.show_results', 'æ˜¾ç¤ºæˆç»©') : 'æ˜¾ç¤ºæˆç»©'}</span>` : `<span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.status.hide_results', 'ä¸æ˜¾ç¤ºæˆç»©') : 'ä¸æ˜¾ç¤ºæˆç»©'}</span>`}
</div>
<p class="text-sm text-gray-600 mb-4">${config.description || 'æš‚æ— æè¿°'}</p>

<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-lg font-semibold text-gray-900">${config.total_questions}</div>
<div class="text-xs text-gray-600">${window.i18n ? window.i18n.translate('exam.config.question_count_short', 'é¢˜ç›®æ•°é‡') : 'é¢˜ç›®æ•°é‡'}</div>
</div>
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-lg font-semibold text-gray-900">${config.time_limit}${window.i18n ? window.i18n.translate('exam.config.minutes', 'åˆ†') : 'åˆ†'}</div>
<div class="text-xs text-gray-600">${window.i18n ? window.i18n.translate('exam.config.time_limit_short', 'æ—¶é—´é™åˆ¶') : 'æ—¶é—´é™åˆ¶'}</div>
</div>
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-sm font-medium text-gray-900">${config.subject_filter || (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.no_limit', 'ä¸é™åˆ¶') : 'ä¸é™åˆ¶')}</div>
<div class="text-xs text-gray-600">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.subject_filter', 'å­¦ç§‘ç­›é€‰') : 'å­¦ç§‘ç­›é€‰'}</div>
</div>
<div class="bg-gray-50 p-3 rounded-lg">
<div class="text-sm font-medium text-gray-900">${formatDifficultyFilter(config.difficulty_filter)}</div>
<div class="text-xs text-gray-600">${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.difficulty_filter', 'éš¾åº¦ç­›é€‰') : 'éš¾åº¦ç­›é€‰'}</div>
</div>
</div>
</div>

<div class="flex flex-col space-y-2 ml-4">
<!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
<div class="flex space-x-2">
<button onclick="editConfig(${config.id})" class="action-button bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm">
<i class="ri-edit-line mr-1"></i>${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.edit', 'ç¼–è¾‘') : 'ç¼–è¾‘'}
</button>
                <button onclick="toggleDefault(${config.id})" class="action-button ${config.is_default ? 'bg-gray-500' : 'bg-green-500'} text-white px-4 py-2 rounded-lg hover:opacity-80 text-sm">
                <i class="ri-star-line mr-1"></i>${config.is_default ? 
                    (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.unset_current', 'å–æ¶ˆå½“å‰é…ç½®') : 'å–æ¶ˆå½“å‰é…ç½®') : 
                    (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.set_current', 'è®¾ä¸ºå½“å‰é…ç½®') : 'è®¾ä¸ºå½“å‰é…ç½®')
                }
                </button>
</div>
<div class="flex space-x-2">
<button onclick="toggleActive(${config.id})" class="action-button ${config.is_active ? 'bg-orange-500' : 'bg-green-500'} text-white px-4 py-2 rounded-lg hover:opacity-80 text-sm">
<i class="ri-toggle-line mr-1"></i>${config.is_active ? 
                    (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.disable', 'ç¦ç”¨') : 'ç¦ç”¨') : 
                    (window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.enable', 'å¯ç”¨') : 'å¯ç”¨')
                }
</button>
<button onclick="deleteConfig(${config.id})" class="action-button bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">
<i class="ri-delete-bin-line mr-1"></i>${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.delete', 'åˆ é™¤') : 'åˆ é™¤'}
</button>
</div>
</div>
</div>

<div class="text-xs text-gray-500 mt-4 pt-4 border-t">
${window.i18n && window.i18n.initialized ? window.i18n.translate('exam.config.created_time', 'åˆ›å»ºæ—¶é—´') : 'åˆ›å»ºæ—¶é—´'}ï¼š${formatDate(config.created_at)}
</div>
</div>
`).join('');
}

// å¿«é€Ÿåˆ‡æ¢é»˜è®¤é…ç½®
async function toggleDefault(configId) {
try {
const config = currentConfigs.find(c => c.id === configId);
const newDefaultState = !config.is_default;

const response = await fetch(`/api/exam-configs/${configId}`, {
method: 'PUT',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ is_default: newDefaultState })
});

const result = await response.json();
        if (result.success) {
        showSuccess(newDefaultState ? 
            (window.i18n ? window.i18n.translate('exam.config.set_as_current_success', 'å·²è®¾ä¸ºå½“å‰è€ƒè¯•é…ç½®') : 'å·²è®¾ä¸ºå½“å‰è€ƒè¯•é…ç½®') : 
            (window.i18n ? window.i18n.translate('exam.config.unset_current_success', 'å·²å–æ¶ˆå½“å‰è€ƒè¯•é…ç½®') : 'å·²å–æ¶ˆå½“å‰è€ƒè¯•é…ç½®'));
        loadConfigs(); // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨
        } else {
showError('æ“ä½œå¤±è´¥: ' + result.message);
}
} catch (error) {
console.error('åˆ‡æ¢é»˜è®¤é…ç½®å¤±è´¥:', error);
showError('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
}
}

// å¿«é€Ÿåˆ‡æ¢å¯ç”¨çŠ¶æ€
async function toggleActive(configId) {
try {
const config = currentConfigs.find(c => c.id === configId);
const newActiveState = !config.is_active;

const response = await fetch(`/api/exam-configs/${configId}`, {
method: 'PUT',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ is_active: newActiveState })
});

const result = await response.json();
if (result.success) {
showSuccess(newActiveState ? 'é…ç½®å·²å¯ç”¨' : 'é…ç½®å·²ç¦ç”¨');
loadConfigs(); // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨
} else {
showError('æ“ä½œå¤±è´¥: ' + result.message);
}
} catch (error) {
console.error('åˆ‡æ¢é…ç½®çŠ¶æ€å¤±è´¥:', error);
showError('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
}
}

// æ˜¾ç¤ºæ·»åŠ é…ç½®æ¨¡æ€æ¡†
function showAddConfigModal() {
editingConfigId = null;
document.getElementById('modalTitle').textContent = window.i18n ? window.i18n.translate('exam.config.modal_title', 'æ–°å»ºè€ƒè¯•é…ç½®') : 'æ–°å»ºè€ƒè¯•é…ç½®';
document.getElementById('saveText').textContent = window.i18n ? window.i18n.translate('exam.config.save_config', 'ä¿å­˜é…ç½®') : 'ä¿å­˜é…ç½®';

// é‡ç½®è¡¨å•
document.getElementById('configForm').reset();
document.getElementById('configQuestions').value = 5;
document.getElementById('configTimeLimit').value = 75;
document.getElementById('configPassingScore').value = 60;
document.getElementById('configIsActive').checked = true;
document.getElementById('configShowResults').checked = true;
document.getElementById('questionSelectionMode').value = 'filter';

// é‡ç½®ç²¾ç¡®æ•°é‡æ§åˆ¶
document.getElementById('enableQuantityControl').checked = false;
quantityDistribution = {};
toggleQuantityControl();

// é‡ç½®é¢˜ç›®é€‰æ‹©
selectedQuestions.clear();
updateSelectedCount();
toggleQuestionSelectionMode();

// æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶
document.querySelectorAll('.subject-filter, .difficulty-filter, .type-filter').forEach(checkbox => {
checkbox.checked = false;
});

document.getElementById('configModal').classList.remove('hidden');
}

// ç¼–è¾‘é…ç½®
async function editConfig(configId) {
const config = currentConfigs.find(c => c.id === configId);
if (!config) return;

editingConfigId = configId;
document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é…ç½®';
document.getElementById('saveText').textContent = 'æ›´æ–°é…ç½®';

// å¡«å……åŸºæœ¬è¡¨å•
document.getElementById('configName').value = config.name;
document.getElementById('configDescription').value = config.description || '';
document.getElementById('configQuestions').value = config.total_questions;
document.getElementById('configTimeLimit').value = config.time_limit;
document.getElementById('configPassingScore').value = config.passing_score || 60;
document.getElementById('configIsDefault').checked = config.is_default;
document.getElementById('configIsActive').checked = config.is_active;
document.getElementById('configShowResults').checked = config.show_results !== false;
document.getElementById('questionSelectionMode').value = config.question_selection_mode || 'filter';

// åŠ è½½ç²¾ç¡®æ•°é‡æ§åˆ¶é…ç½®
document.getElementById('enableQuantityControl').checked = config.enable_quantity_control || false;
quantityDistribution = config.quantity_distribution || {};
toggleQuantityControl();
updateQuantityConfigDisplay();

// é‡ç½®é¢˜ç›®é€‰æ‹©
selectedQuestions.clear();

// å¦‚æœæ˜¯æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼ï¼ŒåŠ è½½é€‰ä¸­çš„é¢˜ç›®
if (config.question_selection_mode === 'manual') {
try {
    const response = await fetch(`/api/exam-configs/${configId}/questions`);
    const result = await response.json();
    if (result.success && result.questions) {
        result.questions.forEach(cq => {
            if (cq.question_id) {
                selectedQuestions.add(cq.question_id);
            }
        });
    }
} catch (error) {
    console.error('åŠ è½½é…ç½®é¢˜ç›®å¤±è´¥:', error);
}
}

// è®¾ç½®é¢˜ç›®é€‰æ‹©æ¨¡å¼
toggleQuestionSelectionMode();
updateSelectedCount();

// è®¾ç½®ç­›é€‰æ¡ä»¶
const subjects = config.subject_filter ? config.subject_filter.split(',').map(s => s.trim()) : [];
document.querySelectorAll('.subject-filter').forEach(checkbox => {
checkbox.checked = subjects.includes(checkbox.value);
});

const difficulties = config.difficulty_filter ? config.difficulty_filter.split(',').map(d => d.trim()) : [];
document.querySelectorAll('.difficulty-filter').forEach(checkbox => {
checkbox.checked = difficulties.includes(checkbox.value);
});

const types = config.type_filter ? config.type_filter.split(',').map(t => t.trim()) : [];
document.querySelectorAll('.type-filter').forEach(checkbox => {
checkbox.checked = types.includes(checkbox.value);
});

document.getElementById('configModal').classList.remove('hidden');
}

// éšè—é…ç½®æ¨¡æ€æ¡†
function hideConfigModal() {
document.getElementById('configModal').classList.add('hidden');
editingConfigId = null;
selectedQuestions.clear();
questionCart.clear(); // æ¸…ç©ºè´­ç‰©è½¦
updateSelectedCount();
updateCartDisplay();
}

// é¢˜ç›®é€‰æ‹©æ¨¡å¼åˆ‡æ¢
function toggleQuestionSelectionMode() {
const mode = document.getElementById('questionSelectionMode').value;
const filterMode = document.getElementById('filterMode');
const manualMode = document.getElementById('manualMode');
const questionSectionTitle = document.getElementById('questionSectionTitle');

if (mode === 'manual') {
    filterMode.classList.add('hidden');
    manualMode.classList.remove('hidden');
    questionSectionTitle.textContent = 'ç²¾ç¡®é€‰æ‹©é¢˜ç›®';
    // è‡ªåŠ¨åŠ è½½é¢˜ç›®åˆ—è¡¨
    loadQuestionsForManualSelection();
    // åˆå§‹åŒ–è´­ç‰©è½¦æ˜¾ç¤º
    updateCartDisplay();
} else {
    filterMode.classList.remove('hidden');
    manualMode.classList.add('hidden');
    questionSectionTitle.textContent = 'é¢˜ç›®ç­›é€‰';
    selectedQuestions.clear();
    updateSelectedCount();
}
}

// åŠ è½½é¢˜ç›®ç”¨äºæ‰‹åŠ¨é€‰æ‹©
async function loadQuestionsForManualSelection() {
try {
    showQuestionsLoading();
    
    const params = new URLSearchParams();
    
    // åªæ·»åŠ éç©ºçš„å‚æ•°
    const subject = document.getElementById('manualSubjectFilter').value;
    const difficulty = document.getElementById('manualDifficultyFilter').value;
    const type = document.getElementById('manualTypeFilter').value;
    const search = document.getElementById('manualQuestionSearch').value;
    
    if (subject) params.append('subject', subject);
    if (difficulty) params.append('difficulty', difficulty);
    if (type) params.append('type', type);
    if (search) params.append('search', search);
    params.append('is_active', 'true');
    params.append('per_page', '100'); // å¢åŠ æ¯é¡µæ•°é‡ä»¥ä¾¿ç­›é€‰

    const response = await fetch(`/api/questions?${params}`);
    const result = await response.json();

    if (result.success) {
        availableQuestions = result.questions;
        renderQuestionsForSelection();
    } else {
        showErrorMessage('åŠ è½½é¢˜ç›®å¤±è´¥: ' + result.message);
    }
} catch (error) {
    console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
    showErrorMessage('åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·é‡è¯•');
} finally {
    hideQuestionsLoading();
}
}

// æ˜¾ç¤ºé¢˜ç›®åŠ è½½çŠ¶æ€
function showQuestionsLoading() {
const container = document.getElementById('manualQuestionsList');
container.innerHTML = `
    <div class="text-center text-gray-500 py-8">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-3"></div>
        <div class="text-sm">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
    </div>
`;
}

// éšè—é¢˜ç›®åŠ è½½çŠ¶æ€
function hideQuestionsLoading() {
// åŠ è½½çŠ¶æ€ä¼šåœ¨renderQuestionsForSelectionä¸­è¢«æ›¿æ¢
}

// æ¸²æŸ“é¢˜ç›®é€‰æ‹©åˆ—è¡¨
function renderQuestionsForSelection() {
const container = document.getElementById('manualQuestionsList');
container.innerHTML = '';

// æ›´æ–°å¯ç”¨é¢˜ç›®æ•°é‡æ˜¾ç¤º
const availableCountElement = document.getElementById('manualAvailableCount');
if (availableCountElement) {
    availableCountElement.textContent = `ç­›é€‰ç»“æœ: ${availableQuestions.length} é¢˜`;
}

// æ™ºèƒ½è°ƒæ•´éšæœºé€‰å–æ•°é‡çš„å»ºè®®å€¼
const randomCountInput = document.getElementById('randomSelectCount');
if (randomCountInput && availableQuestions.length > 0) {
    const currentValue = parseInt(randomCountInput.value) || 5;
    const maxValue = Math.min(availableQuestions.length, 100);
    randomCountInput.max = maxValue;
    
    // å¦‚æœå½“å‰å€¼è¶…è¿‡å¯ç”¨æ•°é‡ï¼Œè‡ªåŠ¨è°ƒæ•´ä¸ºå»ºè®®å€¼
    if (currentValue > availableQuestions.length) {
        const suggestedValue = Math.min(Math.max(Math.floor(availableQuestions.length * 0.3), 1), availableQuestions.length);
        randomCountInput.value = suggestedValue;
    }
    
    // æ›´æ–°æç¤ºæ–‡æœ¬
    randomCountInput.title = `è¾“å…¥è¦éšæœºé€‰æ‹©çš„é¢˜ç›®æ•°é‡ (æœ€å¤š${maxValue}é¢˜)`;
}

if (availableQuestions.length === 0) {
    const noQuestionsText = window.i18n && window.i18n.initialized
        ? window.i18n.translate('questions.no_questions', 'æš‚æ— é¢˜ç›®')
        : 'æš‚æ— é¢˜ç›®';
    const adjustFilterText = window.i18n && window.i18n.initialized
        ? window.i18n.translate('questions.adjust_filter', 'è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ·»åŠ æ–°é¢˜ç›®')
        : 'è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ·»åŠ æ–°é¢˜ç›®';
        
    container.innerHTML = `
        <div class="text-center text-gray-500 py-8">
            <i class="ri-question-line text-3xl mb-3 block"></i>
            <div class="text-sm">${noQuestionsText}</div>
            <div class="text-xs text-gray-400 mt-1">${adjustFilterText}</div>
        </div>
    `;
    return;
}

availableQuestions.forEach(question => {
    const isSelected = selectedQuestions.has(question.id);
    const questionDiv = document.createElement('div');
    questionDiv.className = `group p-3 border rounded-lg cursor-pointer transition-all duration-200 ${
        isSelected 
        ? 'border-primary bg-blue-50 shadow-sm' 
        : 'border-gray-200 hover:border-gray-300 hover:shadow-sm'
    }`;
    questionDiv.onclick = (e) => {
        if (e.target.type === 'checkbox') return;
        toggleQuestionSelection(question.id);
    };
    
    questionDiv.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-shrink-0 mt-1">
                <input type="checkbox" ${isSelected ? 'checked' : ''} 
                onchange="toggleQuestionSelection(${question.id})"
                class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded transition-colors">
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-gray-900 leading-relaxed mb-2" title="${question.content}">
                    ${question.content.length > 120 ? question.content.substring(0, 120) + '...' : question.content}
                </div>
                <div class="flex flex-wrap gap-2 mb-2">
                    <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${question.subject}</span>
                    <span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">${question.difficulty}</span>
                    <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">${getTypeName(question.question_type || question.type)}</span>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${window.i18n && window.i18n.initialized ? window.i18n.translate('question.points', 'åˆ†å€¼') : 'åˆ†å€¼'}: ${question.points || 1}${window.i18n && window.i18n.initialized ? window.i18n.translate('question.points_unit', 'åˆ†') : 'åˆ†'}</span>
                    ${isSelected ? `<span class="text-primary font-medium"><i class="ri-check-line mr-1"></i>${window.i18n && window.i18n.initialized ? window.i18n.translate('question.selected', 'å·²é€‰æ‹©') : 'å·²é€‰æ‹©'}</span>` : ''}
                </div>
            </div>
        </div>
    `;
    container.appendChild(questionDiv);
});

updateSelectedCount();
}

// åˆ‡æ¢é¢˜ç›®é€‰æ‹©çŠ¶æ€
function toggleQuestionSelection(questionId) {
if (selectedQuestions.has(questionId)) {
    selectedQuestions.delete(questionId);
} else {
    selectedQuestions.add(questionId);
}
updateSelectedCount();
renderQuestionsForSelection();
}

// å…¨é€‰é¢˜ç›®
function selectAllQuestions() {
availableQuestions.forEach(question => {
    selectedQuestions.add(question.id);
});
updateSelectedCount();
renderQuestionsForSelection();
}

// æ¸…ç©ºé€‰æ‹©
function clearSelectedQuestions() {
selectedQuestions.clear();
updateSelectedCount();
renderQuestionsForSelection();
}

// éšæœºé€‰å–æŒ‡å®šæ•°é‡çš„é¢˜ç›®
function randomSelectQuestions() {
    const countInput = document.getElementById('randomSelectCount');
    const requestedCount = parseInt(countInput.value) || 5;
    
    if (availableQuestions.length === 0) {
        showErrorMessage('è¯·å…ˆæœç´¢é¢˜ç›®å†ä½¿ç”¨éšæœºé€‰å–åŠŸèƒ½');
        return;
    }
    
    if (requestedCount > availableQuestions.length) {
        showErrorMessage(`è¦æ±‚é€‰æ‹©${requestedCount}é¢˜ï¼Œä½†ç­›é€‰ç»“æœåªæœ‰${availableQuestions.length}é¢˜ã€‚è¯·å‡å°‘æ•°é‡æˆ–è°ƒæ•´ç­›é€‰æ¡ä»¶ã€‚`);
        return;
    }
    
    if (requestedCount <= 0) {
        showErrorMessage('é€‰æ‹©æ•°é‡å¿…é¡»å¤§äº0');
        return;
    }
    
    // æ¸…ç©ºå½“å‰é€‰æ‹©
    selectedQuestions.clear();
    
    // åˆ›å»ºå¯ç”¨é¢˜ç›®IDçš„å‰¯æœ¬å¹¶éšæœºæ‰“ä¹±
    const shuffledQuestionIds = [...availableQuestions.map(q => q.id)];
    
    // Fisher-Yates æ´—ç‰Œç®—æ³•
    for (let i = shuffledQuestionIds.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledQuestionIds[i], shuffledQuestionIds[j]] = [shuffledQuestionIds[j], shuffledQuestionIds[i]];
    }
    
    // é€‰æ‹©å‰ requestedCount ä¸ªé¢˜ç›®
    for (let i = 0; i < requestedCount; i++) {
        selectedQuestions.add(shuffledQuestionIds[i]);
    }
    
    // æ›´æ–°æ˜¾ç¤º
    updateSelectedCount();
    renderQuestionsForSelection();
    
    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    showSuccessMessage(`å·²éšæœºé€‰æ‹©${requestedCount}é¢˜ï¼ˆä»${availableQuestions.length}é¢˜ä¸­é€‰å–ï¼‰ï¼Œç‚¹å‡»"åŠ å…¥è´­ç‰©è½¦"ä»¥ä¿å­˜é€‰æ‹©`);
}

// æ›´æ–°å·²é€‰æ‹©é¢˜ç›®è®¡æ•°
function updateSelectedCount() {
    const count = selectedQuestions.size;
    const questionsUnit = window.i18n && window.i18n.initialized
        ? window.i18n.translate('manual.questions_unit', 'é¢˜')
        : 'é¢˜';
    
    // æ›´æ–°æ¨¡æ€çª—å£å†…çš„è®¡æ•°æ˜¾ç¤º
    const modalSelectedCountElements = document.querySelectorAll('#manualSelectedCount');
    modalSelectedCountElements.forEach(element => {
        element.textContent = `${count} ${questionsUnit}`;
        if (count > 0) {
            element.className = 'text-sm font-semibold text-green-600';
        } else {
            element.className = 'text-sm font-semibold text-gray-500';
        }
    });
    
    // æ›´æ–°ä¸»ç•Œé¢ä¸­çš„è®¡æ•°æ˜¾ç¤º
    const mainSelectedCount = document.querySelector('#manualMode .text-blue-600');
    if (mainSelectedCount && (mainSelectedCount.textContent.includes('é¢˜') || mainSelectedCount.textContent.includes('question'))) {
        mainSelectedCount.textContent = `${count} ${questionsUnit}`;
        if (count > 0) {
            mainSelectedCount.className = 'text-lg font-semibold text-blue-600';
        } else {
            mainSelectedCount.className = 'text-lg font-semibold text-gray-500';
        }
    }

    // åŒæ­¥æ›´æ–°é¢˜ç›®æ•°é‡è¾“å…¥æ¡†
    if (count > 0) {
        document.getElementById('configQuestions').value = count;
    }
}

// è·å–é¢˜ç›®ç±»å‹åç§°
function getTypeName(type) {
    if (window.i18n && window.i18n.initialized) {
        const typeTranslations = {
            'multiple_choice': window.i18n.translate('exam.config.type.multiple_choice', 'é€‰æ‹©é¢˜'),
            'short_answer': window.i18n.translate('exam.config.type.short_answer', 'ç®€ç­”é¢˜'),
            'programming': window.i18n.translate('exam.config.type.programming', 'ç¼–ç¨‹é¢˜'),
            'true_false': window.i18n.translate('exam.config.type.true_false', 'åˆ¤æ–­é¢˜'),
            'fill_blank': window.i18n.translate('exam.config.type.fill_blank', 'å¡«ç©ºé¢˜'),
            'essay': window.i18n.translate('exam.config.type.essay', 'è®ºè¿°é¢˜')
        };
        return typeTranslations[type] || type;
    } else {
        const names = {
            'multiple_choice': 'é€‰æ‹©é¢˜',
            'short_answer': 'ç®€ç­”é¢˜',
            'programming': 'ç¼–ç¨‹é¢˜',
            'true_false': 'åˆ¤æ–­é¢˜',
            'fill_blank': 'å¡«ç©ºé¢˜',
            'essay': 'è®ºè¿°é¢˜'
        };
        return names[type] || type;
    }
}

// é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
let timeout;
return function executedFunction(...args) {
    const later = () => {
        clearTimeout(timeout);
        func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
};
}

// å¤„ç†ä¿å­˜é…ç½®
async function handleSaveConfig(e) {
e.preventDefault();

const saveBtn = document.getElementById('saveBtn');
const originalText = saveBtn.innerHTML;
saveBtn.disabled = true;
saveBtn.innerHTML = '<i class="ri-loader-4-line animate-spin mr-2"></i>ä¿å­˜ä¸­...';

try {
const questionSelectionMode = document.getElementById('questionSelectionMode').value;

// éªŒè¯æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼ä¸‹æ˜¯å¦é€‰æ‹©äº†é¢˜ç›®
if (questionSelectionMode === 'manual' && selectedQuestions.size === 0) {
    console.log('æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼éªŒè¯å¤±è´¥:', {
        questionSelectionMode,
        selectedQuestionsSize: selectedQuestions.size,
        selectedQuestionsArray: Array.from(selectedQuestions)
    });
    showErrorMessage('æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼ä¸‹å¿…é¡»è‡³å°‘é€‰æ‹©ä¸€é“é¢˜ç›®ã€‚è¯·å…ˆä»è´­ç‰©è½¦ç¡®è®¤é€‰æ‹©é¢˜ç›®ã€‚');
    return;
}

// éªŒè¯ç²¾ç¡®æ•°é‡æ§åˆ¶é…ç½®
if (document.getElementById('enableQuantityControl').checked) {
    const totalConfigured = Object.values(quantityDistribution).reduce((sum, count) => sum + count, 0);
    const targetTotal = parseInt(document.getElementById('configQuestions').value);
    
    if (Object.keys(quantityDistribution).length === 0) {
        showErrorMessage('å¯ç”¨ç²¾ç¡®æ•°é‡æ§åˆ¶åå¿…é¡»æ·»åŠ è‡³å°‘ä¸€ä¸ªæ•°é‡é…ç½®');
        return;
    }
    
    if (totalConfigured !== targetTotal) {
        showErrorMessage(`ç²¾ç¡®æ•°é‡æ§åˆ¶é…ç½®æ€»æ•°ï¼ˆ${totalConfigured}é¢˜ï¼‰ä¸ç›®æ ‡æ€»æ•°ï¼ˆ${targetTotal}é¢˜ï¼‰ä¸åŒ¹é…ï¼Œè¯·è°ƒæ•´é…ç½®`);
        return;
    }
}

const subjects = Array.from(document.querySelectorAll('.subject-filter:checked')).map(cb => cb.value);
const difficulties = Array.from(document.querySelectorAll('.difficulty-filter:checked')).map(cb => cb.value);
const types = Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);

const configData = {
name: document.getElementById('configName').value,
description: document.getElementById('configDescription').value,
total_questions: parseInt(document.getElementById('configQuestions').value),
time_limit: parseInt(document.getElementById('configTimeLimit').value),
subject_filter: subjects.join(','),
difficulty_filter: difficulties.join(','),
type_filter: types.join(','),
is_default: document.getElementById('configIsDefault').checked,
is_active: document.getElementById('configIsActive').checked,
show_results: document.getElementById('configShowResults').checked,
question_selection_mode: questionSelectionMode,
passing_score: parseFloat(document.getElementById('configPassingScore').value) || 60.0,
enable_quantity_control: document.getElementById('enableQuantityControl').checked,
quantity_distribution: quantityDistribution
};

// å¦‚æœæ˜¯æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼ï¼Œæ·»åŠ é€‰ä¸­çš„é¢˜ç›®ID
if (questionSelectionMode === 'manual') {
    configData.question_ids = Array.from(selectedQuestions);
    console.log('æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼ä¿å­˜æ•°æ®:', {
        selectedQuestionsSize: selectedQuestions.size,
        questionIds: configData.question_ids,
        totalQuestions: configData.total_questions
    });
}

let response;
if (editingConfigId) {
response = await fetch(`/api/exam-configs/${editingConfigId}`, {
method: 'PUT',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(configData)
});
} else {
response = await fetch('/api/exam-configs', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(configData)
});
}

const result = await response.json();
if (result.success) {
showSuccess(editingConfigId ? 'é…ç½®æ›´æ–°æˆåŠŸï¼' : 'é…ç½®åˆ›å»ºæˆåŠŸï¼');
hideConfigModal();
loadConfigs(); // é‡æ–°åŠ è½½é…ç½®åˆ—è¡¨
} else {
showError('ä¿å­˜å¤±è´¥: ' + result.message);
}
} catch (error) {
console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
showError('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
} finally {
saveBtn.disabled = false;
saveBtn.innerHTML = originalText;
}
}

// åˆ é™¤é…ç½®
async function deleteConfig(configId) {
const config = currentConfigs.find(c => c.id === configId);
if (!config) return;

if (!confirm(`ç¡®å®šè¦åˆ é™¤é…ç½®"${config.name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
return;
}

try {
const response = await fetch(`/api/exam-configs/${configId}`, {
method: 'DELETE',
headers: { 'Content-Type': 'application/json' }
});

const result = await response.json();
if (result.success) {
showSuccess('é…ç½®åˆ é™¤æˆåŠŸï¼');
loadConfigs();
} else {
showError('åˆ é™¤å¤±è´¥: ' + result.message);
}
} catch (error) {
console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
showError('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
}
}

// å¤„ç†ç™»å‡º
function handleLogout() {
if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
fetch('/api/admin/logout', { method: 'POST' })
.then(() => {
window.location.href = '/admin/login';
})
.catch(() => {
window.location.href = '/admin/login';
});
}
}

// å·¥å…·å‡½æ•°
function formatDate(dateString) {
return new Date(dateString).toLocaleString('zh-CN');
}

// å°†éš¾åº¦ç­›é€‰å€¼è½¬æ¢ä¸ºç¾è§‚çš„æ ‡ç­¾æ˜¾ç¤º
function formatDifficultyFilter(difficultyFilter) {
if (!difficultyFilter) {
    return '<span class="text-gray-500">ä¸é™åˆ¶</span>';
}

const difficultyMap = {
    'high_school': { icon: 'ğŸ“', name: 'é«˜ä¸­æ°´å¹³', color: 'bg-blue-100 text-blue-800' },
    'undergraduate_basic': { icon: 'ğŸ“š', name: 'æœ¬ç§‘åŸºç¡€', color: 'bg-green-100 text-green-800' },
    'undergraduate_advanced': { icon: 'ğŸ¯', name: 'æœ¬ç§‘è¿›é˜¶', color: 'bg-purple-100 text-purple-800' },
    'graduate': { icon: 'ğŸ›ï¸', name: 'ç ”ç©¶ç”Ÿæ°´å¹³', color: 'bg-indigo-100 text-indigo-800' }
};

const difficulties = difficultyFilter.split(',').map(d => d.trim()).filter(d => d);

if (difficulties.length === 0) {
    return '<span class="text-gray-500">ä¸é™åˆ¶</span>';
}

const tags = difficulties.map(difficulty => {
    const info = difficultyMap[difficulty];
    if (!info) return null;
    return `<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ${info.color}">
        <span class="mr-1">${info.icon}</span>${info.name}
    </span>`;
}).filter(tag => tag);

return tags.length > 0 ? tags.join(' ') : '<span class="text-gray-500">ä¸é™åˆ¶</span>';
}

function showSuccess(message) {
showMessage(message, 'success');
}

function showError(message) {
showMessage(message, 'error');
}

function showMessage(message, type) {
const container = document.getElementById('messageContainer');
const messageId = 'msg-' + Date.now();

const messageDiv = document.createElement('div');
messageDiv.id = messageId;
messageDiv.className = `mb-4 p-4 rounded-lg shadow-lg transition-all duration-300 ${
type === 'success' 
? 'bg-green-100 border border-green-200 text-green-800' 
: 'bg-red-100 border border-red-200 text-red-800'
}`;

messageDiv.innerHTML = `
<div class="flex items-center">
<i class="ri-${type === 'success' ? 'check-circle' : 'error-warning'}-line mr-2"></i>
<span>${message}</span>
<button onclick="document.getElementById('${messageId}').remove()" class="ml-auto text-current opacity-70 hover:opacity-100">
<i class="ri-close-line"></i>
</button>
</div>
`;

container.appendChild(messageDiv);

// è‡ªåŠ¨åˆ é™¤æ¶ˆæ¯
setTimeout(() => {
const msg = document.getElementById(messageId);
if (msg) {
msg.style.opacity = '0';
msg.style.transform = 'translateX(100%)';
setTimeout(() => msg.remove(), 300);
}
}, 5000);
}

// ==================== ç²¾ç¡®æ•°é‡æ§åˆ¶åŠŸèƒ½ ====================

// åˆ‡æ¢ç²¾ç¡®æ•°é‡æ§åˆ¶
function toggleQuantityControl() {
    const isEnabled = document.getElementById('enableQuantityControl').checked;
    const statusSection = document.getElementById('quantityConfigStatus');
    
    if (isEnabled) {
        statusSection.classList.remove('hidden');
        updateQuantityConfigDisplay();
        updateTargetTotalCount();
        updateQuestionTypePreview();
    } else {
        statusSection.classList.add('hidden');
        quantityDistribution = {};
        updateQuantityConfigDisplay();
        updateQuestionTypePreview();
    }
}

// æ‰“å¼€ç²¾ç¡®æ•°é‡æ§åˆ¶æ¨¡æ€çª—å£
function openQuantityControlModal() {
    const modal = document.getElementById('quantityControlModal');
    modal.classList.remove('hidden');
    
    // åŒæ­¥ç›®æ ‡æ€»æ•°åˆ°æ¨¡æ€çª—å£
    updateModalTargetCount();
    updateQuantityConfigDisplay();
    
    // ç¡®ä¿æ¨¡æ€çª—å£æ‰“å¼€æ—¶æ›´æ–°ç¿»è¯‘
    setTimeout(() => {
        if (window.i18n && window.i18n.initialized) {
            // è§¦å‘ç¿»è¯‘æ›´æ–°
            const elements = modal.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (window.i18n.translations[window.i18n.currentLanguage] && 
                    window.i18n.translations[window.i18n.currentLanguage][key]) {
                    element.textContent = window.i18n.translations[window.i18n.currentLanguage][key];
                }
            });
        }
    }, 100);
}

// å…³é—­ç²¾ç¡®æ•°é‡æ§åˆ¶æ¨¡æ€çª—å£
function closeQuantityControlModal() {
    const modal = document.getElementById('quantityControlModal');
    modal.classList.add('hidden');
}

// ç¡®è®¤ç²¾ç¡®æ•°é‡æ§åˆ¶é…ç½®
function confirmQuantityControlConfig() {
    const totalConfigured = Object.values(quantityDistribution).reduce((sum, count) => sum + count, 0);
    const targetTotal = parseInt(document.getElementById('configQuestions').value) || 5;
    
    if (Object.keys(quantityDistribution).length === 0) {
        showErrorMessage(window.i18n ? window.i18n.translate('exam.config.no_config_error', 'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ•°é‡é…ç½®') : 'è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ•°é‡é…ç½®');
        return;
    }
    
    if (totalConfigured !== targetTotal) {
        showErrorMessage(window.i18n ? 
            window.i18n.translate('exam.config.total_mismatch_error', `é…ç½®æ€»æ•°ï¼ˆ${totalConfigured}é¢˜ï¼‰ä¸ç›®æ ‡æ€»æ•°ï¼ˆ${targetTotal}é¢˜ï¼‰ä¸åŒ¹é…`) : 
            `é…ç½®æ€»æ•°ï¼ˆ${totalConfigured}é¢˜ï¼‰ä¸ç›®æ ‡æ€»æ•°ï¼ˆ${targetTotal}é¢˜ï¼‰ä¸åŒ¹é…`);
        return;
    }
    
    // å¯ç”¨ç²¾ç¡®æ•°é‡æ§åˆ¶
    document.getElementById('enableQuantityControl').checked = true;
    toggleQuantityControl();
    
    // å…³é—­æ¨¡æ€çª—å£
    closeQuantityControlModal();
    
    showSuccessMessage(window.i18n ? 
        window.i18n.translate('exam.config.config_confirmed', `å·²ç¡®è®¤æ•°é‡é…ç½®ï¼Œå…±${Object.keys(quantityDistribution).length}ä¸ªç±»åˆ«ï¼Œ${totalConfigured}é¢˜`) : 
        `å·²ç¡®è®¤æ•°é‡é…ç½®ï¼Œå…±${Object.keys(quantityDistribution).length}ä¸ªç±»åˆ«ï¼Œ${totalConfigured}é¢˜`);
}

// æ›´æ–°æ¨¡æ€çª—å£ä¸­çš„ç›®æ ‡æ€»æ•°
function updateModalTargetCount() {
    const targetCount = parseInt(document.getElementById('configQuestions').value) || 5;
    const modalTargetElement = document.getElementById('modalTargetTotalCount');
    if (modalTargetElement) {
        const questionsUnit = window.i18n ? window.i18n.translate('exam.config.questions_unit', 'é¢˜') : 'é¢˜';
        modalTargetElement.innerHTML = `${targetCount} <span data-i18n="exam.config.questions_unit">${questionsUnit}</span>`;
    }
}

// æ›´æ–°é¢˜å‹é¢„è§ˆ
function updateQuestionTypePreview() {
    const previewContainer = document.getElementById('questionTypeBreakdown');
    if (!previewContainer) return;
    
    const isQuantityControlEnabled = document.getElementById('enableQuantityControl').checked;
    
    if (isQuantityControlEnabled && Object.keys(quantityDistribution).length > 0) {
        // ç²¾ç¡®æ•°é‡æ§åˆ¶æ¨¡å¼ - æ˜¾ç¤ºè¯¦ç»†é…ç½®
        const typeBreakdown = {};
        
        for (const [key, count] of Object.entries(quantityDistribution)) {
            const parts = key.split('-');
            if (parts.length === 3) {
                const [subject, difficulty, questionType] = parts;
                const typeKey = getQuestionTypeName(questionType);
                
                if (!typeBreakdown[typeKey]) {
                    typeBreakdown[typeKey] = 0;
                }
                typeBreakdown[typeKey] += count;
            }
        }
        
        let html = '';
        for (const [type, count] of Object.entries(typeBreakdown)) {
            const percentage = ((count / Object.values(quantityDistribution).reduce((a, b) => a + b, 0)) * 100).toFixed(1);
            html += `
                <div class="flex justify-between items-center">
                    <span>${type}:</span>
                    <span class="font-medium">${count}é¢˜ (${percentage}%)</span>
                </div>
            `;
        }
        
        previewContainer.innerHTML = html || '<div class="text-gray-500">æš‚æ— é…ç½®</div>';
    } else {
        // ä¼ ç»Ÿç­›é€‰æ¨¡å¼ - æ˜¾ç¤ºç­›é€‰æ¡ä»¶
        const selectedTypes = [];
        document.querySelectorAll('input[name="questionTypes"]:checked').forEach(checkbox => {
            selectedTypes.push(getQuestionTypeName(checkbox.value));
        });
        
        if (selectedTypes.length > 0) {
            const totalQuestions = parseInt(document.getElementById('configQuestions').value) || 5;
            const avgPerType = Math.ceil(totalQuestions / selectedTypes.length);
            
            let html = '';
            selectedTypes.forEach(type => {
                html += `
                    <div class="flex justify-between items-center">
                        <span>${type}:</span>
                        <span class="font-medium">çº¦${avgPerType}é¢˜</span>
                    </div>
                `;
            });
            
            previewContainer.innerHTML = html;
        } else {
            previewContainer.innerHTML = '<div class="text-gray-500">è¯·é€‰æ‹©é¢˜å‹</div>';
        }
    }
}

// è·å–é¢˜å‹ä¸­æ–‡åç§°
function getQuestionTypeName(type) {
    const typeNames = {
        'multiple_choice': 'é€‰æ‹©é¢˜',
        'short_answer': 'ç®€ç­”é¢˜', 
        'programming': 'ç¼–ç¨‹é¢˜',
        'true_false': 'åˆ¤æ–­é¢˜',
        'fill_blank': 'å¡«ç©ºé¢˜',
        'essay': 'è®ºè¿°é¢˜'
    };
    return typeNames[type] || type;
}

// æ·»åŠ æ•°é‡é…ç½®
function addQuantityConfig() {
    // è·å–å½“å‰é€‰ä¸­çš„ç­›é€‰æ¡ä»¶
    const selectedSubjects = Array.from(document.querySelectorAll('.subject-filter:checked')).map(cb => cb.value);
    const selectedDifficulties = Array.from(document.querySelectorAll('.difficulty-filter:checked')).map(cb => cb.value);
    const selectedTypes = Array.from(document.querySelectorAll('.type-filter:checked')).map(cb => cb.value);
    
    if (selectedSubjects.length === 0 || selectedDifficulties.length === 0 || selectedTypes.length === 0) {
        showErrorMessage('è¯·å…ˆé€‰æ‹©å­¦ç§‘ã€éš¾åº¦å’Œé¢˜å‹ç­›é€‰æ¡ä»¶');
        return;
    }
    
    // ç”Ÿæˆæ‰€æœ‰ç»„åˆ
    const combinations = [];
    selectedSubjects.forEach(subject => {
        selectedDifficulties.forEach(difficulty => {
            selectedTypes.forEach(type => {
                const key = `${subject}-${difficulty}-${type}`;
                if (!quantityDistribution[key]) {
                    combinations.push({ key, subject, difficulty, type });
                }
            });
        });
    });
    
    if (combinations.length === 0) {
        showErrorMessage('æ‰€é€‰æ¡ä»¶çš„ç»„åˆå·²ç»å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–æ¡ä»¶æˆ–ä¿®æ”¹ç°æœ‰é…ç½®');
        return;
    }
    
    // ä¸ºæ¯ä¸ªç»„åˆæ·»åŠ é…ç½®ï¼ˆé»˜è®¤1é¢˜ï¼‰
    combinations.forEach(combo => {
        quantityDistribution[combo.key] = 1;
    });
    
    updateQuantityConfigDisplay();
    showSuccessMessage(`å·²æ·»åŠ  ${combinations.length} ä¸ªæ•°é‡é…ç½®`);
}

// æ™ºèƒ½åˆ†é…æ•°é‡
function autoGenerateQuantityConfig() {
    const totalQuestions = parseInt(document.getElementById('configQuestions').value) || 5;
    const configCount = Object.keys(quantityDistribution).length;
    
    if (configCount === 0) {
        showErrorMessage('è¯·å…ˆæ·»åŠ æ•°é‡é…ç½®');
        return;
    }
    
    // å¹³å‡åˆ†é…ï¼Œä½™æ•°ç»™å‰å‡ ä¸ªé…ç½®
    const baseCount = Math.floor(totalQuestions / configCount);
    const remainder = totalQuestions % configCount;
    
    let index = 0;
    for (const key in quantityDistribution) {
        quantityDistribution[key] = baseCount + (index < remainder ? 1 : 0);
        index++;
    }
    
    updateQuantityConfigDisplay();
    showSuccessMessage(`å·²æ™ºèƒ½åˆ†é…æ€»è®¡ ${totalQuestions} é¢˜åˆ° ${configCount} ä¸ªé…ç½®`);
}

// æ¸…ç©ºæ•°é‡é…ç½®
function clearQuantityConfig() {
    if (Object.keys(quantityDistribution).length === 0) {
        showErrorMessage('æ²¡æœ‰é…ç½®éœ€è¦æ¸…ç©º');
        return;
    }
    
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°é‡é…ç½®å—ï¼Ÿ')) {
        quantityDistribution = {};
        updateQuantityConfigDisplay();
        showSuccessMessage('å·²æ¸…ç©ºæ‰€æœ‰æ•°é‡é…ç½®');
    }
}

// æ›´æ–°æ•°é‡é…ç½®æ˜¾ç¤º
function updateQuantityConfigDisplay() {
    const container = document.getElementById('quantityConfigList');
    const emptyState = document.getElementById('quantityConfigEmpty');
    const totalConfiguredElement = document.getElementById('totalConfiguredCount');
    const modalTotalConfiguredElement = document.getElementById('modalTotalConfiguredCount');
    const configuredCategoriesElement = document.getElementById('configuredCategoriesCount');
    const modalConfiguredCategoriesElement = document.getElementById('modalConfiguredCategoriesCount');
    
    let totalConfigured = 0;
    const categoryCount = Object.keys(quantityDistribution).length;
    const questionsUnit = window.i18n ? window.i18n.translate('exam.config.questions_unit', 'é¢˜') : 'é¢˜';
    
    // æ›´æ–°ç±»åˆ«è®¡æ•°
    if (configuredCategoriesElement) configuredCategoriesElement.textContent = categoryCount;
    if (modalConfiguredCategoriesElement) modalConfiguredCategoriesElement.textContent = categoryCount;
    
    if (categoryCount === 0) {
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        if (emptyState) emptyState.classList.remove('hidden');
        container.innerHTML = '';
    } else {
        // éšè—ç©ºçŠ¶æ€ï¼Œæ˜¾ç¤ºé…ç½®åˆ—è¡¨
        if (emptyState) emptyState.classList.add('hidden');
        
        container.innerHTML = '';
        Object.entries(quantityDistribution).forEach(([key, count]) => {
            const [subject, difficulty, type] = key.split('-');
            const configItem = document.createElement('div');
            configItem.className = 'flex items-center justify-between p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow';
            
            configItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-500 rounded-lg flex items-center justify-center">
                        <i class="ri-bookmark-line text-white text-sm"></i>
                    </div>
                    <div>
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-sm font-semibold text-gray-800">${subject}</span>
                            <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">${getDifficultyDisplayName(difficulty)}</span>
                            <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">${getTypeDisplayName(type)}</span>
                        </div>
                        <div class="text-xs text-gray-500">${key}</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2">
                        <input type="number" min="0" max="50" value="${count}" 
                               class="w-20 px-3 py-2 text-sm border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onchange="updateQuantityCount('${key}', this.value)"
                               placeholder="0">
                        <span class="text-sm text-gray-600">${questionsUnit}</span>
                    </div>
                    <button type="button" onclick="removeQuantityConfig('${key}')" 
                            class="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors"
                            title="${window.i18n ? window.i18n.translate('exam.config.remove_config', 'ç§»é™¤æ­¤é…ç½®') : 'ç§»é™¤æ­¤é…ç½®'}">
                        <i class="ri-delete-bin-line text-sm"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(configItem);
            totalConfigured += count;
        });
    }
    
    // æ›´æ–°æ€»æ•°æ˜¾ç¤º
    const totalText = `${totalConfigured} ${questionsUnit}`;
    if (totalConfiguredElement) {
        totalConfiguredElement.innerHTML = `${totalConfigured} <span data-i18n="exam.config.questions_unit">${questionsUnit}</span>`;
    }
    if (modalTotalConfiguredElement) {
        modalTotalConfiguredElement.innerHTML = `${totalConfigured} <span data-i18n="exam.config.questions_unit">${questionsUnit}</span>`;
    }
    
    // æ›´æ–°é…ç½®è®¡æ•°çš„é¢œè‰²
    const targetCount = parseInt(document.getElementById('configQuestions').value) || 5;
    let colorClass = 'font-semibold text-blue-600';
    if (totalConfigured === targetCount) {
        colorClass = 'font-semibold text-green-600';
    } else if (totalConfigured > targetCount) {
        colorClass = 'font-semibold text-red-600';
    }
    
    if (totalConfiguredElement) totalConfiguredElement.className = colorClass;
    if (modalTotalConfiguredElement) modalTotalConfiguredElement.className = `text-lg font-bold ${colorClass.replace('font-semibold', '')}`;
    
    // æ›´æ–°é¢˜å‹é¢„è§ˆ
    updateQuestionTypePreview();
}

// æ›´æ–°å•ä¸ªé…ç½®çš„æ•°é‡
function updateQuantityCount(key, newValue) {
    const count = parseInt(newValue) || 0;
    if (count <= 0) {
        delete quantityDistribution[key];
    } else {
        quantityDistribution[key] = count;
    }
    updateQuantityConfigDisplay();
}

// ç§»é™¤å•ä¸ªæ•°é‡é…ç½®
function removeQuantityConfig(key) {
    delete quantityDistribution[key];
    updateQuantityConfigDisplay();
}

// æ›´æ–°ç›®æ ‡æ€»æ•°æ˜¾ç¤º
function updateTargetTotalCount() {
    const targetCount = parseInt(document.getElementById('configQuestions').value) || 5;
    const questionsUnit = window.i18n ? window.i18n.translate('exam.config.questions_unit', 'é¢˜') : 'é¢˜';
    
    const targetElement = document.getElementById('targetTotalCount');
    if (targetElement) {
        targetElement.innerHTML = `${targetCount} <span data-i18n="exam.config.questions_unit">${questionsUnit}</span>`;
    }
    
    // åŒæ­¥æ›´æ–°æ¨¡æ€çª—å£ä¸­çš„ç›®æ ‡æ€»æ•°
    updateModalTargetCount();
    
    // åŒæ—¶æ›´æ–°å·²é…ç½®æ•°é‡çš„é¢œè‰²
    updateQuantityConfigDisplay();
}

// è·å–éš¾åº¦æ˜¾ç¤ºåç§°
function getDifficultyDisplayName(difficulty) {
    const difficultyMap = {
        'high_school': 'é«˜ä¸­æ°´å¹³',
        'undergraduate_basic': 'æœ¬ç§‘åŸºç¡€', 
        'undergraduate_advanced': 'æœ¬ç§‘è¿›é˜¶',
        'graduate': 'ç ”ç©¶ç”Ÿæ°´å¹³'
    };
    return difficultyMap[difficulty] || difficulty;
}

// è·å–é¢˜å‹æ˜¾ç¤ºåç§°  
function getTypeDisplayName(type) {
    const typeMap = {
        'multiple_choice': 'é€‰æ‹©é¢˜',
        'short_answer': 'ç®€ç­”é¢˜',
        'programming': 'ç¼–ç¨‹é¢˜',
        'true_false': 'åˆ¤æ–­é¢˜',
        'fill_blank': 'å¡«ç©ºé¢˜',
        'essay': 'è®ºè¿°é¢˜'
    };
    return typeMap[type] || type;
}
</script>
</body>
</html>
