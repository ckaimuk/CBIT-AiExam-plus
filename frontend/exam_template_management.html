<!DOCTYPE html>
<html lang="zh-CN" id="htmlRoot">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title data-i18n="exam.template.title">考试模板管理 - IMBA 智能考试系统</title>
<link rel="icon" type="image/x-icon" id="faviconLink" href="/favicon.ico">
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet">
<script src="/static/js/i18n.js"></script>
<script>
tailwind.config = {
theme: {
extend: {
colors: {
primary: '#1A237E',
secondary: '#3F51B5'
},
borderRadius: {
'none': '0px',
'sm': '4px',
DEFAULT: '8px',
'md': '12px',
'lg': '16px',
'xl': '20px',
'2xl': '24px',
'3xl': '32px',
'full': '9999px',
'button': '8px'
}
}
}
}
</script>
<style>
:where([class^="ri-"])::before {
content: "\f3c2";
}
.exam-bg {
background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
}
.card-hover {
transition: all 0.3s ease;
}
.card-hover:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}
</style>
</head>
<body class="exam-bg min-h-screen">
<div class="min-h-screen flex flex-col">
<!-- Header -->
<div class="bg-white shadow-sm border-b sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16">
<!-- Logo -->
<div class="flex items-center space-x-3">
<img src="https://static.readdy.ai/image/3c1ff9a008dc8b425236e4faed5d7924/c0ad19844b74c75ecb76a8cc5a6f9bd3.jfif" alt="IMBA Logo" class="w-8 h-8 object-contain">
<div class="font-bold text-lg text-primary" data-i18n="exam.template.title_short">IMBA 考试模板管理</div>
</div>
<!-- Navigation -->
<div class="flex items-center space-x-4">
<a href="/admin/dashboard" class="text-gray-600 hover:text-primary transition-colors">
<i class="ri-dashboard-line mr-1"></i><span data-i18n="nav.admin_panel">管理面板</span>
</a>
<a href="/question_management.html" class="text-gray-600 hover:text-primary transition-colors">
<i class="ri-database-line mr-1"></i><span data-i18n="question.management.title_short">题库管理</span>
</a>
<button id="languageToggle" class="px-3 py-1 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
<i class="ri-global-line mr-1"></i><span class="language-display">中</span>
</button>
<button id="logoutBtn" class="text-red-600 hover:text-red-800 transition-colors">
<i class="ri-logout-box-line mr-1"></i><span data-i18n="nav.logout">登出</span>
</button>
</div>
</div>
</div>
</div>

<!-- Main Content -->
<div class="flex-1 p-6">
<div class="max-w-7xl mx-auto">
<!-- Page Header -->
<div class="mb-8">
<h1 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="exam.template.title_short">考试模板管理</h1>
<p class="text-gray-600" data-i18n="exam.template.description">创建和管理考试模板，从题库中选择题目配置考试</p>
</div>

<!-- Action Bar -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
<!-- Search and Filters -->
<div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
<div class="flex space-x-2">
<input type="text" id="searchInput" data-i18n-placeholder="exam.template.search_placeholder" placeholder="搜索模板名称..." 
class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
<select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
<option value="" data-i18n="exam.template.all_status">所有状态</option>
<option value="active" data-i18n="exam.template.status.active">启用</option>
<option value="inactive" data-i18n="exam.template.status.inactive">禁用</option>
</select>
</div>
</div>
<!-- Action Buttons -->
<div class="flex space-x-2">
<button id="createTemplateBtn" class="bg-primary text-white px-4 py-2 !rounded-button hover:bg-opacity-90 transition-colors">
<i class="ri-add-line mr-2"></i><span data-i18n="exam.template.create_template">创建模板</span>
</button>
<button id="viewInstancesBtn" class="bg-green-600 text-white px-4 py-2 !rounded-button hover:bg-green-700 transition-colors">
<i class="ri-eye-line mr-2"></i><span data-i18n="exam.template.exam_instances">考试实例</span>
</button>
</div>
</div>
</div>

<!-- Templates Table -->
<div class="bg-white rounded-xl shadow-lg overflow-hidden">
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="exam.template.template_name">模板名称</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="exam.template.description_short">描述</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="exam.template.question_count">题目数量</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="exam.template.time_limit">时间限制</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="exam.template.passing_score">及格分数</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="exam.template.status">状态</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="exam.template.created_time">创建时间</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="exam.template.actions">操作</th>
</tr>
</thead>
<tbody id="templatesTableBody" class="bg-white divide-y divide-gray-200">
<!-- 模板列表将通过JavaScript动态加载 -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<!-- Create/Edit Template Modal -->
<div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
<div class="flex items-center justify-center min-h-screen p-4">
<div class="bg-white rounded-xl shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
<div class="p-6">
<div class="flex items-center justify-between mb-6">
<h3 id="modalTitle" class="text-xl font-semibold text-gray-900" data-i18n="exam.template.create_template">创建考试模板</h3>
<button id="closeModal" class="text-gray-400 hover:text-gray-600">
<i class="ri-close-line text-xl"></i>
</button>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<!-- 左侧：模板配置 -->
<div class="space-y-6">
<h4 class="text-lg font-medium text-gray-900">模板配置</h4>
<form id="templateForm" class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.template.template_name_required">模板名称 <span class="text-red-500">*</span></label>
<input type="text" id="templateName" name="name" required 
class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
placeholder="例如：数学基础测试">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.template.template_description">模板描述</label>
<textarea id="templateDescription" name="description" rows="3"
class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none resize-none"
data-i18n-placeholder="exam.template.description_placeholder" placeholder="描述这个考试模板的用途和特点..."></textarea>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.template.question_count_required">题目数量 <span class="text-red-500">*</span></label>
<input type="number" id="totalQuestions" name="total_questions" min="1" max="100" value="20" required
class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.template.time_limit_required">时间限制（分钟） <span class="text-red-500">*</span></label>
<input type="number" id="timeLimit" name="time_limit" min="10" max="300" value="75" required
class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
</div>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="exam.template.passing_score_required">及格分数 <span class="text-red-500">*</span></label>
<input type="number" id="passingScore" name="passing_score" min="0" max="100" value="60" step="0.1" required
class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
</div>
<div class="flex items-center">
<input type="checkbox" id="templateActive" name="is_active" checked 
class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
<label for="templateActive" class="ml-2 text-sm text-gray-700">启用模板</label>
</div>
</form>
</div>

<!-- 右侧：题目选择 -->
<div class="space-y-6">
<h4 class="text-lg font-medium text-gray-900">题目选择</h4>
<div class="bg-gray-50 rounded-lg p-4">
<!-- 筛选器 -->
<div class="space-y-4">
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">学科</label>
<select id="subjectFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
<option value="">所有学科</option>
<option value="数学">数学</option>
<option value="英语">英语</option>
<option value="计算机">计算机</option>
<option value="逻辑">逻辑</option>
<option value="统计学">统计学</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">难度</label>
<select id="difficultyFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
<option value="">所有难度</option>
<option value="简单">简单</option>
<option value="中等">中等</option>
<option value="困难">困难</option>
</select>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">语言</label>
<select id="languageFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
<option value="">所有语言</option>
<option value="zh">中文</option>
<option value="en">English</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-2">题型</label>
<select id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
<option value="">所有题型</option>
<option value="multiple_choice">选择题</option>
<option value="short_answer">简答题</option>
<option value="programming">编程题</option>
</select>
</div>
</div>
<div class="flex space-x-2">
<input type="text" id="questionSearch" placeholder="搜索题目内容..." 
class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none">
<button id="searchQuestions" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
<i class="ri-search-line"></i>
</button>
</div>
</div>

<!-- 题目列表 -->
<div class="mt-4">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center space-x-4">
<span class="text-sm text-gray-600">可选题目</span>
<button id="selectAllBtn" class="text-sm text-primary hover:text-primary-dark transition-colors">
<i class="ri-checkbox-line mr-1"></i>全选
</button>
<button id="clearAllBtn" class="text-sm text-gray-500 hover:text-gray-700 transition-colors">
<i class="ri-checkbox-blank-line mr-1"></i>清空
</button>
</div>
<span id="selectedCount" class="text-sm text-primary font-medium">已选择 0 题</span>
</div>
<div id="questionsList" class="max-h-64 overflow-y-auto space-y-2">
<!-- 题目列表将通过JavaScript动态加载 -->
</div>
</div>
</div>
</div>
</div>

<!-- Form Actions -->
<div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
<button type="button" id="cancelTemplate" class="px-6 py-2 border border-gray-300 text-gray-700 !rounded-button hover:bg-gray-50 transition-colors">
取消
</button>
<button type="button" id="saveTemplate" class="px-6 py-2 bg-primary text-white !rounded-button hover:bg-opacity-90 transition-colors">
保存模板
</button>
</div>
</div>
</div>
</div>
</div>

<script>
class ExamTemplateManager {
constructor() {
this.currentPage = 1;
this.perPage = 20;
this.editingTemplateId = null;
this.selectedQuestions = new Set();
this.availableQuestions = [];
this.init();
}

async init() {
// 等待i18n初始化完成
if (window.i18n && !window.i18n.initialized) {
await new Promise(resolve => {
document.addEventListener('i18n:initialized', resolve, { once: true });
});
}
this.setupEventListeners();
this.loadTemplates();
}

setupEventListeners() {
// 搜索和筛选
document.getElementById('searchInput').addEventListener('input', () => this.loadTemplates());
document.getElementById('statusFilter').addEventListener('change', () => this.loadTemplates());

// 按钮事件
document.getElementById('createTemplateBtn').addEventListener('click', () => this.showCreateModal());
document.getElementById('viewInstancesBtn').addEventListener('click', () => this.viewInstances());

// 模态框事件
document.getElementById('closeModal').addEventListener('click', () => this.hideModal());
document.getElementById('cancelTemplate').addEventListener('click', () => this.hideModal());

// 表单事件
document.getElementById('saveTemplate').addEventListener('click', () => this.saveTemplate());

// 题目筛选
document.getElementById('subjectFilter').addEventListener('change', () => this.loadQuestions());
document.getElementById('difficultyFilter').addEventListener('change', () => this.loadQuestions());
document.getElementById('languageFilter').addEventListener('change', () => this.loadQuestions());
document.getElementById('typeFilter').addEventListener('change', () => this.loadQuestions());
document.getElementById('searchQuestions').addEventListener('click', () => this.loadQuestions());
document.getElementById('questionSearch').addEventListener('input', () => {
// 实时搜索，延迟300ms执行
clearTimeout(this.searchTimeout);
this.searchTimeout = setTimeout(() => this.loadQuestions(), 300);
});

// 全选和清空按钮
document.getElementById('selectAllBtn').addEventListener('click', () => this.selectAllQuestions());
document.getElementById('clearAllBtn').addEventListener('click', () => this.clearAllQuestions());

// 登出
document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

// 键盘快捷键
document.addEventListener('keydown', (e) => {
// Ctrl+A 全选
if (e.ctrlKey && e.key === 'a' && document.getElementById('templateModal').classList.contains('hidden') === false) {
e.preventDefault();
this.selectAllQuestions();
}
// Escape 清空选择
if (e.key === 'Escape' && document.getElementById('templateModal').classList.contains('hidden') === false) {
this.clearAllQuestions();
}
});
}

async loadTemplates() {
try {
const params = new URLSearchParams({
page: this.currentPage,
per_page: this.perPage,
search: document.getElementById('searchInput').value,
status: document.getElementById('statusFilter').value
});

const response = await fetch(`/api/exam-templates?${params}`);
const result = await response.json();

if (result.success) {
this.renderTemplates(result.templates);
} else {
this.showError('加载模板失败: ' + result.message);
}
} catch (error) {
console.error('加载模板失败:', error);
this.showError('加载模板失败，请重试');
}
}

renderTemplates(templates) {
const tbody = document.getElementById('templatesTableBody');
tbody.innerHTML = '';

if (templates.length === 0) {
tbody.innerHTML = `
<tr>
<td colspan="8" class="px-6 py-12 text-center text-gray-500">
<i class="ri-file-list-line text-4xl mb-4 block"></i>
暂无模板数据
</td>
</tr>
`;
return;
}

templates.forEach(template => {
const row = document.createElement('tr');
row.innerHTML = `
<td class="px-6 py-4">
<div class="text-sm font-medium text-gray-900">${template.name}</div>
</td>
<td class="px-6 py-4">
<div class="text-sm text-gray-600 max-w-xs truncate">${template.description || '无描述'}</div>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${template.total_questions}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${template.time_limit} 分钟</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${template.passing_score}%</td>
<td class="px-6 py-4 whitespace-nowrap">
<span class="px-2 py-1 text-xs font-medium ${template.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} rounded-full">
${template.is_active ? '启用' : '禁用'}
</span>
</td>
<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${this.formatDate(template.created_at)}</td>
<td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
<div class="flex space-x-2">
<button onclick="templateManager.editTemplate(${template.id})" class="text-primary hover:text-primary-dark">
<i class="ri-edit-line"></i>
</button>
<button onclick="templateManager.deleteTemplate(${template.id})" class="text-red-600 hover:text-red-800">
<i class="ri-delete-bin-line"></i>
</button>
<button onclick="templateManager.createInstance(${template.id})" class="text-green-600 hover:text-green-800">
<i class="ri-play-line"></i>
</button>
</div>
</td>
`;
tbody.appendChild(row);
});
}

async loadQuestions() {
try {
// 显示加载状态
this.showLoadingState();

const params = new URLSearchParams({
subject: document.getElementById('subjectFilter').value,
difficulty: document.getElementById('difficultyFilter').value,
language: document.getElementById('languageFilter').value,
type: document.getElementById('typeFilter').value,
search: document.getElementById('questionSearch').value,
is_active: 'true'
});

const response = await fetch(`/api/questions?${params}`);
const result = await response.json();

if (result.success) {
this.availableQuestions = result.questions;
this.renderQuestions();
} else {
this.showError('加载题目失败: ' + result.message);
}
} catch (error) {
console.error('加载题目失败:', error);
this.showError('加载题目失败，请重试');
} finally {
this.hideLoadingState();
}
}

showLoadingState() {
const container = document.getElementById('questionsList');
container.innerHTML = `
<div class="text-center text-gray-500 py-8">
<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-3"></div>
<div class="text-sm">正在加载题目...</div>
</div>
`;
}

hideLoadingState() {
// 加载状态会在renderQuestions中被替换
}

renderQuestions() {
const container = document.getElementById('questionsList');
container.innerHTML = '';

if (this.availableQuestions.length === 0) {
container.innerHTML = `
<div class="text-center text-gray-500 py-8">
<i class="ri-question-line text-3xl mb-3 block"></i>
<div class="text-sm">暂无题目</div>
<div class="text-xs text-gray-400 mt-1">请调整筛选条件或添加新题目</div>
</div>
`;
return;
}

this.availableQuestions.forEach(question => {
const isSelected = this.selectedQuestions.has(question.id);
const questionDiv = document.createElement('div');
questionDiv.className = `group p-4 border rounded-lg cursor-pointer transition-all duration-200 ${
isSelected 
? 'border-primary bg-blue-50 shadow-sm' 
: 'border-gray-200 hover:border-gray-300 hover:shadow-sm'
}`;
questionDiv.onclick = (e) => {
// 如果点击的是复选框，不触发重复切换
if (e.target.type === 'checkbox') return;
templateManager.toggleQuestionSelection(question.id);
};
questionDiv.innerHTML = `
<div class="flex items-start space-x-3">
<div class="flex-shrink-0 mt-1">
<div class="relative">
<input type="checkbox" ${isSelected ? 'checked' : ''} 
onchange="templateManager.toggleQuestionSelection(${question.id})"
class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded transition-colors">
${isSelected ? `
<div class="absolute inset-0 flex items-center justify-center pointer-events-none">
<i class="ri-check-line text-white text-xs"></i>
</div>
` : ''}
</div>
</div>
<div class="flex-1 min-w-0">
<div class="text-sm font-medium text-gray-900 leading-relaxed mb-2">
${question.content.length > 100 ? question.content.substring(0, 100) + '...' : question.content}
${question.content.length > 100 ? `<button onclick="templateManager.showQuestionPreview(${question.id})" class="text-primary hover:text-primary-dark text-xs ml-2">查看完整</button>` : ''}
</div>
<div class="flex flex-wrap gap-2 mb-2">
<span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${question.subject}</span>
<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">${question.difficulty}</span>
<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">${this.getTypeName(question.type)}</span>
${question.language ? `<span class="px-2 py-1 text-xs font-medium ${question.language === 'en' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'} rounded-full">${question.language === 'en' ? 'English' : '中文'}</span>` : ''}
</div>
<div class="flex items-center justify-between text-xs text-gray-500">
<span>分值: ${question.points || 1}分</span>
${isSelected ? '<span class="text-primary font-medium"><i class="ri-check-line mr-1"></i>已选择</span>' : ''}
</div>
</div>
</div>
`;
container.appendChild(questionDiv);
});

// 更新全选按钮状态
this.updateSelectAllButton();
}

toggleQuestionSelection(questionId) {
if (this.selectedQuestions.has(questionId)) {
this.selectedQuestions.delete(questionId);
} else {
this.selectedQuestions.add(questionId);
}
this.updateSelectedCount();
this.renderQuestions();
}

selectAllQuestions() {
this.availableQuestions.forEach(question => {
this.selectedQuestions.add(question.id);
});
this.updateSelectedCount();
this.renderQuestions();
}

clearAllQuestions() {
this.selectedQuestions.clear();
this.updateSelectedCount();
this.renderQuestions();
}

updateSelectAllButton() {
const selectAllBtn = document.getElementById('selectAllBtn');
const clearAllBtn = document.getElementById('clearAllBtn');
const totalQuestions = this.availableQuestions.length;
const selectedCount = this.selectedQuestions.size;

if (selectedCount === 0) {
selectAllBtn.innerHTML = '<i class="ri-checkbox-line mr-1"></i>全选';
selectAllBtn.className = 'text-sm text-primary hover:text-primary-dark transition-colors';
} else if (selectedCount === totalQuestions) {
selectAllBtn.innerHTML = '<i class="ri-checkbox-blank-line mr-1"></i>取消全选';
selectAllBtn.className = 'text-sm text-gray-500 hover:text-gray-700 transition-colors';
} else {
selectAllBtn.innerHTML = '<i class="ri-checkbox-line mr-1"></i>全选';
selectAllBtn.className = 'text-sm text-primary hover:text-primary-dark transition-colors';
}

// 更新清空按钮状态
if (selectedCount > 0) {
clearAllBtn.className = 'text-sm text-red-500 hover:text-red-700 transition-colors';
} else {
clearAllBtn.className = 'text-sm text-gray-500 hover:text-gray-700 transition-colors';
}
}

updateSelectedCount() {
const count = this.selectedQuestions.size;
const selectedCountElement = document.getElementById('selectedCount');
selectedCountElement.textContent = `已选择 ${count} 题`;

// 添加选择提示
if (count > 0) {
selectedCountElement.className = 'text-sm text-primary font-medium';
} else {
selectedCountElement.className = 'text-sm text-gray-500 font-medium';
}
}

showCreateModal() {
this.editingTemplateId = null;
document.getElementById('modalTitle').textContent = '创建考试模板';
document.getElementById('templateForm').reset();
this.selectedQuestions.clear();
this.updateSelectedCount();
this.loadQuestions();
this.showModal();
}

showModal() {
document.getElementById('templateModal').classList.remove('hidden');
}

hideModal() {
document.getElementById('templateModal').classList.add('hidden');
}

async saveTemplate() {
try {
const formData = new FormData(document.getElementById('templateForm'));
const templateData = {
name: formData.get('name'),
description: formData.get('description'),
total_questions: parseInt(formData.get('total_questions')),
time_limit: parseInt(formData.get('time_limit')),
passing_score: parseFloat(formData.get('passing_score')),
is_active: formData.get('is_active') === 'on',
question_ids: Array.from(this.selectedQuestions)
};

if (templateData.question_ids.length === 0) {
this.showError('请至少选择一道题目');
return;
}

// 确认保存
if (!confirm(`确定要创建包含 ${templateData.question_ids.length} 道题目的考试模板吗？`)) {
return;
}

const url = this.editingTemplateId ? `/api/exam-templates/${this.editingTemplateId}` : '/api/exam-templates';
const method = this.editingTemplateId ? 'PUT' : 'POST';

const response = await fetch(url, {
method: method,
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(templateData)
});

const result = await response.json();
if (result.success) {
this.showSuccess(result.message);
this.hideModal();
this.loadTemplates();
} else {
this.showError('保存失败: ' + result.message);
}
} catch (error) {
console.error('保存模板失败:', error);
this.showError('保存失败，请重试');
}
}

getTypeName(type) {
const names = {
'multiple_choice': '选择题',
'short_answer': '简答题',
'programming': '编程题'
};
return names[type] || type;
}

formatDate(dateString) {
const date = new Date(dateString);
return date.toLocaleDateString('zh-CN');
}

showSuccess(message) {
alert('✅ ' + message);
}

showError(message) {
alert('❌ ' + message);
}

showQuestionPreview(questionId) {
const question = this.availableQuestions.find(q => q.id === questionId);
if (!question) return;

const preview = `
题目内容：
${question.content}

${question.options && question.options.length > 0 ? `
选项：
${question.options.map((option, index) => `${String.fromCharCode(65 + index)}. ${option}`).join('\n')}
` : ''}

${question.correct_answer ? `正确答案：${question.correct_answer}` : ''}

${question.explanation ? `解析：${question.explanation}` : ''}
`;

alert(preview);
}

async logout() {
try {
const response = await fetch('/api/admin/logout', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
}
});
const result = await response.json();
if (result.success) {
window.location.href = '/admin/login';
} else {
this.showError('登出失败: ' + result.message);
}
} catch (error) {
console.error('登出失败:', error);
this.showError('登出失败，请重试');
}
}
}

// 初始化模板管理器
const templateManager = new ExamTemplateManager();
</script>
</body>
</html>
