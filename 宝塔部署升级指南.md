# 🚀 宝塔面板部署升级指南 - CBIT智能考试系统

本指南专门针对宝塔面板环境的部署和升级，修复题目筛选功能。

## 📋 升级前准备

### 1. 系统要求
- 宝塔面板 7.0+
- Docker 和 Docker Compose 已安装
- 系统内存 >= 2GB
- 磁盘空间 >= 10GB

### 2. 检查现有部署
登录宝塔面板，检查：
- 📁 项目是否在 `/www/wwwroot/cbit-autoexam/`
- 🐳 Docker 容器是否正在运行
- 📊 当前数据库位置

## 🚀 快速升级方法

### 方法一：SSH终端升级（推荐）

1. **通过宝塔面板进入终端**
   ```bash
   # 进入项目目录
   cd /www/wwwroot/cbit-autoexam/
   
   # 查看当前状态
   git status
   docker ps
   ```

2. **拉取最新代码**
   ```bash
   # 备份本地修改（如果有）
   git stash
   
   # 拉取最新代码
   git pull origin main
   ```

3. **运行专用升级脚本**
   ```bash
   # 给脚本执行权限
   chmod +x upgrade_fix.sh
   
   # 运行升级脚本
   ./upgrade_fix.sh
   ```

### 方法二：使用宝塔文件管理器

如果SSH不可用，可以通过文件管理器：

1. **下载最新代码**
   - 在GitHub下载最新的代码ZIP包
   - 通过宝塔文件管理器上传并解压

2. **手动执行升级**
   ```bash
   # 在宝塔终端中执行
   cd /www/wwwroot/cbit-autoexam/
   chmod +x upgrade_fix.sh
   ./upgrade_fix.sh
   ```

## 🛠️ 宝塔专用配置

### 1. 使用宝塔专用compose文件

项目包含专门的宝塔配置文件：`docker-compose.bt.yml`

```yaml
# 宝塔专用配置特点：
- 端口映射：8080:8080
- 数据持久化：/srv/yourapp/data:/data
- 日志管理：限制大小和文件数
- 网络配置：专用网络
```

### 2. 创建宝塔站点（可选）

如果要通过域名访问：

1. **在宝塔面板创建站点**
   - 域名：`your-domain.com`
   - 根目录：`/www/wwwroot/cbit-autoexam/frontend`
   - PHP版本：无需PHP

2. **配置反向代理**
   - 目标URL：`http://127.0.0.1:8080`
   - 发送域名：`$host`
   - 启用缓存：否

## 📂 宝塔环境目录结构

升级后的标准目录结构：

```
/www/wwwroot/cbit-autoexam/           # 项目根目录
├── frontend/                        # 前端文件
├── backend/                         # 后端代码
├── database/                        # 数据库脚本
├── docker-compose.bt.yml            # 宝塔专用compose文件
├── upgrade_fix.sh                   # 升级脚本
└── 宝塔部署升级指南.md               # 本文档

/srv/yourapp/data/                   # 数据存储目录
├── app.db                          # 主数据库文件
├── app_backup_YYYYMMDD.db          # 自动备份
└── logs/                           # 日志文件

/www/wwwroot/cbit-autoexam/logs/     # 应用日志
├── access.log                      # 访问日志
├── error.log                       # 错误日志
└── nginx/                          # Nginx日志
```

## 🔧 宝塔面板特殊操作

### 1. 通过宝塔管理Docker

**查看容器状态**：
- 宝塔面板 → Docker管理器 → 容器列表
- 查找 `cbit-autoexam` 容器

**重启容器**：
```bash
# 在宝塔终端执行
cd /www/wwwroot/cbit-autoexam/
docker-compose -f docker-compose.bt.yml restart
```

**查看日志**：
```bash
# 容器日志
docker logs cbit-autoexam

# 应用日志
tail -f logs/error.log
```

### 2. 设置定时任务（可选）

在宝塔面板设置定时备份：

**数据库备份任务**：
```bash
# 任务类型：Shell脚本
# 执行周期：每天凌晨2点
# 脚本内容：
cp /srv/yourapp/data/app.db /srv/yourapp/data/backup/app_$(date +%Y%m%d).db
find /srv/yourapp/data/backup/ -name "app_*.db" -mtime +7 -delete
```

### 3. 防火墙配置

确保在宝塔面板开放端口：
- 端口：`8080`
- 类型：TCP
- 说明：CBIT智能考试系统

## 🚀 一键部署脚本（宝塔版）

创建宝塔一键部署脚本：

```bash
# 创建部署脚本
cat > /www/wwwroot/deploy_cbit.sh << 'EOF'
#!/bin/bash
echo "🚀 宝塔环境CBIT智能考试系统一键部署"

# 检查Docker
if ! command -v docker &> /dev/null; then
    echo "❌ Docker未安装，请先在宝塔面板安装Docker"
    exit 1
fi

# 创建项目目录
mkdir -p /www/wwwroot/cbit-autoexam
cd /www/wwwroot/cbit-autoexam

# 克隆代码
git clone https://github.com/reneverland/CBIT-AiExam-plus.git .

# 创建数据目录
mkdir -p /srv/yourapp/data
chmod -R 777 /srv/yourapp/data

# 运行升级脚本
chmod +x upgrade_fix.sh
./upgrade_fix.sh

echo "✅ 部署完成！"
echo "🌐 访问地址: http://$(curl -s ifconfig.me):8080"
echo "📱 管理后台: http://$(curl -s ifconfig.me):8080/admin/dashboard"
EOF

chmod +x /www/wwwroot/deploy_cbit.sh
```

## 🔍 验证部署结果

### 1. 检查服务状态

**在宝塔面板检查**：
- Docker管理器 → 容器列表 → `cbit-autoexam` 状态为运行中
- 进程管理 → 查看相关进程

**命令行检查**：
```bash
# 检查容器
docker ps | grep cbit

# 检查端口
netstat -tlnp | grep 8080

# 检查数据库
ls -la /srv/yourapp/data/
```

### 2. 测试访问

- 🌐 **主页**：`http://服务器IP:8080`
- 📋 **题库管理**：`http://服务器IP:8080/question_management.html`
- 🛠️ **管理后台**：`http://服务器IP:8080/admin/dashboard`

**默认管理员账号**：
- 用户名：`admin`
- 密码：`imbagogo`

### 3. 验证筛选功能

1. 进入题库管理页面
2. 测试各个筛选器：
   - ✅ 学科筛选：数学、计算机科学、统计学、工程学
   - ✅ 难度筛选：高中水平、本科基础、本科高级、研究生水平
   - ✅ 题型筛选：选择题、简答题、编程题
3. 验证组合筛选功能

## 🛠️ 故障排除

### 常见问题

#### 1. 容器启动失败
```bash
# 查看错误日志
docker logs cbit-autoexam

# 检查端口占用
netstat -tlnp | grep 8080

# 重新构建
cd /www/wwwroot/cbit-autoexam/
docker-compose -f docker-compose.bt.yml down
docker-compose -f docker-compose.bt.yml up -d --force-recreate
```

#### 2. 数据库连接失败
```bash
# 检查数据库文件
ls -la /srv/yourapp/data/app.db

# 修复权限
chmod 777 /srv/yourapp/data/app.db

# 重新运行修复脚本
python3 database/fix_filter_tags.py
```

#### 3. 筛选功能不工作
```bash
# 重新运行标签修复
cd /www/wwwroot/cbit-autoexam/
python3 database/fix_filter_tags.py

# 重启容器
docker-compose -f docker-compose.bt.yml restart
```

#### 4. 宝塔面板访问问题
- 检查防火墙是否开放8080端口
- 检查宝塔安全规则
- 确认服务器安全组配置

### 回滚方案

如果升级出现问题：

```bash
# 1. 停止服务
docker-compose -f docker-compose.bt.yml down

# 2. 恢复数据库
cp /srv/yourapp/data/app_backup_YYYYMMDD.db /srv/yourapp/data/app.db

# 3. 回滚代码
git checkout HEAD~1

# 4. 重启服务
docker-compose -f docker-compose.bt.yml up -d
```

## 📞 技术支持

### 宝塔面板相关问题
- 查看宝塔面板日志：面板设置 → 面板日志
- Docker问题：软件商店 → Docker管理器 → 设置
- 端口问题：安全 → 防火墙 → 添加端口规则

### 应用相关问题
- 应用日志：`/www/wwwroot/cbit-autoexam/logs/`
- 容器日志：`docker logs cbit-autoexam`
- 数据库检查：直接访问 `/srv/yourapp/data/app.db`

## ✅ 成功部署检查清单

升级完成后，确认以下项目：

- [ ] 宝塔面板能看到运行中的Docker容器
- [ ] 浏览器能正常访问 `http://IP:8080`
- [ ] 管理员能正常登录后台
- [ ] 题库管理页面的筛选功能正常
- [ ] 数据库文件位于 `/srv/yourapp/data/app.db`
- [ ] 防火墙已开放8080端口
- [ ] 所有题目数据完整保留

🎉 **恭喜！您的宝塔环境CBIT智能考试系统升级成功！**

## 🔗 相关链接

- 📊 **GitHub仓库**：https://github.com/reneverland/CBIT-AiExam-plus
- 📚 **通用升级指南**：`SERVER_UPGRADE_GUIDE.md`
- 🐳 **Docker配置**：`docker-compose.bt.yml`
- 🛠️ **升级脚本**：`upgrade_fix.sh`
